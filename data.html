<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="HORIZON - Fort Lewis College Institutional Research Dashboard. Interactive data visualization.">
  <title>Institutional Research & Data | HORIZON</title>
  <link rel="stylesheet" href="src/css/design-system.css">
  <style>
    /* Page Header */
    .page-header {
      background: var(--gradient-hero);
      color: var(--color-text-inverse);
      padding: var(--space-4) 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .page-header__inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .page-header__logo {
      font-size: 1.25rem;
      font-weight: 200;
      letter-spacing: 0.3em;
      color: var(--color-text-inverse);
      text-decoration: none;
    }

    .page-header__nav {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .page-header__link {
      color: rgba(255, 255, 255, 0.8);
      font-size: var(--text-body-sm);
      transition: color var(--duration-fast);
    }

    .page-header__link:hover {
      color: var(--color-accent);
    }

    /* Disclaimer Banner */
    .disclaimer-banner {
      background: rgba(255, 184, 28, 0.15);
      border: 1px solid rgba(255, 184, 28, 0.4);
      border-radius: var(--radius-lg);
      padding: var(--space-3) var(--space-4);
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      backdrop-filter: blur(10px);
    }

    .disclaimer-banner__icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .disclaimer-banner__content {
      flex: 1;
    }

    .disclaimer-banner__title {
      font-weight: 700;
      font-size: var(--text-body-sm);
      color: var(--color-accent);
      margin-bottom: 0.25rem;
    }

    .disclaimer-banner__text {
      font-size: var(--text-caption);
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.5;
    }

    /* ===== PERSISTENT MOUNTAIN BACKGROUND ===== */
    .data-page-background {
      position: fixed;
      inset: 0;
      z-index: -2;
      background: url('https://images.unsplash.com/photo-1491002052546-bf38f186af56?w=1920&q=80&auto=format&fit=crop') center/cover no-repeat;
      background-attachment: fixed;
      transition: opacity 0.5s ease;
    }

    /* Dark mode: fade the mountain, show stars */
    [data-theme="dark"] .data-page-background {
      opacity: 0.3;
    }

    /* ===== STARFIELD (Dark Mode) ===== */
    .data-stars {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    [data-theme="dark"] .data-stars {
      opacity: 1;
    }

    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: twinkle var(--duration, 3s) ease-in-out infinite;
      animation-delay: var(--delay, 0s);
    }

    .star--large {
      width: 3px;
      height: 3px;
      box-shadow: 0 0 6px 1px rgba(255, 255, 255, 0.5);
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .shooting-star {
      position: absolute;
      width: 100px;
      height: 2px;
      background: linear-gradient(90deg, white, transparent);
      opacity: 0;
      animation: shoot 6s ease-in-out infinite;
      animation-delay: var(--delay, 2s);
    }

    @keyframes shoot {
      0% { opacity: 0; transform: translateX(0) translateY(0); }
      5% { opacity: 1; }
      15% { opacity: 0; transform: translateX(300px) translateY(150px); }
      100% { opacity: 0; }
    }

    /* ===== SNOW PARTICLES (Light Mode) ===== */
    .data-snow {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      overflow: hidden;
    }

    [data-theme="dark"] .data-snow {
      opacity: 0.3;
    }

    .snowflake {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: snowfall linear infinite;
    }

    @keyframes snowfall {
      0% { transform: translateY(-10px) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(100vh) translateX(20px); opacity: 0; }
    }

    /* ===== SUN FOR DAYTIME (Light Mode) ===== */
    .data-sun {
      position: absolute;
      top: 15%;
      right: 10%;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, #fff9c4 0%, #ffeb3b 30%, #ffc107 60%, transparent 70%);
      border-radius: 50%;
      z-index: 2;
      pointer-events: none;
      box-shadow:
        0 0 40px 20px rgba(255, 235, 59, 0.4),
        0 0 80px 40px rgba(255, 193, 7, 0.2);
      animation: sunGlow 4s ease-in-out infinite;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    @keyframes sunGlow {
      0%, 100% { box-shadow: 0 0 40px 20px rgba(255, 235, 59, 0.4), 0 0 80px 40px rgba(255, 193, 7, 0.2); }
      50% { box-shadow: 0 0 60px 30px rgba(255, 235, 59, 0.5), 0 0 100px 50px rgba(255, 193, 7, 0.25); }
    }

    [data-theme="dark"] .data-sun {
      opacity: 0;
    }

    /* Snow: Lighter in day, heavier at night */
    .data-snow {
      opacity: 0.4;
    }

    [data-theme="dark"] .data-snow {
      opacity: 1;
    }

    [data-theme="dark"] .snowflake {
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.8);
    }

    /* ===== Hero Section with Matrix Rain ===== */
    .ir-hero {
      background: linear-gradient(135deg, #003366 0%, #001a33 50%, #002244 100%);
      color: var(--color-text-inverse);
      padding: var(--space-8) 0 var(--space-10);
      position: relative;
      overflow: hidden;
    }

    /* Matrix Rain Container */
    .matrix-rain {
      position: absolute;
      inset: 0;
      overflow: hidden;
      z-index: 1;
      pointer-events: none;
    }

    .matrix-drop {
      position: absolute;
      width: 2px;
      background: linear-gradient(180deg, transparent 0%, #FFB81C 50%, transparent 100%);
      border-radius: 2px;
      animation: matrix-fall linear infinite;
      box-shadow: 0 0 8px rgba(255, 184, 28, 0.6);
    }

    /* Enhanced glow in dark mode */
    [data-theme="dark"] .matrix-drop {
      box-shadow: 0 0 12px rgba(255, 184, 28, 0.8), 0 0 24px rgba(255, 184, 28, 0.4);
    }

    @keyframes matrix-fall {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(calc(100vh + 100%)); }
    }

    .ir-hero__content {
      position: relative;
      z-index: 2;
    }

    .ir-hero__badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      background: rgba(255, 184, 28, 0.2);
      border: 1px solid rgba(255, 184, 28, 0.4);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      font-size: var(--text-caption);
      font-weight: 600;
      color: var(--color-accent);
      margin-bottom: var(--space-3);
    }

    .ir-hero__title {
      font-size: var(--text-h1);
      margin-bottom: var(--space-2);
    }

    .ir-hero__subtitle {
      font-size: var(--text-body);
      opacity: 0.9;
      max-width: 600px;
      margin-bottom: var(--space-6);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
      margin-top: calc(-1 * var(--space-6));
      position: relative;
      z-index: 2;
    }

    @media (min-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .stat-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      box-shadow: var(--shadow-xl);
      text-align: center;
      border: 1px solid var(--color-border);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 51, 102, 0.15);
    }

    [data-theme="dark"] .stat-card:hover {
      box-shadow: 0 20px 40px rgba(255, 184, 28, 0.1);
    }

    .stat-card__value {
      font-size: clamp(2rem, 5vw, 2.5rem);
      font-weight: 700;
      color: var(--color-primary);
      line-height: 1;
      margin-bottom: var(--space-1);
    }

    .stat-card__label {
      font-size: var(--text-caption);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }

    .stat-card__trend {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: var(--text-caption);
      font-weight: 600;
    }

    .stat-card__trend--up {
      color: var(--color-success);
    }

    .stat-card__trend--down {
      color: var(--color-error);
    }

    /* ===== SEMI-TRANSPARENT CONTENT SECTIONS ===== */
    .ir-content-section {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    [data-theme="dark"] .ir-content-section {
      background: rgba(13, 17, 23, 0.88);
    }

    /* Dashboard Section */
    .dashboard {
      padding: var(--space-8) 0;
    }

    .dashboard__header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    .dashboard__title {
      font-size: var(--text-h2);
      color: var(--color-primary);
    }

    .dashboard__controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .control-btn {
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      font-size: var(--text-caption);
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .control-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .control-btn.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: var(--color-text-inverse);
    }

    /* Chart Container */
    .chart-container {
      background: var(--color-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-6);
      border: 1px solid var(--color-border);
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }

    .chart-title {
      font-size: var(--text-h3);
      color: var(--color-primary);
    }

    .chart-legend {
      display: flex;
      gap: var(--space-3);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--text-caption);
      color: var(--color-text-secondary);
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    /* SVG Chart Styles */
    .chart-svg {
      width: 100%;
      height: 300px;
    }

    .chart-line {
      fill: none;
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .chart-line--total {
      stroke: var(--color-primary);
    }

    .chart-line--male {
      stroke: #3B82F6;
    }

    .chart-line--female {
      stroke: #EC4899;
    }

    .chart-area {
      opacity: 0.1;
    }

    .chart-area--total {
      fill: var(--color-primary);
    }

    .chart-point {
      fill: var(--color-surface);
      stroke-width: 3;
      cursor: pointer;
      transition: r 0.2s ease;
    }

    .chart-point:hover {
      r: 8;
    }

    .chart-point--total {
      stroke: var(--color-primary);
    }

    .chart-point--male {
      stroke: #3B82F6;
    }

    .chart-point--female {
      stroke: #EC4899;
    }

    /* Full-Time / Part-Time chart styles */
    .chart-line--fulltime {
      stroke: #2563EB;
    }

    .chart-line--parttime {
      stroke: #10B981;
    }

    .chart-area--fulltime {
      fill: #2563EB;
    }

    .chart-area--parttime {
      fill: #10B981;
    }

    .chart-point--fulltime {
      stroke: #2563EB;
    }

    .chart-point--parttime {
      stroke: #10B981;
    }

    .chart-grid-line {
      stroke: var(--color-border);
      stroke-dasharray: 4, 4;
    }

    .chart-axis-label {
      fill: var(--color-text-secondary);
      font-size: 11px;
    }

    .chart-tooltip {
      position: absolute;
      background: var(--color-bg-dark);
      color: var(--color-text-inverse);
      padding: var(--space-2);
      border-radius: var(--radius-md);
      font-size: var(--text-caption);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 100;
    }

    .chart-tooltip.visible {
      opacity: 1;
    }

    /* Demographics Section */
    .demographics-grid {
      display: grid;
      gap: var(--space-4);
    }

    @media (min-width: 768px) {
      .demographics-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .donut-chart-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .donut-svg {
      width: 250px;
      height: 250px;
    }

    .donut-segment {
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
      transform-origin: center;
    }

    .donut-segment:hover {
      opacity: 0.8;
    }

    .donut-center-text {
      font-size: 24px;
      font-weight: 700;
      fill: var(--color-primary);
    }

    .donut-center-label {
      font-size: 12px;
      fill: var(--color-text-secondary);
    }

    .demographics-legend {
      display: grid;
      gap: var(--space-2);
      margin-top: var(--space-3);
    }

    .demo-legend-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.2s;
    }

    .demo-legend-item:hover {
      background: var(--color-bg-light);
    }

    .demo-legend-left {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .demo-legend-color {
      width: 16px;
      height: 16px;
      border-radius: var(--radius-sm);
    }

    .demo-legend-label {
      font-size: var(--text-body-sm);
      color: var(--color-text-primary);
    }

    .demo-legend-value {
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .demo-legend-percent {
      font-size: var(--text-caption);
      color: var(--color-text-secondary);
      margin-left: var(--space-1);
    }

    /* Data Table */
    .data-table-container {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--text-body-sm);
    }

    .data-table th,
    .data-table td {
      padding: var(--space-2) var(--space-3);
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    .data-table th {
      background: var(--color-bg-light);
      font-weight: 600;
      color: var(--color-text-primary);
      white-space: nowrap;
    }

    .data-table tr:hover {
      background: var(--color-bg-light);
    }

    .data-table td {
      color: var(--color-text-primary);
    }

    /* Key Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
      margin-top: var(--space-4);
    }

    @media (min-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .metric-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      border: 1px solid var(--color-border);
      text-align: center;
    }

    .metric-card__icon {
      font-size: 2rem;
      margin-bottom: var(--space-2);
    }

    .metric-card__value {
      font-size: var(--text-h2);
      font-weight: 700;
      color: var(--color-primary);
    }

    .metric-card__label {
      font-size: var(--text-caption);
      color: var(--color-text-secondary);
    }

    /* Footer */
    .page-footer {
      background: var(--color-bg-dark);
      color: var(--color-text-inverse);
      padding: var(--space-6) 0;
      text-align: center;
    }

    .page-footer__logo {
      font-size: 1.25rem;
      font-weight: 200;
      letter-spacing: 0.3em;
      margin-bottom: var(--space-2);
    }

    .page-footer__text {
      font-size: var(--text-caption);
      opacity: 0.7;
    }

    .page-footer__disclaimer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-1);
      margin-top: var(--space-3);
      font-size: var(--text-caption);
      opacity: 0.5;
    }

    /* Data Source Badge */
    .data-source {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      background: var(--color-bg-light);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      font-size: var(--text-caption);
      color: var(--color-text-secondary);
      margin-top: var(--space-4);
    }

    .data-source__icon {
      font-size: 1rem;
    }

    /* Dark Mode */
    [data-theme="dark"] .stat-card,
    [data-theme="dark"] .chart-container,
    [data-theme="dark"] .metric-card {
      background: var(--color-surface);
      border-color: var(--color-border);
    }

    [data-theme="dark"] .stat-card__value,
    [data-theme="dark"] .chart-title,
    [data-theme="dark"] .dashboard__title,
    [data-theme="dark"] .metric-card__value {
      color: var(--color-text-primary);
    }

    [data-theme="dark"] .ir-hero {
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0d1117 100%);
    }

    /* Dark Mode - Export Report */
    [data-theme="dark"] .report-chart,
    [data-theme="dark"] .report-table {
      background: var(--color-surface);
      border-color: var(--color-border);
    }

    [data-theme="dark"] .report-table th {
      background: rgba(255, 255, 255, 0.05);
    }

    [data-theme="dark"] .report-demo-banner {
      background: linear-gradient(135deg, #422006 0%, #713f12 100%);
      border-color: #92400E;
    }

    [data-theme="dark"] .report-demo-banner__title {
      color: #FBBF24;
    }

    [data-theme="dark"] .report-demo-banner__desc {
      color: #FCD34D;
    }

    /* Theme Toggle in Header */
    .theme-toggle {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--color-text-inverse);
      font-size: 1rem;
      transition: all var(--duration-fast);
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Animation */
    .fade-in {
      animation: fadeIn 0.6s ease forwards;
    }

    .fade-in-up {
      animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes drawLine {
      to {
        stroke-dashoffset: 0;
      }
    }

    /* ===== TABBED INTERFACE ===== */
    .ir-tabs {
      display: flex;
      gap: var(--space-1);
      border-bottom: 2px solid var(--color-border);
      margin-bottom: var(--space-6);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .ir-tab {
      padding: var(--space-3) var(--space-4);
      background: none;
      border: none;
      font-size: var(--text-body-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      transition: color var(--duration-fast);
    }

    .ir-tab:hover {
      color: var(--color-primary);
    }

    .ir-tab.active {
      color: var(--color-primary);
    }

    .ir-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--color-primary);
      border-radius: 2px 2px 0 0;
    }

    .ir-tab-content {
      display: none;
    }

    .ir-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* ===== DATA EXPLORER ===== */
    .explorer {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: var(--space-4);
      min-height: 600px;
    }

    @media (max-width: 1024px) {
      .explorer {
        grid-template-columns: 1fr;
      }
    }

    /* Mobile-friendly Data Explorer */
    @media (max-width: 768px) {
      /* Fix header blocking hero buttons */
      .ir-hero {
        padding-top: calc(var(--space-8) + 20px);
      }

      .explorer {
        min-height: auto;
        gap: var(--space-3);
      }

      .field-panel {
        padding: var(--space-3);
      }

      .field-panel__section {
        margin-bottom: var(--space-3);
      }

      /* Make fields tappable instead of draggable on mobile */
      .field {
        cursor: pointer;
        padding: var(--space-3);
        font-size: var(--text-body-sm);
      }

      .field.selected {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
      }

      .drop-zones--three {
        grid-template-columns: 1fr;
        gap: var(--space-2);
      }

      .drop-zone {
        min-height: 70px;
        padding: var(--space-3);
      }

      .drop-zone__label {
        font-size: 11px;
      }

      .chart-type-selector {
        flex-wrap: wrap;
      }

      .chart-preview {
        min-height: 300px;
        padding: var(--space-3);
      }

      .explorer-chart-svg {
        height: 250px;
      }

      .chart-preview__empty-icon {
        font-size: 2.5rem;
      }

      .chart-preview__empty-text {
        font-size: var(--text-body-sm);
      }

      .chart-preview__empty-hint {
        font-size: 11px;
      }

      /* Show mobile hint on mobile only */
      .mobile-explorer-hint {
        display: block !important;
      }
    }

    /* Field Panel */
    .field-panel {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      height: fit-content;
    }

    .field-panel__section {
      margin-bottom: var(--space-4);
    }

    .field-panel__title {
      font-size: var(--text-overline);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }

    .field {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      margin-bottom: 6px;
      cursor: grab;
      transition: all 0.15s ease;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .field:hover {
      border-color: var(--color-primary);
      background: var(--color-surface);
      box-shadow: 0 2px 8px rgba(0, 51, 102, 0.12);
      transform: translateY(-1px);
    }

    .field:active {
      cursor: grabbing;
      transform: scale(0.98);
    }

    .field.dragging {
      opacity: 0.5;
      transform: scale(0.95);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .field.selected {
      border-color: var(--color-primary);
      background: rgba(0, 51, 102, 0.08);
      box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
    }

    .field__icon {
      font-size: 1rem;
      opacity: 0.8;
    }

    .field--dimension {
      border-left: 3px solid #3B82F6;
    }

    .field--dimension:hover {
      border-left-color: #2563EB;
    }

    .field--measure {
      border-left: 3px solid #10B981;
    }

    .field--measure:hover {
      border-left-color: #059669;
    }

    .field--demographic {
      border-left: 3px solid #8B5CF6;
    }

    .field--demographic:hover {
      border-left-color: #7C3AED;
    }

    /* Drop Zones */
    .explorer__workspace {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .drop-zones {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-3);
    }

    .drop-zones--three {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .drop-zones--four {
      grid-template-columns: 1fr 1fr 1fr 1fr;
    }

    @media (max-width: 1100px) {
      .drop-zones--four {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 900px) {
      .drop-zones--three {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .drop-zones,
      .drop-zones--three,
      .drop-zones--four {
        grid-template-columns: 1fr;
      }
    }

    .drop-zone {
      background: var(--color-surface);
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
      min-height: 90px;
      transition: all 0.2s ease;
      position: relative;
    }

    .drop-zone::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      opacity: 0.8;
    }

    .drop-zone--measures {
      border-color: rgba(16, 185, 129, 0.4);
      background: rgba(16, 185, 129, 0.02);
    }

    .drop-zone--measures::before {
      background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
    }

    .drop-zone--group {
      border-color: rgba(139, 92, 246, 0.4);
      background: rgba(139, 92, 246, 0.02);
    }

    .drop-zone--group::before {
      background: linear-gradient(90deg, #8B5CF6 0%, #A78BFA 100%);
    }

    .drop-zone--filter {
      border-color: rgba(245, 158, 11, 0.4);
      background: rgba(245, 158, 11, 0.02);
    }

    .drop-zone--filter::before {
      background: linear-gradient(90deg, #F59E0B 0%, #FBBF24 100%);
    }

    .drop-zone:not(.drop-zone--measures):not(.drop-zone--group):not(.drop-zone--filter)::before {
      background: linear-gradient(90deg, #3B82F6 0%, #60A5FA 100%);
    }

    .drop-zone.drag-over {
      border-style: solid;
      border-color: var(--color-primary);
      background: rgba(0, 51, 102, 0.06);
      transform: scale(1.01);
      box-shadow: 0 4px 20px rgba(0, 51, 102, 0.12);
    }

    .drop-zone--measures.drag-over {
      border-color: #10B981;
      background: rgba(16, 185, 129, 0.08);
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.15);
    }

    .drop-zone--group.drag-over {
      border-color: #8B5CF6;
      background: rgba(139, 92, 246, 0.08);
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.15);
    }

    .drop-zone--filter.drag-over {
      border-color: #F59E0B;
      background: rgba(245, 158, 11, 0.08);
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.15);
    }

    /* Filter Popup */
    .filter-popup {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      min-width: 280px;
      margin-top: var(--space-2);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      box-shadow: var(--shadow-xl);
      z-index: 100;
      animation: filterPopupIn 0.2s ease-out;
    }

    @keyframes filterPopupIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .filter-popup.active {
      display: block;
    }

    .filter-popup__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--color-border);
    }

    .filter-popup__title {
      font-size: var(--text-body-sm);
      font-weight: 600;
      color: var(--color-text);
    }

    .filter-popup__close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 0;
      line-height: 1;
    }

    .filter-popup__close:hover {
      color: var(--color-text);
    }

    /* Checkbox filter options */
    .filter-options {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      max-height: 200px;
      overflow-y: auto;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      cursor: pointer;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      transition: background var(--duration-fast);
    }

    .filter-option:hover {
      background: var(--color-bg-light);
    }

    .filter-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--color-primary);
      cursor: pointer;
    }

    .filter-option__label {
      font-size: var(--text-body-sm);
      color: var(--color-text);
    }

    .filter-option__color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Range slider for Year */
    .filter-slider {
      padding: var(--space-2) 0;
    }

    .filter-slider__inputs {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    .filter-slider__input-group {
      flex: 1;
      min-width: 0;
    }

    .filter-slider__input-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }

    .filter-slider__select {
      width: 100%;
      min-width: 100px;
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      color: var(--color-text);
      font-size: var(--text-body);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M3 4.5L6 7.5L9 4.5'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }

    .filter-slider__select:hover {
      border-color: var(--color-primary);
    }

    .filter-slider__select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
    }

    .filter-slider__arrow {
      font-size: 1.25rem;
      color: var(--color-text-secondary);
      flex-shrink: 0;
    }

    .filter-popup__actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-3);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-border);
    }

    .filter-popup__btn {
      flex: 1;
      padding: var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-caption);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .filter-popup__btn--apply {
      background: var(--color-primary);
      color: white;
      border: none;
    }

    .filter-popup__btn--apply:hover {
      background: var(--color-primary-dark);
    }

    .filter-popup__btn--clear {
      background: none;
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
    }

    .filter-popup__btn--clear:hover {
      background: var(--color-bg-light);
      color: var(--color-text);
    }

    /* Active filter indicator */
    .filter-active-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      background: rgba(255, 255, 255, 0.25);
      color: white;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 600;
      margin-left: var(--space-1);
    }

    .drop-zone--filter {
      position: relative;
    }

    .drop-zone__label {
      font-size: var(--text-caption);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }

    .drop-zone__content {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
      min-height: 32px;
    }

    .drop-zone__placeholder {
      color: var(--color-text-secondary);
      font-size: var(--text-caption);
      font-style: italic;
    }

    .dropped-field {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: linear-gradient(135deg, var(--color-primary) 0%, #004080 100%);
      color: white;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 51, 102, 0.2);
      transition: all var(--duration-fast);
    }

    .dropped-field:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 51, 102, 0.25);
    }

    /* Clickable filter field */
    .dropped-field--filter {
      cursor: pointer;
      padding-right: 6px;
    }

    .dropped-field--filter:hover {
      background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
    }

    .dropped-field__edit {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      font-size: 10px;
      margin-left: 2px;
    }

    .dropped-field__remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      line-height: 1;
      transition: all var(--duration-fast);
    }

    .dropped-field__remove:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Chart Type Selector */
    .chart-type-selector {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--color-bg-light);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      width: fit-content;
    }

    .chart-type-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 36px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 1.25rem;
      transition: all 0.15s ease;
      color: var(--color-text-secondary);
    }

    .chart-type-btn:hover {
      background: var(--color-surface);
      color: var(--color-primary);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .chart-type-btn.active {
      background: var(--color-primary);
      color: white;
      box-shadow: 0 2px 4px rgba(0, 51, 102, 0.2);
    }

    /* Control bar styling */
    .explorer__controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-2);
      padding: var(--space-2) 0;
    }

    .explorer__actions {
      display: flex;
      gap: var(--space-2);
    }

    /* Chart Preview */
    .chart-preview {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .chart-preview__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    .chart-preview__title {
      font-size: var(--text-h3);
      color: var(--color-primary);
    }

    .chart-preview__actions {
      display: flex;
      gap: var(--space-2);
    }

    .chart-preview__content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chart-preview__empty {
      text-align: center;
      color: var(--color-text-secondary);
    }

    .chart-preview__empty-icon {
      font-size: 4rem;
      opacity: 0.3;
      margin-bottom: var(--space-2);
    }

    .chart-preview__empty-text {
      font-size: var(--text-body);
    }

    .chart-preview__empty-hint {
      font-size: var(--text-caption);
      margin-top: var(--space-1);
    }

    /* Reset & Export Buttons */
    .explorer__reset,
    .explorer__export {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .explorer__reset:hover {
      border-color: var(--color-error);
      color: var(--color-error);
      background: rgba(220, 38, 38, 0.05);
    }

    .explorer__export {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }

    .explorer__export:hover {
      background: #004080;
      border-color: #004080;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 51, 102, 0.2);
    }

    /* Export Report Preview Modal */
    .export-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      padding: var(--space-4);
    }

    .export-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .export-modal__content {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .export-modal.active .export-modal__content {
      transform: scale(1) translateY(0);
    }

    /* Report Header */
    .report-header {
      background: linear-gradient(135deg, var(--color-primary) 0%, #004080 100%);
      color: white;
      padding: var(--space-4) var(--space-5);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      position: relative;
    }

    .report-header__left {
      flex: 1;
    }

    .report-header__logo {
      font-size: 12px;
      font-weight: 200;
      letter-spacing: 0.2em;
      opacity: 0.8;
      margin-bottom: var(--space-1);
    }

    .report-header__title {
      font-size: var(--text-h3);
      font-weight: 700;
      margin-bottom: var(--space-1);
    }

    .report-header__subtitle {
      font-size: var(--text-body-sm);
      opacity: 0.9;
    }

    .report-header__right {
      text-align: right;
    }

    .report-header__date {
      font-size: 12px;
      opacity: 0.8;
    }

    .report-header__close {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .report-header__close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Report Body */
    .report-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4) var(--space-5);
    }

    /* Demo Banner */
    .report-demo-banner {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border: 1px solid #F59E0B;
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-bottom: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .report-demo-banner__icon {
      font-size: 1.5rem;
    }

    .report-demo-banner__text {
      flex: 1;
    }

    .report-demo-banner__title {
      font-weight: 700;
      color: #92400E;
      font-size: var(--text-body-sm);
    }

    .report-demo-banner__desc {
      color: #B45309;
      font-size: 12px;
    }

    /* Report Metadata */
    .report-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      padding: var(--space-3);
      background: var(--color-bg-light);
      border-radius: var(--radius-md);
    }

    .report-meta__item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .report-meta__label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-secondary);
    }

    .report-meta__value {
      font-size: var(--text-body-sm);
      font-weight: 500;
      color: var(--color-text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .report-meta__badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 600;
    }

    .report-meta__badge--dimension {
      background: rgba(59, 130, 246, 0.1);
      color: #2563EB;
    }

    .report-meta__badge--measure {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
    }

    .report-meta__badge--filter {
      background: rgba(245, 158, 11, 0.1);
      color: #D97706;
    }

    /* Report Chart */
    .report-chart {
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }

    .report-chart__title {
      font-size: var(--text-body-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .report-chart__container {
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Report Data Table */
    .report-table {
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .report-table__title {
      font-size: var(--text-body-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
      padding: var(--space-3) var(--space-4);
      background: var(--color-bg-light);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--color-border);
    }

    .report-table__container {
      max-height: 250px;
      overflow-y: auto;
    }

    .report-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .report-table th {
      background: var(--color-bg-light);
      font-weight: 600;
      text-align: left;
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--color-border);
      position: sticky;
      top: 0;
    }

    .report-table td {
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }

    .report-table tr:hover td {
      background: rgba(0, 51, 102, 0.02);
    }

    .report-table td:first-child {
      font-weight: 500;
    }

    .report-table td:last-child {
      text-align: right;
      font-family: 'SF Mono', Monaco, monospace;
    }

    /* Report Footer */
    .report-footer {
      padding: var(--space-3) var(--space-5);
      background: var(--color-bg-light);
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .report-footer__info {
      font-size: 12px;
      color: var(--color-text-secondary);
    }

    .report-footer__actions {
      display: flex;
      gap: var(--space-2);
    }

    .report-footer__btn {
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .report-footer__btn--secondary {
      background: white;
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
    }

    .report-footer__btn--secondary:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .report-footer__btn--primary {
      background: var(--color-primary);
      border: 1px solid var(--color-primary);
      color: white;
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .export-modal__content {
        max-height: 95vh;
      }
      .report-header {
        flex-direction: column;
        gap: var(--space-2);
      }
      .report-header__right {
        text-align: left;
      }
      .report-meta {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Explorer SVG Chart */
    .explorer-chart-svg {
      width: 100%;
      height: 350px;
    }
  </style>
</head>
<body>
  <!-- Persistent Mountain Background -->
  <div class="data-page-background" aria-hidden="true"></div>

  <!-- Stars for Dark Mode -->
  <div class="data-stars" aria-hidden="true">
    <!-- Stars generated by JS -->
  </div>

  <!-- Snow Particles for Light Mode -->
  <div class="data-snow" aria-hidden="true">
    <!-- Snowflakes generated by JS -->
  </div>

  <!-- Page Header -->
  <header class="page-header">
    <div class="container page-header__inner">
      <a href="index.html" class="page-header__logo">HORIZON</a>
      <nav class="page-header__nav">
        <a href="index.html" class="page-header__link">Home</a>
        <a href="programs.html" class="page-header__link">Programs</a>
        <a href="about.html" class="page-header__link">About</a>
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
          <span class="theme-toggle__icon">üåô</span>
        </button>
        <button class="nav__hamburger" aria-label="Menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
      </nav>
    </div>
  </header>

  <!-- Mobile Navigation -->
  <div class="mobile-nav__backdrop"></div>
  <nav class="mobile-nav">
    <ul class="mobile-nav__links">
      <li><a href="index.html" class="mobile-nav__link"><span class="mobile-nav__link-icon">üè†</span>Home</a></li>
      <li><a href="programs.html" class="mobile-nav__link"><span class="mobile-nav__link-icon">üìö</span>Programs</a></li>
      <li><a href="admission.html" class="mobile-nav__link"><span class="mobile-nav__link-icon">üéì</span>Admission</a></li>
      <li><a href="campus.html" class="mobile-nav__link"><span class="mobile-nav__link-icon">üèîÔ∏è</span>Campus</a></li>
      <li><a href="about.html" class="mobile-nav__link"><span class="mobile-nav__link-icon">‚ÑπÔ∏è</span>About</a></li>
      <li><a href="data.html" class="mobile-nav__link"><span class="mobile-nav__link-icon">üìä</span>Data</a></li>
    </ul>
    <div class="mobile-nav__divider"></div>
    <a href="admission.html" class="mobile-nav__cta">Apply Now</a>
  </nav>

  <!-- Hero Section -->
  <section class="ir-hero">
    <!-- Sun (visible in Light Mode) -->
    <div class="data-sun" aria-hidden="true"></div>
    <!-- Matrix Rain Effect -->
    <div class="matrix-rain" id="matrixRain" aria-hidden="true"></div>
    <div class="container ir-hero__content">
      <!-- Disclaimer Banner -->
      <div class="disclaimer-banner">
        <span class="disclaimer-banner__icon">‚ö†Ô∏è</span>
        <div class="disclaimer-banner__content">
          <div class="disclaimer-banner__title">Demonstration Only</div>
          <p class="disclaimer-banner__text">
            Data has been scraped from public sources (IPEDS, NCES, DataUSA) with best attempt at accuracy but has not been validated. This is a prototype visualization, not an official institutional resource.
          </p>
        </div>
      </div>
      <div class="ir-hero__badge">
        <span>üìä</span>
        <span>Institutional Research</span>
      </div>
      <h1 class="ir-hero__title">Fort Lewis College Data & Analytics</h1>
      <p class="ir-hero__subtitle">
        Explore enrollment trends, demographic insights, and key institutional metrics.
        Real data, beautifully visualized.
      </p>
    </div>
  </section>

  <!-- Main Content (Semi-transparent overlay) -->
  <main class="ir-content-section">

  <!-- Stats Cards -->
  <section class="container">
    <div class="stats-grid">
      <div class="stat-card fade-in">
        <div class="stat-card__value" id="totalEnrollment">3,413</div>
        <div class="stat-card__label">Total Enrollment (2023-24)</div>
        <div class="stat-card__trend stat-card__trend--up">
          <span>‚Üë</span>
          <span>+0.4% from last year</span>
        </div>
      </div>
      <div class="stat-card fade-in" style="animation-delay: 0.1s;">
        <div class="stat-card__value">63%</div>
        <div class="stat-card__label">Retention Rate</div>
        <div class="stat-card__trend stat-card__trend--down">
          <span>‚Üì</span>
          <span>-3% from median</span>
        </div>
      </div>
      <div class="stat-card fade-in" style="animation-delay: 0.2s;">
        <div class="stat-card__value">43%</div>
        <div class="stat-card__label">6-Year Graduation Rate</div>
        <div class="stat-card__trend stat-card__trend--up">
          <span>‚Üë</span>
          <span>+9% vs peers</span>
        </div>
      </div>
      <div class="stat-card fade-in" style="animation-delay: 0.3s;">
        <div class="stat-card__value">15:1</div>
        <div class="stat-card__label">Student-Faculty Ratio</div>
        <div class="stat-card__trend">
          <span>‚Äî</span>
          <span>At target</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard Section with Tabs -->
  <section class="dashboard">
    <div class="container">
      <!-- Tab Navigation -->
      <div class="ir-tabs" role="tablist">
        <button class="ir-tab active" data-tab="dashboard" role="tab" aria-selected="true">Dashboard</button>
        <button class="ir-tab" data-tab="tables" role="tab" aria-selected="false">Data Tables</button>
        <button class="ir-tab" data-tab="explorer" role="tab" aria-selected="false">Data Explorer</button>
      </div>

      <!-- TAB 1: Dashboard -->
      <div class="ir-tab-content active" id="tab-dashboard" role="tabpanel">
        <div class="dashboard__header">
          <h2 class="dashboard__title">Enrollment Trends</h2>
          <div class="dashboard__controls">
            <button class="control-btn active" data-view="total">Total</button>
            <button class="control-btn" data-view="gender">By Gender</button>
            <button class="control-btn" data-view="status">By Status</button>
          </div>
        </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Enrollment Over Time (2015-2024)</h3>
          <div class="chart-legend" id="chartLegend">
            <div class="legend-item">
              <span class="legend-dot" style="background: var(--color-primary);"></span>
              <span>Total Enrollment</span>
            </div>
          </div>
        </div>
        <div style="position: relative;">
          <svg class="chart-svg" id="enrollmentChart" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
            <!-- Grid lines -->
            <g class="chart-grid">
              <line class="chart-grid-line" x1="60" y1="40" x2="780" y2="40"/>
              <line class="chart-grid-line" x1="60" y1="105" x2="780" y2="105"/>
              <line class="chart-grid-line" x1="60" y1="170" x2="780" y2="170"/>
              <line class="chart-grid-line" x1="60" y1="235" x2="780" y2="235"/>
            </g>
            <!-- Y-axis labels - dynamically generated -->
            <g class="chart-y-axis" id="yAxisLabels">
              <!-- Generated by JS based on current view -->
            </g>
            <!-- X-axis labels -->
            <g class="chart-x-axis" id="xAxisLabels">
              <!-- Generated by JS -->
            </g>
            <!-- Chart content area -->
            <g id="chartContent">
              <!-- Generated by JS -->
            </g>
          </svg>
          <div class="chart-tooltip" id="chartTooltip"></div>
        </div>
      </div>

      <!-- Demographics -->
      <div class="dashboard__header">
        <h2 class="dashboard__title">Student Demographics (2023-24)</h2>
      </div>

      <div class="demographics-grid">
        <!-- Race/Ethnicity Donut -->
        <div class="chart-container">
          <h3 class="chart-title">Race & Ethnicity</h3>
          <div class="donut-chart-container">
            <svg class="donut-svg" viewBox="0 0 200 200" id="ethnicityChart">
              <!-- Generated by JS -->
            </svg>
            <div class="demographics-legend" id="ethnicityLegend">
              <!-- Generated by JS -->
            </div>
          </div>
        </div>

        <!-- Gender Donut -->
        <div class="chart-container">
          <h3 class="chart-title">Gender Distribution</h3>
          <div class="donut-chart-container">
            <svg class="donut-svg" viewBox="0 0 200 200" id="genderChart">
              <!-- Generated by JS -->
            </svg>
            <div class="demographics-legend" id="genderLegend">
              <!-- Generated by JS -->
            </div>
          </div>
        </div>
      </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-card__icon">üéì</div>
            <div class="metric-card__value">27%</div>
            <div class="metric-card__label">Native American Students</div>
          </div>
          <div class="metric-card">
            <div class="metric-card__icon">üåç</div>
            <div class="metric-card__value">62%</div>
            <div class="metric-card__label">Out-of-State Students</div>
          </div>
          <div class="metric-card">
            <div class="metric-card__icon">üí∞</div>
            <div class="metric-card__value">42%</div>
            <div class="metric-card__label">Pell Grant Recipients</div>
          </div>
          <div class="metric-card">
            <div class="metric-card__icon">üìö</div>
            <div class="metric-card__value">60+</div>
            <div class="metric-card__label">Degree Programs</div>
          </div>
        </div>

        <div class="data-source">
          <span class="data-source__icon">üìã</span>
          <span>Data sourced from IPEDS, FLC Institutional Research, and official fact sheets</span>
        </div>
      </div><!-- End TAB 1: Dashboard -->

      <!-- TAB 2: Data Tables -->
      <div class="ir-tab-content" id="tab-tables" role="tabpanel">
        <h2 class="dashboard__title" style="margin-bottom: var(--space-4);">Historical Data Tables</h2>

        <!-- Enrollment Data Table -->
        <div class="chart-container">
          <h3 class="chart-title">Enrollment by Year</h3>
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Total</th>
                  <th>Men</th>
                  <th>Women</th>
                  <th>Full-Time</th>
                  <th>Part-Time</th>
                  <th>YoY Change</th>
                </tr>
              </thead>
              <tbody id="dataTableBody">
                <!-- Generated by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Demographics Table -->
        <div class="chart-container" style="margin-top: var(--space-4);">
          <h3 class="chart-title">Demographics Breakdown (2023-24)</h3>
          <div class="data-table-container">
            <table class="data-table" id="demographicsTable">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Count</th>
                  <th>Percentage</th>
                </tr>
              </thead>
              <tbody id="demographicsTableBody">
                <!-- Generated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div><!-- End TAB 2: Data Tables -->

      <!-- TAB 3: Data Explorer -->
      <div class="ir-tab-content" id="tab-explorer" role="tabpanel">
        <div class="explorer">
          <!-- Field Panel -->
          <div class="field-panel">
            <div class="field-panel__section">
              <div class="field-panel__title">Dimensions</div>
              <div class="field field--dimension" draggable="true" data-field="year" data-type="dimension">
                <span class="field__icon">üìÖ</span>
                <span>Year</span>
              </div>
              <div class="field field--dimension" draggable="true" data-field="genderBreakdown" data-type="dimension">
                <span class="field__icon">‚ö§</span>
                <span>Gender</span>
              </div>
              <div class="field field--dimension" draggable="true" data-field="statusBreakdown" data-type="dimension">
                <span class="field__icon">üìã</span>
                <span>Enrollment Status</span>
              </div>
              <div class="field field--dimension" draggable="true" data-field="ethnicityBreakdown" data-type="dimension">
                <span class="field__icon">üåç</span>
                <span>Race/Ethnicity</span>
              </div>
            </div>

            <div class="field-panel__section">
              <div class="field-panel__title">Measures</div>
              <div class="field field--measure" draggable="true" data-field="total" data-type="measure">
                <span class="field__icon">üìä</span>
                <span>Total Enrollment</span>
              </div>
              <div class="field field--measure" draggable="true" data-field="count" data-type="measure">
                <span class="field__icon">#</span>
                <span>Count</span>
              </div>
            </div>
          </div>

          <!-- Workspace -->
          <div class="explorer__workspace">
            <!-- Drop Zones -->
            <div class="drop-zones drop-zones--four">
              <div class="drop-zone" id="dropRows" data-zone="rows">
                <div class="drop-zone__label">üìä Rows (Primary)</div>
                <div class="drop-zone__content" id="dropRowsContent">
                  <span class="drop-zone__placeholder">Drop a dimension here</span>
                </div>
              </div>
              <div class="drop-zone drop-zone--group" id="dropCols" data-zone="columns">
                <div class="drop-zone__label">üé® Columns (Group By)</div>
                <div class="drop-zone__content" id="dropColsContent">
                  <span class="drop-zone__placeholder">Optional: group/color by</span>
                </div>
              </div>
              <div class="drop-zone drop-zone--measures" id="dropValues" data-zone="values">
                <div class="drop-zone__label">üìà Values (Measure)</div>
                <div class="drop-zone__content" id="dropValuesContent">
                  <span class="drop-zone__placeholder">Drop a measure here</span>
                </div>
              </div>
              <div class="drop-zone drop-zone--filter" id="dropFilter" data-zone="filter">
                <div class="drop-zone__label">üîç Filter</div>
                <div class="drop-zone__content" id="dropFilterContent">
                  <span class="drop-zone__placeholder">Optional: filter by</span>
                </div>
                <!-- Filter Popup - dynamically populated -->
                <div class="filter-popup" id="filterPopup">
                  <div class="filter-popup__header">
                    <span class="filter-popup__title" id="filterPopupTitle">Filter by Year</span>
                    <button class="filter-popup__close" id="filterPopupClose">&times;</button>
                  </div>
                  <div class="filter-popup__body" id="filterPopupBody">
                    <!-- Dynamically populated based on dimension -->
                  </div>
                  <div class="filter-popup__actions">
                    <button class="filter-popup__btn filter-popup__btn--clear" id="filterClear">Clear</button>
                    <button class="filter-popup__btn filter-popup__btn--apply" id="filterApply">Apply Filter</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Chart Type Selector -->
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-2);">
              <div class="chart-type-selector">
                <button class="chart-type-btn active" data-chart-type="line" title="Line Chart">üìà</button>
                <button class="chart-type-btn" data-chart-type="bar" title="Bar Chart">üìä</button>
                <button class="chart-type-btn" data-chart-type="area" title="Area Chart">üìâ</button>
                <button class="chart-type-btn" data-chart-type="donut" title="Donut Chart">üç©</button>
              </div>
              <div style="display: flex; gap: var(--space-2);">
                <button class="explorer__export" id="explorerExport">üì§ Export</button>
                <button class="explorer__reset" id="explorerReset">Reset All</button>
              </div>
            </div>

            <!-- Mobile instructions -->
            <div class="mobile-explorer-hint" style="display: none; background: var(--color-bg-light); padding: var(--space-2); border-radius: var(--radius-sm); margin-bottom: var(--space-2); font-size: 12px; text-align: center;">
              <strong>Tap</strong> a field above, then <strong>tap</strong> a zone below to place it
            </div>

            <!-- Chart Preview -->
            <div class="chart-preview">
              <div class="chart-preview__header">
                <h3 class="chart-preview__title" id="explorerChartTitle">Chart Preview</h3>
              </div>
              <div class="chart-preview__content" id="explorerChartContent">
                <div class="chart-preview__empty">
                  <div class="chart-preview__empty-icon">üìä</div>
                  <div class="chart-preview__empty-text">Build your visualization</div>
                  <div class="chart-preview__empty-hint">
                    1. Drop a dimension on <strong>Rows</strong><br>
                    2. Optionally add a <strong>Group By</strong> dimension<br>
                    3. Drop a measure on <strong>Values</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- End TAB 3: Data Explorer -->

    </div>
  </section>

  </main><!-- End ir-content-section -->

  <!-- Footer -->
  <footer class="page-footer">
    <div class="container">
      <div class="page-footer__logo">HORIZON</div>
      <p class="page-footer__text">Institutional Research & Data Dashboard</p>
      <div class="page-footer__disclaimer">
        <span>üß™</span>
        <span>Prototype ¬∑ Real data, concept visualization</span>
      </div>
    </div>
  </footer>

  <script>
    // Real FLC Data
    const enrollmentData = {
      years: ['2015-16', '2016-17', '2017-18', '2018-19', '2019-20', '2020-21', '2021-22', '2022-23', '2023-24'],
      total: [3707, 3601, 3332, 3319, 3300, 3469, 3567, 3400, 3413],
      male: [1806, 1796, 1610, 1596, 1514, 1556, 1601, 1517, 1585],
      female: [1901, 1805, 1722, 1723, 1786, 1913, 1966, 1883, 1828],
      fullTime: [3393, 3179, 2921, 2883, 2862, 2904, 2914, 2877, 2826],
      partTime: [301, 412, 379, 389, 358, 455, 535, 431, 487]
    };

    const ethnicityData = [
      { label: 'White', value: 1504, percent: 44.1, color: '#3B82F6' },
      { label: 'Native American', value: 922, percent: 27.0, color: '#FFB81C' },
      { label: 'Hispanic/Latino', value: 492, percent: 14.4, color: '#10B981' },
      { label: 'Two or More', value: 387, percent: 11.3, color: '#8B5CF6' },
      { label: 'Other', value: 108, percent: 3.2, color: '#6B7280' }
    ];

    const genderData = [
      { label: 'Women', value: 1828, percent: 53.6, color: '#EC4899' },
      { label: 'Men', value: 1585, percent: 46.4, color: '#3B82F6' }
    ];

    // Extended data from IPEDS, DataUSA, CollegeTuitionCompare
    const extendedData = {
      // Admissions data
      admissions: {
        years: ['2019-20', '2020-21', '2021-22', '2022-23', '2023-24'],
        applicants: [3892, 4102, 4356, 4253, 4986],
        admitted: [3425, 3689, 3876, 3955, 3854],
        enrolled: [812, 798, 845, 795, 751],
        acceptanceRate: [88.0, 89.9, 89.0, 93.0, 77.3],
        yieldRate: [23.7, 21.6, 21.8, 20.1, 19.5]
      },
      // Retention rates (first-year to second-year)
      retention: {
        years: ['2018-19', '2019-20', '2020-21', '2021-22', '2022-23', '2023-24'],
        rates: [65, 62, 67, 64, 63, 63]
      },
      // Graduation rates (6-year)
      graduation: {
        years: ['2017', '2018', '2019', '2020', '2021', '2022'],
        cohortYears: ['2011', '2012', '2013', '2014', '2015', '2016'],
        sixYear: [40, 38, 41, 42, 43, 43],
        fourYear: [24, 22, 26, 28, 29, 30]
      },
      // Financial metrics
      financial: {
        avgNetPrice: 16074,
        inStateTuition: 9958,
        outStateTuition: 21526,
        roomBoard: 12482,
        financialAidPct: 89,
        pellGrantPct: 42,
        loanDefaultRate: 0
      },
      // Academic metrics
      academic: {
        studentFacultyRatio: 15,
        avgClassSize: 22,
        programs: 60,
        campusAcres: 362
      }
    };

    // Chart configuration
    const chartConfig = {
      width: 800,
      height: 300,
      padding: { top: 40, right: 20, bottom: 40, left: 60 }
    };

    // Dynamic Y-axis scales based on view (using round numbers for clean tick marks)
    function getYScaleForView(view) {
      if (view === 'total') return { minY: 2800, maxY: 4000 };  // Range 1200, step 400: 4000, 3600, 3200, 2800
      if (view === 'gender') return { minY: 1400, maxY: 2000 }; // Range 600, step 200: 2000, 1800, 1600, 1400
      if (view === 'status') return { minY: 0, maxY: 3600 };    // Range 3600, step 1200: 3600, 2400, 1200, 0
      return { minY: 0, maxY: 4000 };
    }

    let currentView = 'total';

    // Initialize charts
    function init() {
      renderEnrollmentChart();
      renderDonutChart('ethnicityChart', 'ethnicityLegend', ethnicityData);
      renderDonutChart('genderChart', 'genderLegend', genderData);
      renderDataTable();
      renderDemographicsTable();
      setupEventListeners();
      setupTabs();
      setupDataExplorer();
      initTheme();
      initMobileNav();
    }

    // Render enrollment line chart
    function renderEnrollmentChart() {
      const svg = document.getElementById('chartContent');
      const xLabels = document.getElementById('xAxisLabels');
      const yLabels = document.getElementById('yAxisLabels');
      const legend = document.getElementById('chartLegend');

      svg.innerHTML = '';
      xLabels.innerHTML = '';
      yLabels.innerHTML = '';

      const { years, total, male, female, fullTime, partTime } = enrollmentData;
      const { width, height, padding } = chartConfig;
      const { minY, maxY } = getYScaleForView(currentView);

      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      // X positions
      const xStep = chartWidth / (years.length - 1);
      const xPositions = years.map((_, i) => padding.left + i * xStep);

      // Y scale function
      const scaleY = (val) => {
        const ratio = (val - minY) / (maxY - minY);
        return height - padding.bottom - (ratio * chartHeight);
      };

      // Render Y-axis labels (4 labels)
      const ySteps = 4;
      const yRange = maxY - minY;
      for (let i = 0; i < ySteps; i++) {
        const yVal = maxY - (i * yRange / (ySteps - 1));
        const yPos = padding.top + (i * chartHeight / (ySteps - 1));
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'chart-axis-label');
        text.setAttribute('x', 50);
        text.setAttribute('y', yPos + 4);
        text.setAttribute('text-anchor', 'end');
        text.textContent = yVal.toLocaleString();
        yLabels.appendChild(text);
      }

      // Render X-axis labels
      years.forEach((year, i) => {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'chart-axis-label');
        text.setAttribute('x', xPositions[i]);
        text.setAttribute('y', height - 10);
        text.setAttribute('text-anchor', 'middle');
        text.textContent = year.split('-')[0];
        xLabels.appendChild(text);
      });

      // Determine which lines to draw
      let datasets = [];
      if (currentView === 'total') {
        datasets = [{ data: total, class: 'total', color: 'var(--color-primary)' }];
        legend.innerHTML = '<div class="legend-item"><span class="legend-dot" style="background: var(--color-primary);"></span><span>Total Enrollment</span></div>';
      } else if (currentView === 'gender') {
        datasets = [
          { data: male, class: 'male', color: '#3B82F6' },
          { data: female, class: 'female', color: '#EC4899' }
        ];
        legend.innerHTML = `
          <div class="legend-item"><span class="legend-dot" style="background: #3B82F6;"></span><span>Men</span></div>
          <div class="legend-item"><span class="legend-dot" style="background: #EC4899;"></span><span>Women</span></div>
        `;
      } else if (currentView === 'status') {
        datasets = [
          { data: fullTime, class: 'fulltime', color: '#2563EB' },
          { data: partTime, class: 'parttime', color: '#10B981' }
        ];
        legend.innerHTML = `
          <div class="legend-item"><span class="legend-dot" style="background: #2563EB;"></span><span>Full-Time</span></div>
          <div class="legend-item"><span class="legend-dot" style="background: #10B981;"></span><span>Part-Time</span></div>
        `;
      }

      // Draw each dataset
      datasets.forEach(({ data, class: cls, color }) => {
        // Create area path
        const areaPoints = data.map((val, i) => `${xPositions[i]},${scaleY(val)}`);
        const areaPath = `M${areaPoints.join(' L')} L${xPositions[xPositions.length - 1]},${height - padding.bottom} L${xPositions[0]},${height - padding.bottom} Z`;

        const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        area.setAttribute('class', `chart-area chart-area--${cls}`);
        area.setAttribute('d', areaPath);
        area.setAttribute('fill', color);
        svg.appendChild(area);

        // Create line path
        const linePoints = data.map((val, i) => `${xPositions[i]},${scaleY(val)}`);
        const linePath = `M${linePoints.join(' L')}`;

        const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        line.setAttribute('class', `chart-line chart-line--${cls}`);
        line.setAttribute('d', linePath);
        line.setAttribute('stroke', color);

        // Animate line
        const length = line.getTotalLength ? line.getTotalLength() : 1000;
        line.style.strokeDasharray = length;
        line.style.strokeDashoffset = length;
        line.style.animation = 'drawLine 1.5s ease forwards';

        svg.appendChild(line);

        // Create points
        data.forEach((val, i) => {
          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('class', `chart-point chart-point--${cls}`);
          circle.setAttribute('cx', xPositions[i]);
          circle.setAttribute('cy', scaleY(val));
          circle.setAttribute('r', 5);
          circle.setAttribute('stroke', color);
          circle.setAttribute('data-year', years[i]);
          circle.setAttribute('data-value', val.toLocaleString());
          svg.appendChild(circle);
        });
      });

      // Tooltip functionality
      const tooltip = document.getElementById('chartTooltip');
      svg.querySelectorAll('.chart-point').forEach(point => {
        point.addEventListener('mouseenter', (e) => {
          const year = e.target.getAttribute('data-year');
          const value = e.target.getAttribute('data-value');
          tooltip.innerHTML = `<strong>${year}</strong><br>${value} students`;
          tooltip.classList.add('visible');
        });

        point.addEventListener('mousemove', (e) => {
          const rect = svg.getBoundingClientRect();
          tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
          tooltip.style.top = (e.clientY - rect.top - 40) + 'px';
        });

        point.addEventListener('mouseleave', () => {
          tooltip.classList.remove('visible');
        });
      });
    }

    // Render donut chart
    function renderDonutChart(chartId, legendId, data) {
      const svg = document.getElementById(chartId);
      const legend = document.getElementById(legendId);

      svg.innerHTML = '';
      legend.innerHTML = '';

      const total = data.reduce((sum, d) => sum + d.value, 0);
      const centerX = 100;
      const centerY = 100;
      const radius = 70;
      const innerRadius = 45;

      let currentAngle = -90;

      data.forEach((item, index) => {
        const angle = (item.value / total) * 360;
        const startAngle = currentAngle;
        const endAngle = currentAngle + angle;

        // Create arc path
        const path = describeArc(centerX, centerY, radius, innerRadius, startAngle, endAngle);

        const segment = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        segment.setAttribute('class', 'donut-segment');
        segment.setAttribute('d', path);
        segment.setAttribute('fill', item.color);
        segment.setAttribute('data-index', index);
        svg.appendChild(segment);

        currentAngle = endAngle;

        // Create legend item
        const legendItem = document.createElement('div');
        legendItem.className = 'demo-legend-item';
        legendItem.innerHTML = `
          <div class="demo-legend-left">
            <div class="demo-legend-color" style="background: ${item.color};"></div>
            <span class="demo-legend-label">${item.label}</span>
          </div>
          <div>
            <span class="demo-legend-value">${item.value.toLocaleString()}</span>
            <span class="demo-legend-percent">(${item.percent}%)</span>
          </div>
        `;
        legend.appendChild(legendItem);
      });

      // Center text
      const centerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      centerText.setAttribute('class', 'donut-center-text');
      centerText.setAttribute('x', centerX);
      centerText.setAttribute('y', centerY);
      centerText.setAttribute('text-anchor', 'middle');
      centerText.setAttribute('dominant-baseline', 'middle');
      centerText.textContent = total.toLocaleString();
      svg.appendChild(centerText);

      const centerLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      centerLabel.setAttribute('class', 'donut-center-label');
      centerLabel.setAttribute('x', centerX);
      centerLabel.setAttribute('y', centerY + 18);
      centerLabel.setAttribute('text-anchor', 'middle');
      centerLabel.textContent = 'Students';
      svg.appendChild(centerLabel);
    }

    // Helper function to create arc path
    function describeArc(x, y, outerRadius, innerRadius, startAngle, endAngle) {
      const start = polarToCartesian(x, y, outerRadius, endAngle);
      const end = polarToCartesian(x, y, outerRadius, startAngle);
      const innerStart = polarToCartesian(x, y, innerRadius, endAngle);
      const innerEnd = polarToCartesian(x, y, innerRadius, startAngle);
      const largeArcFlag = endAngle - startAngle <= 180 ? 0 : 1;

      return [
        'M', start.x, start.y,
        'A', outerRadius, outerRadius, 0, largeArcFlag, 0, end.x, end.y,
        'L', innerEnd.x, innerEnd.y,
        'A', innerRadius, innerRadius, 0, largeArcFlag, 1, innerStart.x, innerStart.y,
        'Z'
      ].join(' ');
    }

    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
      const angleInRadians = (angleInDegrees) * Math.PI / 180.0;
      return {
        x: centerX + (radius * Math.cos(angleInRadians)),
        y: centerY + (radius * Math.sin(angleInRadians))
      };
    }

    // Render data table
    function renderDataTable() {
      const tbody = document.getElementById('dataTableBody');
      tbody.innerHTML = '';

      const { years, total, male, female, fullTime, partTime } = enrollmentData;

      years.forEach((year, i) => {
        const change = i > 0 ? total[i] - total[i - 1] : 0;
        const changeStr = change > 0 ? `+${change}` : change.toString();
        const changeClass = change > 0 ? 'stat-card__trend--up' : change < 0 ? 'stat-card__trend--down' : '';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${year}</strong></td>
          <td>${total[i].toLocaleString()}</td>
          <td>${male[i].toLocaleString()}</td>
          <td>${female[i].toLocaleString()}</td>
          <td>${fullTime[i].toLocaleString()}</td>
          <td>${partTime[i].toLocaleString()}</td>
          <td class="${changeClass}">${i === 0 ? '‚Äî' : changeStr}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Event listeners
    function setupEventListeners() {
      document.querySelectorAll('.control-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.dataset.view;
          renderEnrollmentChart();
        });
      });
    }

    // Render demographics table
    function renderDemographicsTable() {
      const tbody = document.getElementById('demographicsTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      // Combine ethnicity and gender data
      const allDemographics = [
        ...ethnicityData.map(d => ({ category: `Race/Ethnicity: ${d.label}`, count: d.value, percent: d.percent })),
        ...genderData.map(d => ({ category: `Gender: ${d.label}`, count: d.value, percent: d.percent }))
      ];

      allDemographics.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.category}</td>
          <td>${item.count.toLocaleString()}</td>
          <td>${item.percent}%</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Tab switching functionality
    function setupTabs() {
      const tabs = document.querySelectorAll('.ir-tab');
      const tabContents = document.querySelectorAll('.ir-tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;

          // Update active tab
          tabs.forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
          });
          tab.classList.add('active');
          tab.setAttribute('aria-selected', 'true');

          // Update active content
          tabContents.forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`tab-${targetTab}`).classList.add('active');
        });
      });
    }

    // Data Explorer - Enhanced with multi-dimension support
    function setupDataExplorer() {
      // Explorer state with 4 zones: rows, columns (group by), values, filter
      const explorerState = {
        rows: null,      // Primary dimension
        columns: null,   // Secondary dimension (group by)
        values: null,    // Measure
        filter: null,    // Filter dimension
        filterValues: null, // Selected filter values (array of selected items or {min, max} for year)
        chartType: 'line'
      };

      // Color palettes
      const colors = {
        primary: ['#2563EB', '#3B82F6', '#60A5FA', '#93C5FD', '#BFDBFE'],
        gender: { male: '#3B82F6', female: '#EC4899' },
        status: { fullTime: '#2563EB', partTime: '#10B981' },
        ethnicity: ['#3B82F6', '#FFB81C', '#10B981', '#8B5CF6', '#6B7280']
      };

      // Data mappings for dimensions
      const dimensionData = {
        year: {
          labels: enrollmentData.years.map(y => y.split('-')[0]),
          fullLabels: enrollmentData.years
        },
        genderBreakdown: {
          labels: ['Men', 'Women'],
          keys: ['male', 'female'],
          colors: [colors.gender.male, colors.gender.female]
        },
        statusBreakdown: {
          labels: ['Full-Time', 'Part-Time'],
          keys: ['fullTime', 'partTime'],
          colors: [colors.status.fullTime, colors.status.partTime]
        },
        ethnicityBreakdown: {
          labels: ethnicityData.map(e => e.label),
          values: ethnicityData.map(e => e.value),
          colors: ethnicityData.map(e => e.color)
        }
      };

      // DOM references
      const fields = document.querySelectorAll('.field[draggable="true"]');
      const dropRows = document.getElementById('dropRows');
      const dropCols = document.getElementById('dropCols');
      const dropValues = document.getElementById('dropValues');
      const dropFilter = document.getElementById('dropFilter');
      const dropRowsContent = document.getElementById('dropRowsContent');
      const dropColsContent = document.getElementById('dropColsContent');
      const dropValuesContent = document.getElementById('dropValuesContent');
      const dropFilterContent = document.getElementById('dropFilterContent');
      const chartTypeButtons = document.querySelectorAll('.chart-type-btn');
      const resetButton = document.getElementById('explorerReset');
      const exportButton = document.getElementById('explorerExport');
      const exportModal = document.getElementById('exportModal');
      const exportModalClose = document.getElementById('exportModalClose');
      const chartContent = document.getElementById('explorerChartContent');
      const chartTitle = document.getElementById('explorerChartTitle');

      // Filter popup elements
      const filterPopup = document.getElementById('filterPopup');
      const filterPopupTitle = document.getElementById('filterPopupTitle');
      const filterPopupBody = document.getElementById('filterPopupBody');
      const filterPopupClose = document.getElementById('filterPopupClose');
      const filterClear = document.getElementById('filterClear');
      const filterApply = document.getElementById('filterApply');

      // Mobile detection
      const isMobile = window.matchMedia('(max-width: 768px)').matches || 'ontouchstart' in window;
      let selectedField = null;

      // Initialize drag events (desktop) and tap events (mobile)
      fields.forEach(field => {
        // Desktop: drag and drop
        field.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', JSON.stringify({
            field: field.dataset.field,
            type: field.dataset.type,
            label: field.querySelector('span:last-child').textContent
          }));
          field.classList.add('dragging');
        });
        field.addEventListener('dragend', () => field.classList.remove('dragging'));

        // Mobile: tap to select, then tap zone to place
        field.addEventListener('click', (e) => {
          if (!isMobile) return;
          e.preventDefault();

          // Deselect all fields
          fields.forEach(f => f.classList.remove('selected'));

          // Select this field
          field.classList.add('selected');
          selectedField = {
            field: field.dataset.field,
            type: field.dataset.type,
            label: field.querySelector('span:last-child').textContent
          };
        });
      });

      // Setup drop zones
      const zones = [
        { el: dropRows, content: dropRowsContent, key: 'rows', accepts: 'dimension', placeholder: 'Drop a dimension here' },
        { el: dropCols, content: dropColsContent, key: 'columns', accepts: 'dimension', placeholder: 'Optional: group/color by' },
        { el: dropValues, content: dropValuesContent, key: 'values', accepts: 'measure', placeholder: 'Drop a measure here' },
        { el: dropFilter, content: dropFilterContent, key: 'filter', accepts: 'dimension', placeholder: 'Optional: filter by' }
      ];

      zones.forEach(zone => {
        // Desktop: drag and drop
        zone.el.addEventListener('dragover', (e) => { e.preventDefault(); zone.el.classList.add('drag-over'); });
        zone.el.addEventListener('dragleave', () => zone.el.classList.remove('drag-over'));
        zone.el.addEventListener('drop', (e) => {
          e.preventDefault();
          zone.el.classList.remove('drag-over');
          try {
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            if (data.type === zone.accepts) {
              explorerState[zone.key] = data;
              updateDropZoneDisplay(zone.content, data, zone.key, zone.placeholder);
              updateExplorerChart();
            }
          } catch (err) { console.error('Drop error:', err); }
        });

        // Mobile: tap zone to place selected field
        zone.el.addEventListener('click', (e) => {
          if (!isMobile || !selectedField) return;
          if (e.target.classList.contains('dropped-field__remove')) return; // Don't interfere with remove button

          if (selectedField.type === zone.accepts) {
            explorerState[zone.key] = selectedField;
            updateDropZoneDisplay(zone.content, selectedField, zone.key, zone.placeholder);
            updateExplorerChart();

            // Clear selection
            fields.forEach(f => f.classList.remove('selected'));
            selectedField = null;
          }
        });
      });

      // Update drop zone UI
      function updateDropZoneDisplay(container, item, stateKey, placeholder) {
        if (!item) {
          container.innerHTML = `<span class="drop-zone__placeholder">${placeholder}</span>`;
          // Hide filter popup and clear filter values when filter is removed
          if (stateKey === 'filter') {
            filterPopup.classList.remove('active');
            explorerState.filterValues = null;
          }
        } else {
          const isFilter = stateKey === 'filter';
          const hasActiveFilter = isFilter && explorerState.filterValues;
          const badge = hasActiveFilter ? '<span class="filter-active-badge">‚úì Active</span>' : '';
          const editIcon = isFilter ? '<span class="dropped-field__edit">‚úé</span>' : '';
          const filterClass = isFilter ? ' dropped-field--filter' : '';

          container.innerHTML = `
            <div class="dropped-field${filterClass}" data-field="${item.field}">
              <span>${item.label}${badge}</span>
              ${editIcon}
              <button class="dropped-field__remove" data-key="${stateKey}">&times;</button>
            </div>`;

          // Make filter field clickable to edit
          if (isFilter) {
            const fieldEl = container.querySelector('.dropped-field');
            fieldEl.addEventListener('click', (e) => {
              // Don't trigger if clicking remove button
              if (e.target.classList.contains('dropped-field__remove')) return;
              showFilterPopup(item);
            });
          }

          container.querySelector('.dropped-field__remove').addEventListener('click', (e) => {
            e.stopPropagation();
            explorerState[stateKey] = null;
            if (isFilter) {
              explorerState.filterValues = null;
              filterPopup.classList.remove('active');
            }
            updateDropZoneDisplay(container, null, stateKey, placeholder);
            updateExplorerChart();
          });

          // Show filter popup when a filter dimension is first dropped
          if (isFilter && !explorerState.filterValues) {
            showFilterPopup(item);
          }
        }
      }

      // Show filter popup with appropriate controls based on dimension
      function showFilterPopup(filterDimension) {
        filterPopupTitle.textContent = `Filter by ${filterDimension.label}`;
        filterPopupBody.innerHTML = '';

        if (filterDimension.field === 'year') {
          // Year: show range selector
          const years = enrollmentData.years;
          const currentFilter = explorerState.filterValues || { minIdx: 0, maxIdx: years.length - 1 };

          filterPopupBody.innerHTML = `
            <div class="filter-slider">
              <div class="filter-slider__inputs">
                <div class="filter-slider__input-group">
                  <label class="filter-slider__input-label">From Year</label>
                  <select class="filter-slider__select" id="filterYearMin">
                    ${years.map((y, i) => `<option value="${i}" ${i === currentFilter.minIdx ? 'selected' : ''}>${y}</option>`).join('')}
                  </select>
                </div>
                <span class="filter-slider__arrow">‚Üí</span>
                <div class="filter-slider__input-group">
                  <label class="filter-slider__input-label">To Year</label>
                  <select class="filter-slider__select" id="filterYearMax">
                    ${years.map((y, i) => `<option value="${i}" ${i === currentFilter.maxIdx ? 'selected' : ''}>${y}</option>`).join('')}
                  </select>
                </div>
              </div>
            </div>
          `;
        } else if (filterDimension.field === 'genderBreakdown') {
          // Gender: checkboxes
          const options = [
            { value: 'male', label: 'Men', color: colors.gender.male },
            { value: 'female', label: 'Women', color: colors.gender.female }
          ];
          const currentFilter = explorerState.filterValues || options.map(o => o.value);

          filterPopupBody.innerHTML = `
            <div class="filter-options">
              ${options.map(opt => `
                <label class="filter-option">
                  <input type="checkbox" value="${opt.value}" ${currentFilter.includes(opt.value) ? 'checked' : ''}>
                  <span class="filter-option__color" style="background: ${opt.color}"></span>
                  <span class="filter-option__label">${opt.label}</span>
                </label>
              `).join('')}
            </div>
          `;
        } else if (filterDimension.field === 'statusBreakdown') {
          // Status: checkboxes
          const options = [
            { value: 'fullTime', label: 'Full-Time', color: colors.status.fullTime },
            { value: 'partTime', label: 'Part-Time', color: colors.status.partTime }
          ];
          const currentFilter = explorerState.filterValues || options.map(o => o.value);

          filterPopupBody.innerHTML = `
            <div class="filter-options">
              ${options.map(opt => `
                <label class="filter-option">
                  <input type="checkbox" value="${opt.value}" ${currentFilter.includes(opt.value) ? 'checked' : ''}>
                  <span class="filter-option__color" style="background: ${opt.color}"></span>
                  <span class="filter-option__label">${opt.label}</span>
                </label>
              `).join('')}
            </div>
          `;
        } else if (filterDimension.field === 'ethnicityBreakdown') {
          // Ethnicity: checkboxes
          const currentFilter = explorerState.filterValues || ethnicityData.map((_, i) => i);

          filterPopupBody.innerHTML = `
            <div class="filter-options">
              ${ethnicityData.map((eth, i) => `
                <label class="filter-option">
                  <input type="checkbox" value="${i}" ${currentFilter.includes(i) ? 'checked' : ''}>
                  <span class="filter-option__color" style="background: ${eth.color}"></span>
                  <span class="filter-option__label">${eth.label}</span>
                </label>
              `).join('')}
            </div>
          `;
        }

        filterPopup.classList.add('active');
      }

      // Filter popup event handlers
      filterPopupClose.addEventListener('click', () => {
        filterPopup.classList.remove('active');
      });

      filterClear.addEventListener('click', () => {
        explorerState.filterValues = null;
        updateDropZoneDisplay(dropFilterContent, explorerState.filter, 'filter', 'Optional: filter by');
        filterPopup.classList.remove('active');
        updateExplorerChart();
      });

      filterApply.addEventListener('click', () => {
        if (!explorerState.filter) return;

        if (explorerState.filter.field === 'year') {
          const minSelect = document.getElementById('filterYearMin');
          const maxSelect = document.getElementById('filterYearMax');
          explorerState.filterValues = {
            minIdx: parseInt(minSelect.value),
            maxIdx: parseInt(maxSelect.value)
          };
        } else {
          const checkboxes = filterPopupBody.querySelectorAll('input[type="checkbox"]:checked');
          if (explorerState.filter.field === 'ethnicityBreakdown') {
            explorerState.filterValues = Array.from(checkboxes).map(cb => parseInt(cb.value));
          } else {
            explorerState.filterValues = Array.from(checkboxes).map(cb => cb.value);
          }
        }

        // Update display to show active badge
        updateDropZoneDisplay(dropFilterContent, explorerState.filter, 'filter', 'Optional: filter by');
        filterPopup.classList.remove('active');
        updateExplorerChart();
      });

      // Click outside to close filter popup
      document.addEventListener('click', (e) => {
        if (filterPopup.classList.contains('active') &&
            !filterPopup.contains(e.target) &&
            !dropFilter.contains(e.target)) {
          filterPopup.classList.remove('active');
        }
      });

      // Chart type selection
      chartTypeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          chartTypeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          explorerState.chartType = btn.dataset.chartType;
          updateExplorerChart();
        });
      });
      // Reset button
      resetButton.addEventListener('click', () => {
        explorerState.rows = null;
        explorerState.columns = null;
        explorerState.values = null;
        explorerState.filter = null;
        explorerState.filterValues = null;
        explorerState.chartType = 'line';
        filterPopup.classList.remove('active');
        zones.forEach(z => updateDropZoneDisplay(z.content, null, z.key, z.placeholder));
        chartTypeButtons.forEach(b => b.classList.remove('active'));
        document.querySelector('[data-chart-type="line"]').classList.add('active');
        updateExplorerChart();
      });

      // Export button - show professional report preview
      exportButton.addEventListener('click', () => {
        populateExportReport();
        exportModal.classList.add('active');
      });

      exportModalClose.addEventListener('click', () => {
        exportModal.classList.remove('active');
      });

      exportModal.addEventListener('click', (e) => {
        if (e.target === exportModal) {
          exportModal.classList.remove('active');
        }
      });

      // Populate export report with current state
      function populateExportReport() {
        const { rows, columns, values, filter, chartType } = explorerState;

        // Set date
        const now = new Date();
        document.getElementById('reportDate').textContent = `Generated: ${now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })} at ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;

        // Set title based on current selections
        const measureLabel = values ? values.label : 'Data';
        const dimensionLabel = rows ? rows.label : '';
        document.getElementById('reportTitle').textContent = `${measureLabel}${dimensionLabel ? ' by ' + dimensionLabel : ''} Report`;

        // Set chart type
        const chartTypeNames = { line: 'üìà Line Chart', bar: 'üìä Bar Chart', pie: 'ü•ß Pie Chart' };
        document.getElementById('reportChartType').textContent = chartTypeNames[chartType] || 'Line Chart';

        // Set dimension
        const dimensionEl = document.getElementById('reportDimension');
        if (rows) {
          dimensionEl.innerHTML = `<span class="report-meta__badge report-meta__badge--dimension">${rows.label}</span>`;
          if (columns) {
            dimensionEl.innerHTML += ` <span class="report-meta__badge report-meta__badge--dimension">${columns.label}</span>`;
          }
        } else {
          dimensionEl.innerHTML = '<span class="report-meta__badge report-meta__badge--dimension">None selected</span>';
        }

        // Set measure
        const measureEl = document.getElementById('reportMeasure');
        if (values) {
          measureEl.innerHTML = `<span class="report-meta__badge report-meta__badge--measure">${values.label}</span>`;
        } else {
          measureEl.innerHTML = '<span class="report-meta__badge report-meta__badge--measure">None selected</span>';
        }

        // Set filters
        const filtersEl = document.getElementById('reportFilters');
        if (filter) {
          let filterDesc = filter.label + ': ';
          if (filter.yearRange) {
            filterDesc += `${filter.yearRange.from} - ${filter.yearRange.to}`;
          } else if (filter.selectedValues && filter.selectedValues.length > 0) {
            filterDesc += filter.selectedValues.join(', ');
          }
          filtersEl.innerHTML = `<span class="report-meta__badge report-meta__badge--filter">${filterDesc}</span>`;
        } else {
          filtersEl.innerHTML = '<span class="report-meta__badge report-meta__badge--filter">None applied</span>';
        }

        // Clone current chart into report
        const chartContainer = document.getElementById('reportChartContainer');
        const currentChart = document.getElementById('explorerChartContent');
        if (currentChart) {
          chartContainer.innerHTML = currentChart.innerHTML;
        } else {
          chartContainer.innerHTML = '<p style="color: var(--color-text-secondary);">No chart generated yet</p>';
        }

        // Generate granular data table
        generateReportDataTable();
      }

      // Generate the granular data table for the report
      function generateReportDataTable() {
        const { rows, columns, values, filter } = explorerState;
        const tableHead = document.getElementById('reportTableHead');
        const tableBody = document.getElementById('reportTableBody');

        if (!rows || !values) {
          tableHead.innerHTML = '<th>No Data</th>';
          tableBody.innerHTML = '<tr><td>Select dimensions and measures to view data</td></tr>';
          return;
        }

        // Build headers based on current configuration
        let headers = [rows.label];
        if (columns && columns.field === 'genderBreakdown') {
          headers.push('Male', 'Female');
        } else if (columns && columns.field === 'statusBreakdown') {
          headers.push('Full-Time', 'Part-Time');
        } else {
          headers.push(values.label);
        }
        tableHead.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

        // Build data rows
        let dataRows = '';
        const data = buildChartData();

        if (data && data.length > 0) {
          data.forEach(point => {
            if (columns) {
              // Multi-series data
              dataRows += `<tr><td>${point.label}</td>`;
              if (point.male !== undefined) {
                dataRows += `<td>${point.male?.toLocaleString() || '‚Äî'}</td><td>${point.female?.toLocaleString() || '‚Äî'}</td>`;
              } else if (point.fullTime !== undefined) {
                dataRows += `<td>${point.fullTime?.toLocaleString() || '‚Äî'}</td><td>${point.partTime?.toLocaleString() || '‚Äî'}</td>`;
              }
              dataRows += '</tr>';
            } else {
              // Single series
              dataRows += `<tr><td>${point.label}</td><td>${point.value?.toLocaleString() || '‚Äî'}</td></tr>`;
            }
          });
        } else {
          dataRows = '<tr><td colspan="' + headers.length + '">No data available</td></tr>';
        }

        tableBody.innerHTML = dataRows;
      }

      // Set default state: Year + Enrollment Status breakdown on line chart
      function setDefaultState() {
        explorerState.rows = { field: 'year', type: 'dimension', label: 'Year' };
        explorerState.columns = { field: 'statusBreakdown', type: 'dimension', label: 'Enrollment Status' };
        explorerState.values = { field: 'total', type: 'measure', label: 'Total Enrollment' };
        explorerState.chartType = 'line';

        // Update drop zone displays
        updateDropZoneDisplay(dropRowsContent, explorerState.rows, 'rows', 'Drop a dimension here');
        updateDropZoneDisplay(dropColsContent, explorerState.columns, 'columns', 'Optional: group/color by');
        updateDropZoneDisplay(dropValuesContent, explorerState.values, 'values', 'Drop a measure here');

        // Set line chart as active
        chartTypeButtons.forEach(b => b.classList.remove('active'));
        document.querySelector('[data-chart-type="line"]').classList.add('active');

        updateExplorerChart();
      }

      // Initialize with default state
      setDefaultState();

      // Main chart update function
      function updateExplorerChart() {
        const { rows, columns, values } = explorerState;

        // Need at least rows and values
        if (!rows || !values) {
          let hints = [];
          if (!rows) hints.push('Drop a dimension on <strong>Rows</strong>');
          if (!values) hints.push('Drop a measure on <strong>Values</strong>');
          chartContent.innerHTML = `
            <div class="chart-preview__empty">
              <div class="chart-preview__empty-icon">üìä</div>
              <div class="chart-preview__empty-text">Build your visualization</div>
              <div class="chart-preview__empty-hint">${hints.join('<br>')}</div>
            </div>`;
          chartTitle.textContent = 'Chart Preview';
          return;
        }

        // Get chart data based on dimension combinations (with filter applied)
        const chartData = buildChartData(rows, columns, values, explorerState.chartType, explorerState.filter, explorerState.filterValues);

        // Build title based on what we're actually showing
        let title = '';
        if (chartData.type === 'categorical') {
          title = chartData.series[0]?.label || 'Distribution';
          if (rows.field !== 'year') title = `${rows.label} Distribution`;
        } else {
          title = values.label;
          if (columns) title += ` by ${columns.label}`;
          title += ` over ${rows.label}`;
        }
        chartTitle.textContent = title;

        // Render based on chart type
        if (explorerState.chartType === 'donut') {
          renderDonut(chartData);
        } else {
          renderChart(chartData);
        }
      }

      // Build data structure for charts
      function buildChartData(rows, columns, values, chartType, filter, filterValues) {
        const rowDim = dimensionData[rows.field];
        const colDim = columns ? dimensionData[columns.field] : null;

        // Apply year filter helper
        function getYearIndices() {
          if (filter && filter.field === 'year' && filterValues) {
            const indices = [];
            for (let i = filterValues.minIdx; i <= filterValues.maxIdx; i++) {
              indices.push(i);
            }
            return indices;
          }
          return enrollmentData.years.map((_, i) => i); // All years
        }

        // Apply gender filter helper
        function filterGender(genderKey) {
          if (filter && filter.field === 'genderBreakdown' && filterValues) {
            return filterValues.includes(genderKey);
          }
          return true;
        }

        // Apply status filter helper
        function filterStatus(statusKey) {
          if (filter && filter.field === 'statusBreakdown' && filterValues) {
            return filterValues.includes(statusKey);
          }
          return true;
        }

        // Apply ethnicity filter helper
        function filterEthnicity(index) {
          if (filter && filter.field === 'ethnicityBreakdown' && filterValues) {
            return filterValues.includes(index);
          }
          return true;
        }

        const yearIndices = getYearIndices();

        // Case 1: Year on rows (time series)
        if (rows.field === 'year') {
          const labels = yearIndices.map(i => rowDim.labels[i]);
          let series = [];

          // For donut chart with year, use the Group By dimension or show gender breakdown
          if (chartType === 'donut') {
            const latestIdx = yearIndices[yearIndices.length - 1]; // Use filtered latest year
            if (columns && columns.field === 'genderBreakdown') {
              const genders = [
                { key: 'male', label: 'Men', data: enrollmentData.male[latestIdx], color: colors.gender.male },
                { key: 'female', label: 'Women', data: enrollmentData.female[latestIdx], color: colors.gender.female }
              ].filter(g => filterGender(g.key));
              return {
                labels: genders.map(g => g.label),
                series: [{
                  label: 'Gender (Latest Year)',
                  data: genders.map(g => g.data),
                  color: genders.map(g => g.color)
                }],
                type: 'categorical'
              };
            } else if (columns && columns.field === 'statusBreakdown') {
              const statuses = [
                { key: 'fullTime', label: 'Full-Time', data: enrollmentData.fullTime[latestIdx], color: colors.status.fullTime },
                { key: 'partTime', label: 'Part-Time', data: enrollmentData.partTime[latestIdx], color: colors.status.partTime }
              ].filter(s => filterStatus(s.key));
              return {
                labels: statuses.map(s => s.label),
                series: [{
                  label: 'Status (Latest Year)',
                  data: statuses.map(s => s.data),
                  color: statuses.map(s => s.color)
                }],
                type: 'categorical'
              };
            } else if (columns && columns.field === 'ethnicityBreakdown') {
              const filteredEthnicity = ethnicityData.filter((_, i) => filterEthnicity(i));
              return {
                labels: filteredEthnicity.map(e => e.label),
                series: [{
                  label: 'Ethnicity',
                  data: filteredEthnicity.map(e => e.value),
                  color: filteredEthnicity.map(e => e.color)
                }],
                type: 'categorical'
              };
            } else {
              // No group by - show gender breakdown by default for donut (filtered)
              const genders = [
                { key: 'male', label: 'Men', data: enrollmentData.male[latestIdx], color: colors.gender.male },
                { key: 'female', label: 'Women', data: enrollmentData.female[latestIdx], color: colors.gender.female }
              ].filter(g => filterGender(g.key));
              return {
                labels: genders.map(g => g.label),
                series: [{
                  label: 'Gender (Latest Year)',
                  data: genders.map(g => g.data),
                  color: genders.map(g => g.color)
                }],
                type: 'categorical'
              };
            }
          }

          if (!columns) {
            // Single series - total enrollment (filtered by year)
            series.push({
              label: 'Total',
              data: yearIndices.map(i => enrollmentData.total[i]),
              color: colors.primary[0]
            });
          } else if (columns.field === 'genderBreakdown') {
            // Gender breakdown over time (filtered by year and optionally gender)
            if (filterGender('male')) {
              series.push({ label: 'Men', data: yearIndices.map(i => enrollmentData.male[i]), color: colors.gender.male });
            }
            if (filterGender('female')) {
              series.push({ label: 'Women', data: yearIndices.map(i => enrollmentData.female[i]), color: colors.gender.female });
            }
          } else if (columns.field === 'statusBreakdown') {
            // Status breakdown over time (filtered by year and optionally status)
            if (filterStatus('fullTime')) {
              series.push({ label: 'Full-Time', data: yearIndices.map(i => enrollmentData.fullTime[i]), color: colors.status.fullTime });
            }
            if (filterStatus('partTime')) {
              series.push({ label: 'Part-Time', data: yearIndices.map(i => enrollmentData.partTime[i]), color: colors.status.partTime });
            }
          } else if (columns.field === 'ethnicityBreakdown') {
            // For ethnicity over time, we only have latest year data
            // Show filtered ethnicity data
            const filteredEthnicity = ethnicityData.filter((_, i) => filterEthnicity(i));
            return {
              labels: filteredEthnicity.map(e => e.label),
              series: [{
                label: 'Ethnicity (2023-24)',
                data: filteredEthnicity.map(e => e.value),
                color: filteredEthnicity.map(e => e.color)
              }],
              type: 'categorical'
            };
          }
          return { labels, series, type: 'timeseries' };
        }

        // Case 2: Gender on rows (filtered)
        if (rows.field === 'genderBreakdown') {
          const latestIdx = yearIndices[yearIndices.length - 1]; // Use filtered latest year
          const genders = [
            { key: 'male', label: 'Men', data: enrollmentData.male[latestIdx], color: colors.gender.male },
            { key: 'female', label: 'Women', data: enrollmentData.female[latestIdx], color: colors.gender.female }
          ].filter(g => filterGender(g.key));

          return {
            labels: genders.map(g => g.label),
            series: [{
              label: 'Count',
              data: genders.map(g => g.data),
              color: genders.map(g => g.color)
            }],
            type: 'categorical'
          };
        }

        // Case 3: Status on rows (filtered)
        if (rows.field === 'statusBreakdown') {
          const latestIdx = yearIndices[yearIndices.length - 1]; // Use filtered latest year
          const statuses = [
            { key: 'fullTime', label: 'Full-Time', data: enrollmentData.fullTime[latestIdx], color: colors.status.fullTime },
            { key: 'partTime', label: 'Part-Time', data: enrollmentData.partTime[latestIdx], color: colors.status.partTime }
          ].filter(s => filterStatus(s.key));

          return {
            labels: statuses.map(s => s.label),
            series: [{
              label: 'Count',
              data: statuses.map(s => s.data),
              color: statuses.map(s => s.color)
            }],
            type: 'categorical'
          };
        }

        // Case 4: Ethnicity on rows (filtered)
        if (rows.field === 'ethnicityBreakdown') {
          const filteredEthnicity = ethnicityData.filter((_, i) => filterEthnicity(i));
          return {
            labels: filteredEthnicity.map(e => e.label),
            series: [{
              label: 'Count',
              data: filteredEthnicity.map(e => e.value),
              color: filteredEthnicity.map(e => e.color)
            }],
            type: 'categorical'
          };
        }

        return { labels: [], series: [], type: 'unknown' };
      }

      // Render line/bar/area charts
      function renderChart(chartData) {
        const { labels, series, type } = chartData;
        const width = 700, height = 320;
        const padding = { top: 30, right: 40, bottom: 60, left: 70 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Calculate scales
        const allValues = series.flatMap(s => s.data);
        const maxVal = Math.ceil(Math.max(...allValues) * 1.1);
        const minVal = type === 'categorical' ? 0 : Math.floor(Math.min(...allValues) * 0.9);

        // Calculate nice tick values FIRST
        const tickCount = 5;
        const range = maxVal - minVal;
        const tickStep = Math.ceil(range / tickCount / 100) * 100 || 100;
        const niceMax = Math.ceil(maxVal / tickStep) * tickStep;
        const niceMin = type === 'categorical' ? 0 : Math.floor(minVal / tickStep) * tickStep;

        // Use nice values for scaling to prevent axis overlap
        const xStep = type === 'categorical'
          ? chartWidth / labels.length
          : chartWidth / (labels.length - 1);

        const scaleY = (val) => {
          const ratio = (val - niceMin) / (niceMax - niceMin);
          return padding.top + chartHeight - (ratio * chartHeight);
        };

        let svg = `<svg class="explorer-chart-svg" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">`;

        // Grid lines
        svg += '<g class="chart-grid">';
        for (let i = 0; i <= tickCount; i++) {
          const y = padding.top + (chartHeight / tickCount) * i;
          svg += `<line class="chart-grid-line" x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}"/>`;
        }
        svg += '</g>';

        // Y-axis labels
        svg += '<g class="chart-y-axis">';
        for (let i = 0; i <= tickCount; i++) {
          const value = niceMax - ((niceMax - niceMin) / tickCount) * i;
          const y = padding.top + (chartHeight / tickCount) * i;
          svg += `<text class="chart-axis-label" x="${padding.left - 10}" y="${y + 4}" text-anchor="end">${Math.round(value).toLocaleString()}</text>`;
        }
        svg += '</g>';

        // X-axis labels
        svg += '<g class="chart-x-axis">';
        labels.forEach((label, i) => {
          const x = type === 'categorical'
            ? padding.left + i * xStep + xStep / 2
            : padding.left + i * xStep;
          svg += `<text class="chart-axis-label" x="${x}" y="${height - 25}" text-anchor="middle" style="font-size: 10px;">${label}</text>`;
        });
        svg += '</g>';

        // Draw series
        series.forEach((s, seriesIdx) => {
          const seriesColors = Array.isArray(s.color) ? s.color : [s.color];

          const baseline = padding.top + chartHeight; // Y position for value 0

          if (explorerState.chartType === 'bar' || type === 'categorical') {
            // Bar chart
            const barWidth = (xStep * 0.7) / series.length;
            const barOffset = seriesIdx * barWidth - (series.length * barWidth / 2) + barWidth / 2;

            s.data.forEach((val, i) => {
              const x = type === 'categorical'
                ? padding.left + i * xStep + xStep / 2 + barOffset - barWidth / 2
                : padding.left + i * xStep + barOffset - barWidth / 2;
              const yTop = scaleY(val);
              const barHeight = baseline - yTop;
              const color = seriesColors[i % seriesColors.length] || seriesColors[0];
              svg += `<rect x="${x}" y="${yTop}" width="${barWidth}" height="${barHeight}" fill="${color}" rx="3"/>`;
            });
          } else if (explorerState.chartType === 'area') {
            // Area chart
            const points = s.data.map((val, i) => `${padding.left + i * xStep},${scaleY(val)}`);
            const areaPath = `M${points.join(' L')} L${padding.left + (labels.length - 1) * xStep},${baseline} L${padding.left},${baseline} Z`;
            svg += `<path d="${areaPath}" fill="${seriesColors[0]}" opacity="0.2"/>`;
            svg += `<path d="M${points.join(' L')}" fill="none" stroke="${seriesColors[0]}" stroke-width="3"/>`;
            s.data.forEach((val, i) => {
              svg += `<circle cx="${padding.left + i * xStep}" cy="${scaleY(val)}" r="5" fill="white" stroke="${seriesColors[0]}" stroke-width="3"/>`;
            });
          } else {
            // Line chart
            const points = s.data.map((val, i) => `${padding.left + i * xStep},${scaleY(val)}`);
            svg += `<path d="M${points.join(' L')}" fill="none" stroke="${seriesColors[0]}" stroke-width="3" stroke-linecap="round"/>`;
            s.data.forEach((val, i) => {
              svg += `<circle cx="${padding.left + i * xStep}" cy="${scaleY(val)}" r="5" fill="white" stroke="${seriesColors[0]}" stroke-width="3"/>`;
            });
          }
        });

        svg += '</svg>';

        // Legend (only for multi-series)
        let legend = '';
        if (series.length > 1 || (series[0] && Array.isArray(series[0].color))) {
          legend = '<div class="chart-legend" style="margin-top: var(--space-3); justify-content: center; flex-wrap: wrap;">';
          if (series.length > 1) {
            series.forEach(s => {
              const color = Array.isArray(s.color) ? s.color[0] : s.color;
              legend += `<div class="legend-item"><span class="legend-dot" style="background: ${color};"></span><span>${s.label}</span></div>`;
            });
          } else if (type === 'categorical') {
            labels.forEach((label, i) => {
              const color = series[0].color[i];
              legend += `<div class="legend-item"><span class="legend-dot" style="background: ${color};"></span><span>${label}</span></div>`;
            });
          }
          legend += '</div>';
        }

        chartContent.innerHTML = svg + legend;
      }

      // Render donut chart
      function renderDonut(chartData) {
        const { labels, series } = chartData;
        const data = labels.map((label, i) => ({
          label,
          value: series[0].data[i],
          color: Array.isArray(series[0].color) ? series[0].color[i] : colors.primary[i]
        }));

        const total = data.reduce((sum, d) => sum + d.value, 0);
        const centerX = 120, centerY = 120, radius = 90, innerRadius = 55;

        let svg = `<svg viewBox="0 0 240 240" style="width: 240px; height: 240px;">`;
        let currentAngle = -90;

        data.forEach(item => {
          const angle = (item.value / total) * 360;
          const path = describeArc(centerX, centerY, radius, innerRadius, currentAngle, currentAngle + angle);
          svg += `<path d="${path}" fill="${item.color}" class="donut-segment"/>`;
          currentAngle += angle;
        });

        svg += `<text x="${centerX}" y="${centerY}" text-anchor="middle" dominant-baseline="middle" class="donut-center-text">${total.toLocaleString()}</text>`;
        svg += `<text x="${centerX}" y="${centerY + 18}" text-anchor="middle" class="donut-center-label">Total</text>`;
        svg += '</svg>';

        let legend = '<div class="demographics-legend" style="display: flex; gap: var(--space-2); flex-wrap: wrap; justify-content: center; margin-top: var(--space-3);">';
        data.forEach(item => {
          const percent = ((item.value / total) * 100).toFixed(1);
          legend += `
            <div class="demo-legend-item" style="background: var(--color-bg-light); padding: 0.5rem 0.75rem; border-radius: var(--radius-sm);">
              <div class="demo-legend-left">
                <div class="demo-legend-color" style="background: ${item.color}; width: 12px; height: 12px;"></div>
                <span class="demo-legend-label" style="font-size: 12px;">${item.label}</span>
              </div>
              <span class="demo-legend-value" style="margin-left: var(--space-1); font-size: 12px;">${item.value.toLocaleString()} (${percent}%)</span>
            </div>`;
        });
        legend += '</div>';

        chartContent.innerHTML = `<div style="display: flex; flex-direction: column; align-items: center;">${svg}${legend}</div>`;
      }
    }

    // Theme toggle
    function initTheme() {
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = themeToggle.querySelector('.theme-toggle__icon');
      const root = document.documentElement;

      function getPreferredTheme() {
        const savedTheme = localStorage.getItem('horizon-theme');
        if (savedTheme) return savedTheme;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function setTheme(theme) {
        root.setAttribute('data-theme', theme);
        localStorage.setItem('horizon-theme', theme);
        themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      }

      setTheme(getPreferredTheme());

      themeToggle.addEventListener('click', () => {
        const currentTheme = root.getAttribute('data-theme');
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
      });
    }

    // Mobile hamburger menu
    function initMobileNav() {
      const hamburger = document.querySelector('.nav__hamburger');
      const mobileNav = document.querySelector('.mobile-nav');
      const backdrop = document.querySelector('.mobile-nav__backdrop');

      if (!hamburger || !mobileNav) return;

      function toggleMobileNav() {
        const isActive = mobileNav.classList.contains('active');
        hamburger.classList.toggle('active', !isActive);
        mobileNav.classList.toggle('active', !isActive);
        if (backdrop) backdrop.classList.toggle('active', !isActive);
        document.body.style.overflow = isActive ? '' : 'hidden';
      }

      function closeMobileNav() {
        hamburger.classList.remove('active');
        mobileNav.classList.remove('active');
        if (backdrop) backdrop.classList.remove('active');
        document.body.style.overflow = '';
      }

      hamburger.addEventListener('click', toggleMobileNav);
      if (backdrop) backdrop.addEventListener('click', closeMobileNav);
      mobileNav.querySelectorAll('.mobile-nav__link, .mobile-nav__cta').forEach(link => {
        link.addEventListener('click', closeMobileNav);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileNav.classList.contains('active')) closeMobileNav();
      });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);

    // ===== VISUAL EFFECTS INITIALIZATION =====

    // Generate Matrix Rain
    function initMatrixRain() {
      const container = document.getElementById('matrixRain');
      if (!container) return;

      const dropCount = 40;
      for (let i = 0; i < dropCount; i++) {
        const drop = document.createElement('div');
        drop.className = 'matrix-drop';
        drop.style.left = `${Math.random() * 100}%`;
        drop.style.height = `${30 + Math.random() * 60}px`;
        drop.style.animationDuration = `${2 + Math.random() * 4}s`;
        drop.style.animationDelay = `${Math.random() * 4}s`;
        drop.style.opacity = 0.4 + Math.random() * 0.4;
        container.appendChild(drop);
      }
    }

    // Generate Starfield
    function initStars() {
      const container = document.querySelector('.data-stars');
      if (!container) return;

      // Regular stars
      for (let i = 0; i < 60; i++) {
        const star = document.createElement('div');
        star.className = i % 8 === 0 ? 'star star--large' : 'star';
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.setProperty('--duration', `${2 + Math.random() * 3}s`);
        star.style.setProperty('--delay', `${Math.random() * 3}s`);
        container.appendChild(star);
      }

      // Shooting stars
      for (let i = 0; i < 3; i++) {
        const shootingStar = document.createElement('div');
        shootingStar.className = 'shooting-star';
        shootingStar.style.left = `${10 + Math.random() * 60}%`;
        shootingStar.style.top = `${5 + Math.random() * 30}%`;
        shootingStar.style.setProperty('--delay', `${2 + i * 8}s`);
        container.appendChild(shootingStar);
      }
    }

    // Generate Snow
    function initSnow() {
      const container = document.querySelector('.data-snow');
      if (!container) return;

      for (let i = 0; i < 30; i++) {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.style.left = `${Math.random() * 100}%`;
        snowflake.style.animationDuration = `${15 + Math.random() * 10}s`;
        snowflake.style.animationDelay = `${Math.random() * 15}s`;
        snowflake.style.opacity = 0.3 + Math.random() * 0.4;
        container.appendChild(snowflake);
      }
    }

    // Initialize visual effects
    initMatrixRain();
    initStars();
    initSnow();
  </script>

  <!-- Export Report Preview Modal -->
  <div class="export-modal" id="exportModal">
    <div class="export-modal__content">
      <!-- Report Header -->
      <div class="report-header">
        <div class="report-header__left">
          <div class="report-header__logo">HORIZON ANALYTICS</div>
          <h2 class="report-header__title" id="reportTitle">Enrollment Trends Report</h2>
          <p class="report-header__subtitle">Fort Lewis College ¬∑ Institutional Research</p>
        </div>
        <div class="report-header__right">
          <p class="report-header__date" id="reportDate"></p>
        </div>
        <button class="report-header__close" id="exportModalClose" aria-label="Close">√ó</button>
      </div>

      <!-- Report Body -->
      <div class="report-body">
        <!-- Demo Banner -->
        <div class="report-demo-banner">
          <span class="report-demo-banner__icon">‚ö†Ô∏è</span>
          <div class="report-demo-banner__text">
            <div class="report-demo-banner__title">Demonstration Preview Only</div>
            <div class="report-demo-banner__desc">This is a conceptual demonstration utilizing unvalidated data from public sources. Content serves only to populate the prototype and may be legacy or non-current. Export functionality is disabled.</div>
          </div>
        </div>

        <!-- Report Metadata -->
        <div class="report-meta">
          <div class="report-meta__item">
            <span class="report-meta__label">Chart Type</span>
            <span class="report-meta__value" id="reportChartType">Line Chart</span>
          </div>
          <div class="report-meta__item">
            <span class="report-meta__label">Dimension</span>
            <span class="report-meta__value" id="reportDimension">
              <span class="report-meta__badge report-meta__badge--dimension">None selected</span>
            </span>
          </div>
          <div class="report-meta__item">
            <span class="report-meta__label">Measure</span>
            <span class="report-meta__value" id="reportMeasure">
              <span class="report-meta__badge report-meta__badge--measure">None selected</span>
            </span>
          </div>
          <div class="report-meta__item">
            <span class="report-meta__label">Active Filters</span>
            <span class="report-meta__value" id="reportFilters">
              <span class="report-meta__badge report-meta__badge--filter">None</span>
            </span>
          </div>
        </div>

        <!-- Chart Preview -->
        <div class="report-chart">
          <div class="report-chart__title">üìä Visualization Preview</div>
          <div class="report-chart__container" id="reportChartContainer">
            <!-- Chart will be cloned here -->
          </div>
        </div>

        <!-- Data Table -->
        <div class="report-table">
          <div class="report-table__title">üìã Granular Data</div>
          <div class="report-table__container">
            <table id="reportDataTable">
              <thead>
                <tr id="reportTableHead"></tr>
              </thead>
              <tbody id="reportTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Report Footer -->
      <div class="report-footer">
        <div class="report-footer__info">
          Generated by HORIZON Analytics ¬∑ Powered by Claude AI
        </div>
        <div class="report-footer__actions">
          <button class="report-footer__btn report-footer__btn--secondary" onclick="document.getElementById('exportModal').classList.remove('active')">Close Preview</button>
          <button class="report-footer__btn report-footer__btn--primary" title="Export disabled in demo">
            üì§ Export PDF (Demo)
          </button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
