<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="HORIZON - Fort Lewis College Institutional Research Dashboard. Interactive data visualization.">
  <title>Institutional Research & Data | HORIZON</title>
  <link rel="stylesheet" href="src/css/design-system.css">
  <style>
    /* Navigation */
    .nav {
      background: var(--gradient-hero);
      padding: var(--space-3) 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav__inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav__logo {
      font-size: 1.5rem;
      font-weight: 200;
      letter-spacing: 0.3em;
      color: var(--color-text-inverse);
      text-decoration: none;
    }

    .nav__links {
      display: none;
      gap: var(--space-4);
      list-style: none;
    }

    @media (min-width: 768px) {
      .nav__links {
        display: flex;
      }
    }

    .nav__link {
      color: rgba(255, 255, 255, 0.8);
      font-size: var(--text-body-sm);
      transition: color var(--duration-fast) var(--ease-default);
    }

    .nav__link:hover,
    .nav__link--active {
      color: var(--color-accent);
    }

    .nav__actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .nav__search {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--color-text-inverse);
      transition: all var(--duration-fast) var(--ease-default);
    }

    .nav__search:hover {
      background: rgba(255, 255, 255, 0.2);
      color: var(--color-accent);
    }

    .nav__cta {
      background: var(--color-accent);
      color: var(--color-primary);
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: var(--text-caption);
      display: none;
    }

    @media (min-width: 768px) {
      .nav__cta {
        display: block;
      }
    }

    .nav__cta:hover {
      background: var(--color-accent-hover);
    }

    /* Disclaimer Banner */
    .disclaimer-banner {
      background: rgba(255, 184, 28, 0.15);
      border: 1px solid rgba(255, 184, 28, 0.4);
      border-radius: var(--radius-lg);
      padding: var(--space-3) var(--space-4);
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      backdrop-filter: blur(10px);
    }

    .disclaimer-banner__icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .disclaimer-banner__content {
      flex: 1;
    }

    .disclaimer-banner__title {
      font-weight: 700;
      font-size: var(--text-body-sm);
      color: var(--color-accent);
      margin-bottom: 0.25rem;
    }

    .disclaimer-banner__text {
      font-size: var(--text-caption);
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.5;
    }

    /* Uses shared .page-background from design-system.css */

    /* ===== STARFIELD (Dark Mode) ===== */
    .data-stars {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    [data-theme="dark"] .data-stars {
      opacity: 1;
    }

    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: twinkle var(--duration, 3s) ease-in-out infinite;
      animation-delay: var(--delay, 0s);
    }

    .star--large {
      width: 3px;
      height: 3px;
      box-shadow: 0 0 6px 1px rgba(255, 255, 255, 0.5);
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .shooting-star {
      position: absolute;
      width: 100px;
      height: 2px;
      background: linear-gradient(90deg, white, transparent);
      opacity: 0;
      animation: shoot 6s ease-in-out infinite;
      animation-delay: var(--delay, 2s);
    }

    @keyframes shoot {
      0% { opacity: 0; transform: translateX(0) translateY(0); }
      5% { opacity: 1; }
      15% { opacity: 0; transform: translateX(300px) translateY(150px); }
      100% { opacity: 0; }
    }

    /* ===== SNOW PARTICLES (Light Mode) ===== */
    .data-snow {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      overflow: hidden;
    }

    [data-theme="dark"] .data-snow {
      opacity: 0.3;
    }

    .snowflake {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: snowfall linear infinite;
    }

    @keyframes snowfall {
      0% { transform: translateY(-10px) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(100vh) translateX(20px); opacity: 0; }
    }

    /* Snow: Hidden in light mode, visible in dark mode only */
    .data-snow {
      opacity: 0;
    }

    [data-theme="dark"] .data-snow {
      opacity: 1;
    }

    [data-theme="dark"] .snowflake {
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.8);
    }

    /* ===== Hero Section ===== */
    .ir-hero {
      background: linear-gradient(135deg, rgba(0, 51, 102, 0.85) 0%, rgba(0, 26, 51, 0.9) 50%, rgba(0, 34, 68, 0.85) 100%);
      color: var(--color-text-inverse);
      padding: var(--space-8) 0 var(--space-10);
      position: relative;
      overflow: hidden;
    }

    [data-theme="dark"] .ir-hero {
      background: linear-gradient(135deg, rgba(10, 10, 26, 0.9) 0%, rgba(13, 21, 37, 0.85) 50%, rgba(26, 26, 58, 0.9) 100%);
    }

    .ir-hero__content {
      position: relative;
      z-index: 2;
    }

    .ir-hero__badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      background: rgba(255, 184, 28, 0.2);
      border: 1px solid rgba(255, 184, 28, 0.4);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      font-size: var(--text-caption);
      font-weight: 600;
      color: var(--color-accent);
      margin-bottom: var(--space-3);
    }

    .ir-hero__title {
      font-size: var(--text-h1);
      margin-bottom: var(--space-2);
    }

    .ir-hero__subtitle {
      font-size: var(--text-body);
      opacity: 0.9;
      max-width: 600px;
      margin-bottom: var(--space-6);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
      margin-top: var(--space-4);
      position: relative;
    }

    @media (min-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* ===== CLEAN METRIC CARDS ===== */
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 51, 102, 0.1);
      border: 1px solid rgba(0, 51, 102, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 51, 102, 0.15);
    }

    [data-theme="dark"] .stat-card {
      background: rgba(22, 27, 34, 0.95);
      border-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .stat-card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    .stat-card__value {
      font-size: clamp(2rem, 5vw, 2.5rem);
      font-weight: 700;
      color: var(--color-primary);
      line-height: 1;
      margin-bottom: var(--space-1);
    }

    [data-theme="dark"] .stat-card__value {
      color: var(--color-accent);
    }

    .stat-card__label {
      font-size: var(--text-caption);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }

    .stat-card__trend {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: var(--text-caption);
      font-weight: 600;
    }

    .stat-card__trend--up {
      color: var(--color-success);
    }

    .stat-card__trend--down {
      color: var(--color-error);
    }

    /* ===== SEMI-TRANSPARENT CONTENT SECTIONS ===== */
    .ir-content-section {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      position: relative;
      z-index: 1;
      margin-top: -2rem;
      padding-top: 2rem;
    }

    [data-theme="dark"] .ir-content-section {
      background: rgba(13, 17, 23, 0.7);
    }

    /* Dashboard Section */
    .dashboard {
      padding: var(--space-8) 0;
    }

    .dashboard__header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    .dashboard__title {
      font-size: var(--text-h2);
      color: var(--color-primary);
    }

    .dashboard__controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .control-btn {
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      font-size: var(--text-caption);
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .control-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .control-btn.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: var(--color-text-inverse);
    }

    /* Chart Container */
    .chart-container {
      background: var(--color-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-6);
      border: 1px solid var(--color-border);
    }

    .chart-header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }

    .chart-title {
      font-size: var(--text-h3);
      color: var(--color-primary);
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2) var(--space-3);
      margin-top: var(--space-2);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--text-caption);
      color: var(--color-text-secondary);
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    /* SVG Chart Styles */
    .chart-svg {
      width: 100%;
      height: 300px;
    }

    .chart-line {
      fill: none;
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .chart-line--total {
      stroke: var(--color-primary);
    }

    .chart-line--male {
      stroke: #3B82F6;
    }

    .chart-line--female {
      stroke: #FFB81C;
    }

    .chart-area {
      opacity: 0.1;
    }

    .chart-area--total {
      fill: var(--color-primary);
    }

    .chart-point {
      fill: var(--color-surface);
      stroke-width: 3;
      cursor: pointer;
      transition: r 0.2s ease;
    }

    .chart-point:hover {
      r: 8;
    }

    .chart-point--total {
      stroke: var(--color-primary);
    }

    .chart-point--male {
      stroke: #3B82F6;
    }

    .chart-point--female {
      stroke: #FFB81C;
    }

    /* Full-Time / Part-Time chart styles */
    .chart-line--fulltime {
      stroke: #2563EB;
    }

    .chart-line--parttime {
      stroke: #10B981;
    }

    .chart-area--fulltime {
      fill: #2563EB;
    }

    .chart-area--parttime {
      fill: #10B981;
    }

    .chart-point--fulltime {
      stroke: #2563EB;
    }

    .chart-point--parttime {
      stroke: #10B981;
    }

    .chart-grid-line {
      stroke: var(--color-border);
      stroke-dasharray: 4, 4;
    }

    .chart-axis-label {
      fill: var(--color-text-secondary);
      font-size: 11px;
    }

    .chart-tooltip {
      position: absolute;
      background: var(--color-bg-dark);
      color: var(--color-text-inverse);
      padding: var(--space-2);
      border-radius: var(--radius-md);
      font-size: var(--text-caption);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 100;
    }

    .chart-tooltip.visible {
      opacity: 1;
    }

    /* Demographics Section */
    .demographics-grid {
      display: grid;
      gap: var(--space-4);
    }

    @media (min-width: 768px) {
      .demographics-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (min-width: 1200px) {
      .demographics-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .donut-chart-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .donut-svg {
      width: 250px;
      height: 250px;
    }

    .donut-segment {
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
      transform-origin: center;
    }

    .donut-segment:hover {
      opacity: 0.8;
    }

    .donut-center-text {
      font-size: 24px;
      font-weight: 700;
      fill: var(--color-primary);
    }

    .donut-center-label {
      font-size: 12px;
      fill: var(--color-text-secondary);
    }

    .demographics-legend {
      display: grid;
      gap: var(--space-2);
      margin-top: var(--space-3);
      width: 100%;
      max-width: 280px;
    }

    .demo-legend-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-2);
      border-radius: var(--radius-sm);
      cursor: pointer;
      gap: var(--space-2);
      transition: background 0.2s;
    }

    .demo-legend-item:hover {
      background: var(--color-bg-light);
    }

    .demo-legend-left {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      flex: 1;
      min-width: 0;
    }

    .demo-legend-color {
      width: 14px;
      height: 14px;
      border-radius: var(--radius-sm);
      flex-shrink: 0;
    }

    .demo-legend-label {
      font-size: 13px;
      color: var(--color-text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .demo-legend-value {
      font-weight: 600;
      font-size: 13px;
      color: var(--color-text-primary);
      white-space: nowrap;
    }

    .demo-legend-percent {
      font-size: 11px;
      color: var(--color-text-secondary);
      margin-left: 2px;
    }

    /* Data Table */
    .data-table-container {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--text-body-sm);
    }

    .data-table th,
    .data-table td {
      padding: var(--space-2) var(--space-3);
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    .data-table th {
      background: var(--color-bg-light);
      font-weight: 600;
      color: var(--color-text-primary);
      white-space: nowrap;
    }

    .data-table tr:hover {
      background: var(--color-bg-light);
    }

    .data-table td {
      color: var(--color-text-primary);
    }

    /* Key Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
      margin-top: var(--space-4);
    }

    @media (min-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .metric-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      border: 1px solid var(--color-border);
      text-align: center;
    }

    .metric-card__icon {
      font-size: 2rem;
      margin-bottom: var(--space-2);
    }

    .metric-card__value {
      font-size: var(--text-h2);
      font-weight: 700;
      color: var(--color-primary);
    }

    .metric-card__label {
      font-size: var(--text-caption);
      color: var(--color-text-secondary);
    }

    /* Footer */
    .page-footer {
      background: var(--color-bg-dark);
      color: var(--color-text-inverse);
      padding: var(--space-6) 0;
      text-align: center;
    }

    .page-footer__logo {
      font-size: 1.25rem;
      font-weight: 200;
      letter-spacing: 0.3em;
      margin-bottom: var(--space-2);
    }

    .page-footer__text {
      font-size: var(--text-caption);
      opacity: 0.7;
    }

    .page-footer__disclaimer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-1);
      margin-top: var(--space-3);
      font-size: var(--text-caption);
      opacity: 0.5;
    }

    /* Data Source Badge */
    .data-source {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      background: var(--color-bg-light);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      font-size: var(--text-caption);
      color: var(--color-text-secondary);
      margin-top: var(--space-4);
    }

    .data-source__icon {
      font-size: 1rem;
    }

    /* Dark Mode */
    [data-theme="dark"] .stat-card,
    [data-theme="dark"] .chart-container,
    [data-theme="dark"] .metric-card {
      background: var(--color-surface);
      border-color: var(--color-border);
    }

    [data-theme="dark"] .stat-card__value,
    [data-theme="dark"] .chart-title,
    [data-theme="dark"] .dashboard__title,
    [data-theme="dark"] .metric-card__value {
      color: var(--color-text-primary);
    }

    [data-theme="dark"] .ir-hero {
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0d1117 100%);
    }

    /* Dark Mode - Export Report */
    [data-theme="dark"] .report-chart,
    [data-theme="dark"] .report-table {
      background: var(--color-surface);
      border-color: var(--color-border);
    }

    [data-theme="dark"] .report-table th {
      background: rgba(255, 255, 255, 0.05);
    }

    [data-theme="dark"] .report-demo-banner {
      background: linear-gradient(135deg, #422006 0%, #713f12 100%);
      border-color: #92400E;
    }

    [data-theme="dark"] .report-demo-banner__title {
      color: #FBBF24;
    }

    [data-theme="dark"] .report-demo-banner__desc {
      color: #FCD34D;
    }

    /* Theme Toggle in Header */
    .theme-toggle {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--color-text-inverse);
      font-size: 1rem;
      transition: all var(--duration-fast);
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Animation */
    .fade-in {
      animation: fadeIn 0.6s ease forwards;
    }

    .fade-in-up {
      animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes drawLine {
      to {
        stroke-dashoffset: 0;
      }
    }

    /* ===== TABBED INTERFACE ===== */
    .ir-tabs {
      display: flex;
      gap: var(--space-1);
      border-bottom: 2px solid var(--color-border);
      margin-bottom: var(--space-6);
    }

    .ir-tab {
      padding: var(--space-3) var(--space-4);
      background: none;
      border: none;
      font-size: var(--text-body-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      transition: color var(--duration-fast);
    }

    .ir-tab:hover {
      color: var(--color-primary);
    }

    .ir-tab.active {
      color: var(--color-primary);
    }

    .ir-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--color-primary);
      border-radius: 2px 2px 0 0;
    }

    .ir-tab-content {
      display: none;
    }

    .ir-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* ===== DATA EXPLORER - UNIFIED UI ===== */
    /* Unified Explorer Container */
    .explorer-unified {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 51, 102, 0.08);
    }

    [data-theme="dark"] .explorer-unified {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    /* Explorer Header Bar */
    .explorer__source-bar {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-3) var(--space-4);
      background: linear-gradient(135deg, var(--color-primary) 0%, #004080 100%);
      border-bottom: 1px solid var(--color-border);
    }

    [data-theme="dark"] .explorer__source-bar {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    .source-selector__label {
      font-weight: 600;
      color: white;
      font-size: 0.875rem;
      white-space: nowrap;
    }

    .source-selector__dropdown {
      padding: 8px 36px 8px 12px;
      font-size: 0.9rem;
      font-weight: 500;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.95);
      color: var(--color-primary);
      cursor: pointer;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23003366" d="M2 4l4 4 4-4z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      min-width: 180px;
    }

    .explorer__actions {
      margin-left: auto;
      display: flex;
      gap: var(--space-2);
    }

    .explorer__actions .explorer__reset,
    .explorer__actions .explorer__export {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      color: white;
    }

    .explorer__actions .explorer__reset:hover {
      background: rgba(220, 38, 38, 0.3);
      border-color: rgba(220, 38, 38, 0.5);
    }

    .explorer__actions .explorer__export {
      background: var(--color-accent);
      border-color: var(--color-accent);
      color: var(--color-primary);
    }

    .explorer__actions .explorer__export:hover {
      background: var(--color-accent-hover);
    }

    /* Main Explorer Body */
    .explorer-body {
      display: grid;
      grid-template-columns: 200px 1fr;
      min-height: 550px;
    }

    /* Main Explorer Grid: Left Panel | Right Workspace */
    .explorer {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 0;
      min-height: 550px;
    }

    @media (max-width: 1024px) {
      .explorer {
        grid-template-columns: 180px 1fr;
      }
    }

    @media (max-width: 768px) {
      .explorer__source-bar {
        flex-wrap: wrap;
        gap: var(--space-2);
      }
      .explorer__actions {
        margin-left: 0;
        width: 100%;
        justify-content: flex-end;
      }
      .explorer {
        grid-template-columns: 1fr;
      }
    }

    /* Mobile-friendly Data Explorer */
    @media (max-width: 768px) {
      /* Fix header blocking hero buttons */
      .ir-hero {
        padding-top: calc(var(--space-8) + 20px);
      }

      /* Hide the field panel and drop zones on mobile - chart is king */
      .explorer-section:not(.explorer-section--fullscreen) .field-panel,
      .explorer-section:not(.explorer-section--fullscreen) .drop-zones,
      .explorer-section:not(.explorer-section--fullscreen) .chart-type-selector {
        display: none;
      }

      .explorer {
        min-height: auto;
        gap: var(--space-3);
      }

      /* Make chart the hero - much larger */
      .chart-preview {
        min-height: 65vh;
        padding: var(--space-3);
      }

      .explorer-chart-svg {
        min-height: 55vh;
        height: auto;
      }

      .chart-preview__empty-icon {
        font-size: 2.5rem;
      }

      .chart-preview__empty-text {
        font-size: var(--text-body-sm);
      }

      .chart-preview__empty-hint {
        font-size: 11px;
      }

      /* Simplified source bar - just essentials */
      .explorer__source-bar {
        flex-wrap: wrap;
        gap: var(--space-2);
        padding: var(--space-3);
      }

      /* Hide fullscreen button on mobile */
      .explorer__fullscreen {
        display: none;
      }

      /* Mobile legend - stack vertically below chart */
      .chart-legend {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
        gap: var(--space-1);
      }

      .legend-item {
        width: 100%;
        font-size: 12px;
      }

      /* Show mobile edit button */
      .mobile-edit-btn {
        display: flex !important;
        align-items: center;
        gap: 6px;
      }
    }

    /* Mobile Edit Inputs Button - hidden by default */
    .mobile-edit-btn {
      display: none;
      padding: 10px 16px;
      background: var(--color-accent);
      color: var(--color-primary);
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
    }

    /* Mobile Input Modal */
    .mobile-input-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    .mobile-input-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-input-modal__content {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.25s ease;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .mobile-input-modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4);
      background: linear-gradient(135deg, var(--color-primary), #001a33);
      color: white;
    }

    .mobile-input-modal__header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .mobile-input-modal__close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
    }

    .mobile-input-modal__body {
      padding: var(--space-4);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .mobile-input-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .mobile-input-group label {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mobile-input-group select {
      padding: var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: 16px;  /* Prevents iOS zoom */
      background: white;
      cursor: pointer;
    }

    .mobile-input-modal__footer {
      padding: var(--space-4);
      border-top: 1px solid var(--color-border);
    }

    .mobile-input-apply {
      width: 100%;
      padding: var(--space-4);
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .mobile-input-apply:hover {
      background: #002952;
    }

    [data-theme="dark"] .mobile-input-modal__content {
      background: var(--color-surface);
    }

    [data-theme="dark"] .mobile-input-group select {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-color: rgba(255, 255, 255, 0.2);
    }

    /* Field Panel - Left sidebar in unified container */
    .field-panel {
      background: var(--color-bg-light);
      border-right: 1px solid var(--color-border);
      padding: var(--space-4);
      overflow-y: auto;
      align-self: stretch;
    }

    [data-theme="dark"] .field-panel {
      background: rgba(30, 35, 44, 0.5);
    }

    .field-panel__section {
      margin-bottom: var(--space-4);
    }

    .field-panel__title {
      font-size: var(--text-overline);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }

    .field {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      margin-bottom: 6px;
      cursor: grab;
      transition: all 0.15s ease;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .field:hover {
      border-color: var(--color-primary);
      background: var(--color-surface);
      box-shadow: 0 2px 8px rgba(0, 51, 102, 0.12);
      transform: translateY(-1px);
    }

    .field:active {
      cursor: grabbing;
      transform: scale(0.98);
    }

    .field.dragging {
      opacity: 0.5;
      transform: scale(0.95);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .field.selected {
      border-color: var(--color-primary);
      background: rgba(0, 51, 102, 0.08);
      box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
    }

    .field__icon {
      font-size: 1rem;
      opacity: 0.8;
    }

    .field--dimension {
      border-left: 3px solid #3B82F6;
    }

    .field--dimension:hover {
      border-left-color: #2563EB;
    }

    .field--measure {
      border-left: 3px solid #10B981;
    }

    .field--measure:hover {
      border-left-color: #059669;
    }

    .field--demographic {
      border-left: 3px solid #8B5CF6;
    }

    .field--demographic:hover {
      border-left-color: #7C3AED;
    }

    /* Workspace - Right side of unified container */
    .explorer__workspace {
      display: flex;
      flex-direction: column;
      padding: var(--space-4);
      background: var(--color-surface);
      overflow: visible;
    }

    /* Drop Zones - Compact row at top */
    .drop-zones {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      overflow: visible;
    }

    @media (max-width: 1100px) {
      .drop-zones {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .drop-zones {
        grid-template-columns: 1fr;
      }
    }

    .drop-zone {
      background: #FFFFFF;
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-2);
      min-height: 70px;
      transition: all 0.2s ease;
      position: relative;
    }

    [data-theme="dark"] .drop-zone {
      background: #1E232C;
    }

    .drop-zone::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      opacity: 0.8;
    }

    .drop-zone--measures {
      border-color: rgba(16, 185, 129, 0.4);
    }

    .drop-zone--measures::before {
      background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
    }

    .drop-zone--group {
      border-color: rgba(139, 92, 246, 0.4);
    }

    .drop-zone--group::before {
      background: linear-gradient(90deg, #8B5CF6 0%, #A78BFA 100%);
    }

    .drop-zone--filter {
      border-color: rgba(245, 158, 11, 0.4);
      overflow: visible;
    }

    .drop-zone--filter::before {
      background: linear-gradient(90deg, #F59E0B 0%, #FBBF24 100%);
    }

    .drop-zone:not(.drop-zone--measures):not(.drop-zone--group):not(.drop-zone--filter)::before {
      background: linear-gradient(90deg, #3B82F6 0%, #60A5FA 100%);
    }

    .drop-zone.drag-over {
      border-style: solid;
      border-color: var(--color-primary);
      background: rgba(0, 51, 102, 0.06);
      transform: scale(1.01);
      box-shadow: 0 4px 20px rgba(0, 51, 102, 0.12);
    }

    .drop-zone--measures.drag-over {
      border-color: #10B981;
      background: rgba(16, 185, 129, 0.08);
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.15);
    }

    .drop-zone--group.drag-over {
      border-color: #8B5CF6;
      background: rgba(139, 92, 246, 0.08);
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.15);
    }

    .drop-zone--filter.drag-over {
      border-color: #F59E0B;
      background: rgba(245, 158, 11, 0.08);
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.15);
    }

    /* Filter Popup */
    .filter-popup {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 280px;
      width: max-content;
      max-width: 340px;
      margin-top: var(--space-2);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      box-shadow: var(--shadow-xl);
      z-index: 100;
      animation: filterPopupIn 0.2s ease-out;
    }

    @keyframes filterPopupIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .filter-popup.active {
      display: block;
    }

    .filter-popup__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--color-border);
    }

    .filter-popup__title {
      font-size: var(--text-body-sm);
      font-weight: 600;
      color: var(--color-text);
    }

    .filter-popup__close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 0;
      line-height: 1;
    }

    .filter-popup__close:hover {
      color: var(--color-text);
    }

    /* Checkbox filter options */
    .filter-options {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      max-height: 280px;
      overflow-y: auto;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      cursor: pointer;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      transition: background var(--duration-fast);
      background: var(--color-bg-light);
    }

    .filter-option:hover {
      background: var(--color-border);
    }

    .filter-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--color-primary);
      cursor: pointer;
      flex-shrink: 0;
    }

    .filter-option__label {
      font-size: 14px;
      color: var(--color-text);
      font-weight: 500;
      white-space: nowrap;
    }

    .filter-option__color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Range slider for Year */
    .filter-slider {
      padding: var(--space-2) 0;
    }

    .filter-slider__inputs {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    .filter-slider__input-group {
      flex: 1;
      min-width: 0;
    }

    .filter-slider__input-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }

    .filter-slider__select {
      width: 100%;
      min-width: 100px;
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      color: var(--color-text);
      font-size: var(--text-body);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M3 4.5L6 7.5L9 4.5'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }

    .filter-slider__select:hover {
      border-color: var(--color-primary);
    }

    .filter-slider__select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
    }

    .filter-slider__arrow {
      font-size: 1.25rem;
      color: var(--color-text-secondary);
      flex-shrink: 0;
    }

    .filter-popup__actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-3);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-border);
    }

    .filter-popup__btn {
      flex: 1;
      padding: var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-caption);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .filter-popup__btn--apply {
      background: var(--color-primary);
      color: white;
      border: none;
    }

    .filter-popup__btn--apply:hover {
      background: var(--color-primary-dark);
    }

    .filter-popup__btn--clear {
      background: none;
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
    }

    .filter-popup__btn--clear:hover {
      background: var(--color-bg-light);
      color: var(--color-text);
    }

    /* Active filter indicator */
    .filter-active-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      background: rgba(255, 255, 255, 0.25);
      color: white;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 600;
      margin-left: var(--space-1);
    }

    .drop-zone--filter {
      position: relative;
    }

    .drop-zone__label {
      font-size: var(--text-caption);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }

    .drop-zone__content {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
      min-height: 32px;
    }

    .drop-zone__placeholder {
      color: var(--color-text-secondary);
      font-size: var(--text-caption);
      font-style: italic;
    }

    .dropped-field {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: linear-gradient(135deg, var(--color-primary) 0%, #004080 100%);
      color: white;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 51, 102, 0.2);
      transition: all var(--duration-fast);
    }

    .dropped-field:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 51, 102, 0.25);
    }

    /* Clickable filter field */
    .dropped-field--filter {
      cursor: pointer;
      padding-right: 6px;
    }

    .dropped-field--filter:hover {
      background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
    }

    .dropped-field__edit {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      font-size: 10px;
      margin-left: 2px;
    }

    .dropped-field__remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      line-height: 1;
      transition: all var(--duration-fast);
    }

    .dropped-field__remove:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Chart Type Selector */
    .chart-type-selector {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--color-bg-light);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      width: fit-content;
    }

    .chart-type-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 36px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 1.25rem;
      transition: all 0.15s ease;
      color: var(--color-text-secondary);
    }

    .chart-type-btn:hover {
      background: var(--color-surface);
      color: var(--color-primary);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .chart-type-btn.active {
      background: var(--color-primary);
      color: white;
      box-shadow: 0 2px 4px rgba(0, 51, 102, 0.2);
    }

    /* Control bar styling */
    .explorer__controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-2);
      padding: var(--space-2) 0;
    }

    .explorer__actions {
      display: flex;
      gap: var(--space-2);
    }

    /* Explorer Chart Area - Fills remaining space in workspace */
    .explorer-chart-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #FFFFFF;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--color-border);
    }

    [data-theme="dark"] .explorer-chart-area {
      background: #1E232C;
    }

    .explorer-chart-area__toolbar {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) var(--space-3);
      background: rgba(0, 51, 102, 0.05);
      border-bottom: 1px solid var(--color-border);
    }

    [data-theme="dark"] .explorer-chart-area__toolbar {
      background: rgba(255, 255, 255, 0.03);
    }

    .chart-type-selector {
      display: flex;
      gap: var(--space-1);
    }

    .chart-type-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.15s ease;
    }

    .chart-type-btn:hover {
      border-color: var(--color-primary);
      background: rgba(0, 51, 102, 0.05);
    }

    .chart-type-btn.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }

    /* Chart Preview - Large and expanding */
    .chart-preview {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: var(--space-4);
      min-height: 450px;
    }

    .chart-preview__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    .chart-preview__title {
      font-size: var(--text-h3);
      color: var(--color-primary);
    }

    .chart-preview__actions {
      display: flex;
      gap: var(--space-2);
    }

    .chart-preview__content {
      flex: 1;
      width: 100%;
      min-height: 350px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-2);
      background: #FFFFFF;
      border-radius: var(--radius-md);
    }

    [data-theme="dark"] .chart-preview__content {
      background: #1E232C;
    }

    .chart-preview__empty {
      text-align: center;
      color: var(--color-text-secondary);
    }

    .chart-preview__empty-icon {
      font-size: 4rem;
      opacity: 0.3;
      margin-bottom: var(--space-2);
    }

    .chart-preview__empty-text {
      font-size: var(--text-body);
    }

    .chart-preview__empty-hint {
      font-size: var(--text-caption);
      margin-top: var(--space-1);
    }

    /* Reset & Export Buttons */
    .explorer__reset,
    .explorer__export {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .explorer__reset:hover {
      border-color: var(--color-error);
      color: var(--color-error);
      background: rgba(220, 38, 38, 0.05);
    }

    .explorer__export {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }

    .explorer__export:hover {
      background: #004080;
      border-color: #004080;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 51, 102, 0.2);
    }

    .explorer__fullscreen {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 51, 102, 0.1);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .explorer__fullscreen:hover {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }

    /* Fullscreen Mode - TRUE fullscreen covering entire viewport */
    .explorer-section--fullscreen {
      position: fixed !important;
      inset: 0 !important;
      z-index: 9999 !important;
      background: var(--color-surface) !important;
      padding: 0 !important;
      margin: 0 !important;
      overflow: hidden !important;
      animation: fullscreenIn 0.25s ease;
      display: flex !important;
      flex-direction: column !important;
    }

    .explorer-section--fullscreen .explorer-card {
      max-width: none;
      margin: 0;
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      border-radius: 0;
      border: none;
      box-shadow: none;
    }

    .explorer-section--fullscreen .explorer {
      flex: 1;
      height: calc(100vh - 60px);
    }

    .explorer-section--fullscreen .explorer__workspace {
      height: 100%;
    }

    .explorer-section--fullscreen .chart-preview {
      min-height: 500px;
      flex: 1;
    }

    .explorer-section--fullscreen .chart-preview__content {
      min-height: 450px;
    }

    .explorer-section--fullscreen .explorer__fullscreen {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 10001;
      background: var(--color-accent);
      border-color: var(--color-accent);
      color: var(--color-primary);
      width: 44px;
      height: 44px;
      font-size: 24px;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .explorer-section--fullscreen .explorer__fullscreen:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    @keyframes fullscreenIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    body.fullscreen-active {
      overflow: hidden !important;
    }

    /* Hide EVERYTHING except the fullscreen explorer */
    body.fullscreen-active .nav,
    body.fullscreen-active .page-header,
    body.fullscreen-active .page-footer,
    body.fullscreen-active footer,
    body.fullscreen-active .ir-hero,
    body.fullscreen-active .disclaimer-banner,
    body.fullscreen-active .stats-grid,
    body.fullscreen-active .dashboard-section,
    body.fullscreen-active .ir-content-section > .container:not(.explorer-section),
    body.fullscreen-active .page-background {
      display: none !important;
    }

    /* Make sure fullscreen explorer is on top of everything */
    body.fullscreen-active .explorer-section--fullscreen {
      z-index: 99999 !important;
    }

    /* Multi-Chart Comparison Mode (Fullscreen Only) */
    .comparison-toolbar {
      display: none;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-4);
      padding-top: 40px; /* Much larger safe area */
      background: linear-gradient(135deg, var(--color-primary), #001a33);
      margin-bottom: 0;
      flex-shrink: 0;
      height: 100px; /* Taller for safe area */
      box-sizing: border-box;
      position: relative;
      z-index: 100000;
    }

    .explorer-section--fullscreen .comparison-toolbar {
      display: flex;
    }

    .panel-count-selector {
      display: flex;
      gap: 10px;
    }

    .panel-count-btn {
      padding: 10px 24px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .panel-count-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }

    .panel-count-btn.active {
      background: var(--color-accent);
      border-color: var(--color-accent);
      color: var(--color-primary);
      box-shadow: 0 2px 8px rgba(255, 184, 28, 0.4);
    }

    .comparison-title {
      color: white;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    /* Multi-Panel Grid - fills remaining viewport height */
    .comparison-grid {
      display: none;
      gap: var(--space-3);
      flex: 1;
      padding: var(--space-3);
      background: linear-gradient(180deg, rgba(0, 51, 102, 0.03), rgba(0, 51, 102, 0.08));
      height: calc(100vh - 100px); /* Adjusted for taller toolbar */
      box-sizing: border-box;
      overflow: hidden;
    }

    .explorer-section--fullscreen .comparison-grid {
      display: grid;
    }

    .explorer-section--fullscreen.panels-1 .comparison-grid {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr;
    }

    .explorer-section--fullscreen.panels-2 .comparison-grid {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr;
    }

    .explorer-section--fullscreen.panels-4 .comparison-grid {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    .comparison-panel {
      display: none;
      flex-direction: column;
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: box-shadow 0.2s ease;
    }

    .comparison-panel:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .explorer-section--fullscreen.panels-1 .comparison-panel:nth-child(1),
    .explorer-section--fullscreen.panels-2 .comparison-panel:nth-child(-n+2),
    .explorer-section--fullscreen.panels-4 .comparison-panel {
      display: flex;
    }

    .panel-header {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 12px 16px;
      background: linear-gradient(180deg, rgba(0, 51, 102, 0.06), rgba(0, 51, 102, 0.02));
      border-bottom: 1px solid var(--color-border);
      align-items: center;
      flex-shrink: 0;
    }

    .panel-header select {
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: 13px;
      background: white;
      cursor: pointer;
      font-weight: 500;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .panel-header select:hover {
      border-color: var(--color-primary);
    }

    .panel-header select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
    }

    /* Chart area fills remaining panel space - CRITICAL for zoom-to-fit */
    .panel-chart-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      min-height: 0;
      overflow: hidden;
      position: relative;
    }

    .panel-chart-area svg {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
    }

    /* Hide main explorer and other elements in fullscreen */
    .explorer-section--fullscreen .explorer {
      display: none !important;
    }

    .explorer-section--fullscreen .explorer__controls {
      display: none !important;
    }

    .explorer-section--fullscreen .executive-insights,
    .explorer-section--fullscreen .preset-quick-views {
      display: none !important;
    }

    .explorer-section--fullscreen .explorer__source-bar {
      display: none !important;
    }

    .explorer-section--fullscreen .explorer-unified {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
      overflow: hidden !important;
    }

    /* Dark mode adjustments for comparison panels */
    [data-theme="dark"] .panel-header {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
    }

    [data-theme="dark"] .panel-header select {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-color: rgba(255, 255, 255, 0.2);
    }

    [data-theme="dark"] .comparison-grid {
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.3));
    }

    [data-theme="dark"] .comparison-panel {
      background: rgba(30, 30, 40, 0.95);
    }

    /* Executive Insights Panel */
    .executive-insights {
      margin-top: var(--space-3);
      padding: var(--space-3);
      background: linear-gradient(135deg, rgba(0, 51, 102, 0.05) 0%, rgba(255, 184, 28, 0.05) 100%);
      border: 1px solid rgba(0, 51, 102, 0.1);
      border-radius: var(--radius-md);
    }

    .executive-insights__title {
      font-size: 13px;
      font-weight: 700;
      color: var(--color-primary);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .executive-insights__list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .executive-insights__item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      color: var(--color-text-secondary);
      line-height: 1.4;
    }

    .insight-icon {
      flex-shrink: 0;
      font-size: 14px;
    }

    .insight-highlight {
      font-weight: 600;
      color: var(--color-text);
    }

    .insight-positive {
      color: #10B981;
    }

    .insight-negative {
      color: #EF4444;
    }

    .insight-neutral {
      color: var(--color-accent);
    }

    [data-theme="dark"] .executive-insights {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 184, 28, 0.03) 100%);
      border-color: rgba(255, 255, 255, 0.1);
    }

    /* Preset Quick Views */
    .preset-views {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: var(--space-3);
    }

    .preset-btn {
      padding: 8px 14px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      border-radius: var(--radius-md);
      font-size: 12px;
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .preset-btn:hover {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }

    .preset-btn.active {
      background: var(--color-accent);
      border-color: var(--color-accent);
      color: var(--color-primary);
    }

    /* Export Report Preview Modal */
    .export-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      padding: var(--space-4);
    }

    .export-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .export-modal__content {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .export-modal.active .export-modal__content {
      transform: scale(1) translateY(0);
    }

    /* Report Header */
    .report-header {
      background: linear-gradient(135deg, var(--color-primary) 0%, #004080 100%);
      color: white;
      padding: var(--space-4) var(--space-5);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      position: relative;
    }

    .report-header__left {
      flex: 1;
    }

    .report-header__logo {
      font-size: 12px;
      font-weight: 200;
      letter-spacing: 0.2em;
      opacity: 0.8;
      margin-bottom: var(--space-1);
    }

    .report-header__title {
      font-size: var(--text-h3);
      font-weight: 700;
      margin-bottom: var(--space-1);
    }

    .report-header__subtitle {
      font-size: var(--text-body-sm);
      opacity: 0.9;
    }

    .report-header__right {
      text-align: right;
    }

    .report-header__date {
      font-size: 12px;
      opacity: 0.8;
    }

    .report-header__close {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .report-header__close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Report Body */
    .report-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4) var(--space-5);
    }

    /* Demo Banner */
    .report-demo-banner {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border: 1px solid #F59E0B;
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-bottom: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .report-demo-banner__icon {
      font-size: 1.5rem;
    }

    .report-demo-banner__text {
      flex: 1;
    }

    .report-demo-banner__title {
      font-weight: 700;
      color: #92400E;
      font-size: var(--text-body-sm);
    }

    .report-demo-banner__desc {
      color: #B45309;
      font-size: 12px;
    }

    /* Report Metadata */
    .report-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      padding: var(--space-3);
      background: var(--color-bg-light);
      border-radius: var(--radius-md);
    }

    .report-meta__item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .report-meta__label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-secondary);
    }

    .report-meta__value {
      font-size: var(--text-body-sm);
      font-weight: 500;
      color: var(--color-text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .report-meta__badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 600;
    }

    .report-meta__badge--dimension {
      background: rgba(59, 130, 246, 0.1);
      color: #2563EB;
    }

    .report-meta__badge--measure {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
    }

    .report-meta__badge--filter {
      background: rgba(245, 158, 11, 0.1);
      color: #D97706;
    }

    /* Report Chart */
    .report-chart {
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }

    .report-chart__title {
      font-size: var(--text-body-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .report-chart__container {
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Report Data Table */
    .report-table {
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .report-table__title {
      font-size: var(--text-body-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
      padding: var(--space-3) var(--space-4);
      background: var(--color-bg-light);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--color-border);
    }

    .report-table__container {
      max-height: 250px;
      overflow-y: auto;
    }

    .report-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .report-table th {
      background: var(--color-bg-light);
      font-weight: 600;
      text-align: left;
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--color-border);
      position: sticky;
      top: 0;
    }

    .report-table td {
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }

    .report-table tr:hover td {
      background: rgba(0, 51, 102, 0.02);
    }

    .report-table td:first-child {
      font-weight: 500;
    }

    .report-table td:last-child {
      text-align: right;
      font-family: 'SF Mono', Monaco, monospace;
    }

    /* Report Footer */
    .report-footer {
      padding: var(--space-3) var(--space-5);
      background: var(--color-bg-light);
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .report-footer__info {
      font-size: 12px;
      color: var(--color-text-secondary);
    }

    .report-footer__actions {
      display: flex;
      gap: var(--space-2);
    }

    .report-footer__btn {
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .report-footer__btn--secondary {
      background: white;
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
    }

    .report-footer__btn--secondary:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .report-footer__btn--primary {
      background: var(--color-primary);
      border: 1px solid var(--color-primary);
      color: white;
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .export-modal__content {
        max-height: 95vh;
      }
      .report-header {
        flex-direction: column;
        gap: var(--space-2);
      }
      .report-header__right {
        text-align: left;
      }
      .report-meta {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Explorer SVG Chart - Large and responsive */
    .explorer-chart-svg {
      width: 100%;
      height: auto;
      min-height: 320px;
      display: block;
    }

    .chart-preview__content svg {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <!-- Mountain Background -->
  <div class="page-background" aria-hidden="true"></div>


  <!-- Stars for Dark Mode -->
  <div class="data-stars" aria-hidden="true">
    <!-- Stars generated by JS -->
  </div>

  <!-- Navigation (Standard across all pages) -->
  <nav class="nav">
    <div class="container nav__inner">
      <a href="index.html" class="nav__logo">HORIZON</a>
      <ul class="nav__links">
        <li><a href="programs.html" class="nav__link">Programs</a></li>
        <li><a href="admission.html" class="nav__link">Admission</a></li>
        <li><a href="campus.html" class="nav__link">Campus</a></li>
        <li><a href="data.html" class="nav__link nav__link--active">Data</a></li>
        <li><a href="about.html" class="nav__link">About</a></li>
      </ul>
      <div class="nav__actions">
        <button class="nav__search" id="searchTrigger" aria-label="Search">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
          </svg>
        </button>
        <button class="season-toggle" id="seasonToggle" aria-label="Toggle season" title="Toggle Fall/Winter">
          <span class="season-toggle__icon"></span>
        </button>
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode" title="Toggle dark mode">
          <span class="theme-toggle__icon"></span>
        </button>
        <a href="admission.html" class="nav__cta">Apply Now</a>
        <button class="nav__hamburger" aria-label="Menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile Navigation -->
  <div class="mobile-nav__backdrop"></div>
  <nav class="mobile-nav">
    <div class="mobile-nav__close">
      <span class="mobile-nav__close-title">Menu</span>
      <button class="mobile-nav__close-btn" aria-label="Close menu"></button>
    </div>
    <ul class="mobile-nav__links">
      <li><a href="index.html" class="mobile-nav__link">Home</a></li>
      <li><a href="programs.html" class="mobile-nav__link">Programs</a></li>
      <li><a href="admission.html" class="mobile-nav__link">Admission</a></li>
      <li><a href="campus.html" class="mobile-nav__link">Campus</a></li>
      <li><a href="about.html" class="mobile-nav__link">About</a></li>
      <li><a href="data.html" class="mobile-nav__link">Data</a></li>
    </ul>
    <a href="admission.html" class="mobile-nav__cta">Apply Now</a>
  </nav>

  <!-- Hero Section -->
  <section class="ir-hero">
    <div class="container ir-hero__content">
      <!-- Disclaimer Banner -->
      <div class="disclaimer-banner">
        <span class="disclaimer-banner__icon"></span>
        <div class="disclaimer-banner__content">
          <div class="disclaimer-banner__title">Demonstration Only</div>
          <p class="disclaimer-banner__text">
            Data has been scraped from public sources (IPEDS, NCES, DataUSA) with best attempt at accuracy but has not been validated. This is a prototype visualization, not an official institutional resource.
          </p>
        </div>
      </div>
      <div class="ir-hero__badge">
        <span></span>
        <span>Institutional Research</span>
      </div>
      <h1 class="ir-hero__title">Fort Lewis College Data & Analytics</h1>
      <p class="ir-hero__subtitle">
        Explore enrollment trends, demographic insights, and key institutional metrics.
        Real data, beautifully visualized.
      </p>
    </div>
  </section>

  <!-- Main Content (Semi-transparent overlay) -->
  <main class="ir-content-section">

  <!-- Stats Cards -->
  <section class="container">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card__value" id="totalEnrollment">3,413</div>
        <div class="stat-card__label">Total Enrollment (2023-24)</div>
        <div class="stat-card__trend stat-card__trend--up">
          <span></span>
          <span>+0.4% from last year</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value">63%</div>
        <div class="stat-card__label">Retention Rate</div>
        <div class="stat-card__trend stat-card__trend--down">
          <span></span>
          <span>-3% from median</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value">43%</div>
        <div class="stat-card__label">6-Year Graduation Rate</div>
        <div class="stat-card__trend stat-card__trend--up">
          <span></span>
          <span>+9% vs peers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value">13:1</div>
        <div class="stat-card__label">Student-Faculty Ratio</div>
        <div class="stat-card__trend">
          <span></span>
          <span>Small class sizes</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value">43%</div>
        <div class="stat-card__label">First-Generation Students</div>
        <div class="stat-card__trend stat-card__trend--up">
          <span></span>
          <span>Above national avg</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value">52%</div>
        <div class="stat-card__label">Students of Color</div>
        <div class="stat-card__trend stat-card__trend--up">
          <span></span>
          <span>Diverse campus</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value">47%</div>
        <div class="stat-card__label">In-State (Colorado)</div>
        <div class="stat-card__trend">
          <span></span>
          <span>53% out-of-state</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value">93%</div>
        <div class="stat-card__label">Acceptance Rate (2023-24)</div>
        <div class="stat-card__trend stat-card__trend--up">
          <span></span>
          <span>Accessible admission</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard Section with Tabs -->
  <section class="dashboard">
    <div class="container">
      <!-- Tab Navigation -->
      <div class="ir-tabs" role="tablist">
        <button class="ir-tab active" data-tab="dashboard" role="tab" aria-selected="true">Dashboard</button>
        <button class="ir-tab" data-tab="tables" role="tab" aria-selected="false">Data Tables</button>
        <button class="ir-tab" data-tab="explorer" role="tab" aria-selected="false">Data Explorer</button>
      </div>

      <!-- TAB 1: Dashboard -->
      <div class="ir-tab-content active" id="tab-dashboard" role="tabpanel">
        <div class="dashboard__header">
          <h2 class="dashboard__title">Enrollment Trends</h2>
          <div class="dashboard__controls">
            <button class="control-btn active" data-view="total">Total</button>
            <button class="control-btn" data-view="gender">By Gender</button>
            <button class="control-btn" data-view="status">By Status</button>
          </div>
        </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Enrollment Over Time (2015-2024)</h3>
          <div class="chart-legend" id="chartLegend">
            <div class="legend-item">
              <span class="legend-dot" style="background: var(--color-primary);"></span>
              <span>Total Enrollment</span>
            </div>
          </div>
        </div>
        <div style="position: relative;">
          <svg class="chart-svg" id="enrollmentChart" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
            <!-- Grid lines -->
            <g class="chart-grid">
              <line class="chart-grid-line" x1="60" y1="40" x2="780" y2="40"/>
              <line class="chart-grid-line" x1="60" y1="105" x2="780" y2="105"/>
              <line class="chart-grid-line" x1="60" y1="170" x2="780" y2="170"/>
              <line class="chart-grid-line" x1="60" y1="235" x2="780" y2="235"/>
            </g>
            <!-- Y-axis labels - dynamically generated -->
            <g class="chart-y-axis" id="yAxisLabels">
              <!-- Generated by JS based on current view -->
            </g>
            <!-- X-axis labels -->
            <g class="chart-x-axis" id="xAxisLabels">
              <!-- Generated by JS -->
            </g>
            <!-- Chart content area -->
            <g id="chartContent">
              <!-- Generated by JS -->
            </g>
          </svg>
          <div class="chart-tooltip" id="chartTooltip"></div>
        </div>
      </div>

      <!-- Demographics -->
      <div class="dashboard__header">
        <h2 class="dashboard__title">Student Demographics (2023-24)</h2>
      </div>

      <div class="demographics-grid">
        <!-- Race/Ethnicity Donut -->
        <div class="chart-container">
          <h3 class="chart-title">Race & Ethnicity</h3>
          <div class="donut-chart-container">
            <svg class="donut-svg" viewBox="0 0 200 200" id="ethnicityChart">
              <!-- Generated by JS -->
            </svg>
            <div class="demographics-legend" id="ethnicityLegend">
              <!-- Generated by JS -->
            </div>
          </div>
        </div>

        <!-- Gender Donut -->
        <div class="chart-container">
          <h3 class="chart-title">Gender Distribution</h3>
          <div class="donut-chart-container">
            <svg class="donut-svg" viewBox="0 0 200 200" id="genderChart">
              <!-- Generated by JS -->
            </svg>
            <div class="demographics-legend" id="genderLegend">
              <!-- Generated by JS -->
            </div>
          </div>
        </div>

        <!-- Pell Eligible Donut -->
        <div class="chart-container">
          <h3 class="chart-title">Pell Eligible</h3>
          <div class="donut-chart-container">
            <svg class="donut-svg" viewBox="0 0 200 200" id="pellChart">
              <!-- Generated by JS -->
            </svg>
            <div class="demographics-legend" id="pellLegend">
              <!-- Generated by JS -->
            </div>
          </div>
        </div>

        <!-- First-Generation Donut -->
        <div class="chart-container">
          <h3 class="chart-title">First-Generation</h3>
          <div class="donut-chart-container">
            <svg class="donut-svg" viewBox="0 0 200 200" id="firstGenChart">
              <!-- Generated by JS -->
            </svg>
            <div class="demographics-legend" id="firstGenLegend">
              <!-- Generated by JS -->
            </div>
          </div>
        </div>
      </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-card__icon"></div>
            <div class="metric-card__value">27%</div>
            <div class="metric-card__label">Native American Students</div>
          </div>
          <div class="metric-card">
            <div class="metric-card__icon"></div>
            <div class="metric-card__value">62%</div>
            <div class="metric-card__label">Out-of-State Students</div>
          </div>
          <div class="metric-card">
            <div class="metric-card__icon"></div>
            <div class="metric-card__value">42%</div>
            <div class="metric-card__label">Pell Eligible</div>
          </div>
          <div class="metric-card">
            <div class="metric-card__icon"></div>
            <div class="metric-card__value">60+</div>
            <div class="metric-card__label">Degree Programs</div>
          </div>
        </div>

        <div class="data-source">
          <span class="data-source__icon"></span>
          <span>Data sourced from IPEDS, FLC Institutional Research, and official fact sheets</span>
        </div>
      </div><!-- End TAB 1: Dashboard -->

      <!-- TAB 2: Data Tables -->
      <div class="ir-tab-content" id="tab-tables" role="tabpanel">
        <div class="dashboard__header" style="margin-bottom: var(--space-4);">
          <h2 class="dashboard__title">Granular Data Tables</h2>
          <div class="dashboard__controls">
            <button class="control-btn active" data-table-source="enrollment">Enrollment</button>
            <button class="control-btn" data-table-source="demographics">Demographics</button>
            <button class="control-btn" data-table-source="admissions">Admissions</button>
            <button class="control-btn" data-table-source="expenses">Expenses</button>
          </div>
        </div>

        <!-- Enrollment Data Table -->
        <div class="chart-container data-table-section active" id="table-enrollment">
          <h3 class="chart-title">Enrollment by Year (CDS Data)</h3>
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Total</th>
                  <th>Male</th>
                  <th>Female</th>
                  <th>Full-Time</th>
                  <th>Part-Time</th>
                  <th>YoY Change</th>
                </tr>
              </thead>
              <tbody id="dataTableBody">
                <!-- Generated by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Demographics/Ethnicity Table -->
        <div class="chart-container data-table-section" id="table-demographics" style="display: none;">
          <h3 class="chart-title">Race/Ethnicity by Year (CDS B2 Data)</h3>
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>White</th>
                  <th>Native American</th>
                  <th>Hispanic</th>
                  <th>Two or More</th>
                  <th>Black</th>
                  <th>Asian</th>
                  <th>Other</th>
                </tr>
              </thead>
              <tbody id="ethnicityTableBody">
                <!-- Generated by JS -->
              </tbody>
            </table>
          </div>
          <h3 class="chart-title" style="margin-top: var(--space-4);">Gender & Status Breakdown (Current Year)</h3>
          <div class="data-table-container">
            <table class="data-table" id="demographicsTable">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Count</th>
                  <th>Percentage</th>
                </tr>
              </thead>
              <tbody id="demographicsTableBody">
                <!-- Generated by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Admissions Table -->
        <div class="chart-container data-table-section" id="table-admissions" style="display: none;">
          <h3 class="chart-title">Admissions Funnel by Year (CDS C Data)</h3>
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Applied</th>
                  <th>Admitted</th>
                  <th>Enrolled</th>
                  <th>Accept Rate</th>
                  <th>Yield Rate</th>
                </tr>
              </thead>
              <tbody id="admissionsTableBody">
                <!-- Generated by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Expenses Table -->
        <div class="chart-container data-table-section" id="table-expenses" style="display: none;">
          <h3 class="chart-title">Tuition & Expenses by Year (CDS G Data)</h3>
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>In-State Tuition</th>
                  <th>Out-of-State Tuition</th>
                  <th>Room & Board</th>
                  <th>Total (In-State)</th>
                  <th>Total (Out-of-State)</th>
                </tr>
              </thead>
              <tbody id="expensesTableBody">
                <!-- Generated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div><!-- End TAB 2: Data Tables -->

      <!-- TAB 3: Data Explorer -->
      <div class="ir-tab-content explorer-section panels-1" id="tab-explorer" role="tabpanel">
        <!-- Comparison Toolbar (visible in fullscreen only) -->
        <div class="comparison-toolbar">
          <div class="comparison-title"> Multi-Chart Comparison</div>
          <div class="panel-count-selector">
            <button class="panel-count-btn active" data-panels="1">1 Panel</button>
            <button class="panel-count-btn" data-panels="2">2 Panels</button>
            <button class="panel-count-btn" data-panels="4">4 Panels</button>
          </div>
          <button class="explorer__fullscreen" id="exitFullscreenBtn" title="Exit Fullscreen"> Exit</button>
        </div>

        <!-- Comparison Grid (fullscreen only) -->
        <div class="comparison-grid">
          <!-- Panel 1 -->
          <div class="comparison-panel" id="compPanel1">
            <div class="panel-header">
              <select class="panel-source" data-panel="1">
                <option value="enrollment"> Enrollment</option>
                <option value="admissions"> Admissions</option>
                <option value="expenses"> Costs</option>
                <option value="ethnicity"> Ethnicity</option>
              </select>
              <select class="panel-rows" data-panel="1">
                <option value="year">Year</option>
                <option value="genderBreakdown">Gender</option>
                <option value="statusBreakdown">Status</option>
                <option value="ethnicityBreakdown">Ethnicity</option>
              </select>
              <select class="panel-cols" data-panel="1">
                <option value="">No Breakdown</option>
                <option value="genderBreakdown">By Gender</option>
                <option value="statusBreakdown" selected>By Status</option>
                <option value="ethnicityBreakdown">By Ethnicity</option>
              </select>
              <select class="panel-chart" data-panel="1">
                <option value="line"> Line</option>
                <option value="bar"> Bar</option>
                <option value="area"> Area</option>
              </select>
            </div>
            <div class="panel-chart-area" id="panelChart1">
              <div style="color: #666; text-align: center; padding: 20px;">Loading chart...</div>
            </div>
          </div>

          <!-- Panel 2 -->
          <div class="comparison-panel" id="compPanel2">
            <div class="panel-header">
              <select class="panel-source" data-panel="2">
                <option value="enrollment"> Enrollment</option>
                <option value="admissions" selected> Admissions</option>
                <option value="expenses"> Costs</option>
                <option value="ethnicity"> Ethnicity</option>
              </select>
              <select class="panel-rows" data-panel="2">
                <option value="year">Year</option>
                <option value="genderBreakdown">Gender</option>
                <option value="statusBreakdown">Status</option>
                <option value="ethnicityBreakdown">Ethnicity</option>
              </select>
              <select class="panel-cols" data-panel="2">
                <option value="" selected>No Breakdown</option>
                <option value="genderBreakdown">By Gender</option>
                <option value="statusBreakdown">By Status</option>
                <option value="ethnicityBreakdown">By Ethnicity</option>
              </select>
              <select class="panel-chart" data-panel="2">
                <option value="line"> Line</option>
                <option value="bar"> Bar</option>
                <option value="area"> Area</option>
              </select>
            </div>
            <div class="panel-chart-area" id="panelChart2"></div>
          </div>

          <!-- Panel 3 -->
          <div class="comparison-panel" id="compPanel3">
            <div class="panel-header">
              <select class="panel-source" data-panel="3">
                <option value="enrollment"> Enrollment</option>
                <option value="admissions"> Admissions</option>
                <option value="expenses" selected> Costs</option>
                <option value="ethnicity"> Ethnicity</option>
              </select>
              <select class="panel-rows" data-panel="3">
                <option value="year">Year</option>
                <option value="genderBreakdown">Gender</option>
                <option value="statusBreakdown">Status</option>
                <option value="ethnicityBreakdown">Ethnicity</option>
              </select>
              <select class="panel-cols" data-panel="3">
                <option value="" selected>No Breakdown</option>
                <option value="genderBreakdown">By Gender</option>
                <option value="statusBreakdown">By Status</option>
                <option value="ethnicityBreakdown">By Ethnicity</option>
              </select>
              <select class="panel-chart" data-panel="3">
                <option value="line"> Line</option>
                <option value="bar"> Bar</option>
                <option value="area"> Area</option>
              </select>
            </div>
            <div class="panel-chart-area" id="panelChart3"></div>
          </div>

          <!-- Panel 4 -->
          <div class="comparison-panel" id="compPanel4">
            <div class="panel-header">
              <select class="panel-source" data-panel="4">
                <option value="enrollment"> Enrollment</option>
                <option value="admissions"> Admissions</option>
                <option value="expenses"> Costs</option>
                <option value="ethnicity" selected> Ethnicity</option>
              </select>
              <select class="panel-rows" data-panel="4">
                <option value="year">Year</option>
                <option value="genderBreakdown">Gender</option>
                <option value="statusBreakdown">Status</option>
                <option value="ethnicityBreakdown">Ethnicity</option>
              </select>
              <select class="panel-cols" data-panel="4">
                <option value="" selected>No Breakdown</option>
                <option value="genderBreakdown">By Gender</option>
                <option value="statusBreakdown">By Status</option>
                <option value="ethnicityBreakdown">By Ethnicity</option>
              </select>
              <select class="panel-chart" data-panel="4">
                <option value="line"> Line</option>
                <option value="bar"> Bar</option>
                <option value="area"> Area</option>
              </select>
            </div>
            <div class="panel-chart-area" id="panelChart4"></div>
          </div>
        </div>

        <!-- Mobile Input Modal -->
        <div class="mobile-input-modal" id="mobileInputModal">
          <div class="mobile-input-modal__content">
            <div class="mobile-input-modal__header">
              <h3>Configure Chart</h3>
              <button class="mobile-input-modal__close" id="closeMobileModal">&times;</button>
            </div>
            <div class="mobile-input-modal__body">
              <div class="mobile-input-group">
                <label>Data Source</label>
                <select id="mobileDataSource">
                  <option value="enrollment">Enrollment</option>
                  <option value="admissions">Admissions</option>
                  <option value="expenses">Costs</option>
                  <option value="ethnicity">Ethnicity</option>
                </select>
              </div>
              <div class="mobile-input-group">
                <label>Rows (X-Axis)</label>
                <select id="mobileRows">
                  <option value="year">Year</option>
                  <option value="genderBreakdown">Gender</option>
                  <option value="statusBreakdown">Status</option>
                </select>
              </div>
              <div class="mobile-input-group">
                <label>Group By</label>
                <select id="mobileCols">
                  <option value="">No Breakdown</option>
                  <option value="genderBreakdown">By Gender</option>
                  <option value="statusBreakdown">By Status</option>
                  <option value="ethnicityBreakdown">By Ethnicity</option>
                </select>
              </div>
              <div class="mobile-input-group">
                <label>Chart Type</label>
                <select id="mobileChartType">
                  <option value="line">Line</option>
                  <option value="bar">Bar</option>
                  <option value="area">Area</option>
                </select>
              </div>
            </div>
            <div class="mobile-input-modal__footer">
              <button class="mobile-input-apply" id="applyMobileInputs">Apply & View Chart</button>
            </div>
          </div>
        </div>

        <!-- Unified Explorer Container (normal mode) -->
        <div class="explorer-unified">
          <!-- Header Bar with Data Source + Actions -->
          <div class="explorer__source-bar">
            <label class="source-selector__label" for="dataSourceSelect">Data Source:</label>
            <select class="source-selector__dropdown" id="dataSourceSelect">
              <option value="enrollment"> Enrollment</option>
              <option value="admissions"> Admissions</option>
              <option value="expenses"> Costs</option>
              <option value="ethnicity"> Ethnicity</option>
            </select>
            <div class="explorer__actions">
              <button class="explorer__fullscreen" id="explorerFullscreen" title="Toggle Fullscreen"></button>
              <button class="explorer__export" id="explorerExport"> Export</button>
              <button class="explorer__reset" id="explorerReset"> Reset</button>
            </div>
            <button class="mobile-edit-btn" id="mobileEditBtn">Edit Inputs</button>
          </div>

          <!-- Main Explorer Body: Left Panel + Right Workspace -->
          <div class="explorer">
          <!-- LEFT: Field Panel (Dimensions + Measures) -->
          <div class="field-panel">
            <div class="field-panel__section" id="dimensionsSection">
              <div class="field-panel__title"> Dimensions</div>
              <div class="field field--dimension" draggable="true" data-field="year" data-type="dimension">
                <span class="field__icon"></span>
                <span>Year</span>
              </div>
              <div class="field field--dimension" draggable="true" data-field="genderBreakdown" data-type="dimension">
                <span class="field__icon"></span>
                <span>Gender</span>
              </div>
              <div class="field field--dimension" draggable="true" data-field="statusBreakdown" data-type="dimension">
                <span class="field__icon"></span>
                <span>Enrollment Status</span>
              </div>
              <div class="field field--dimension" draggable="true" data-field="ethnicityBreakdown" data-type="dimension">
                <span class="field__icon"></span>
                <span>Race/Ethnicity</span>
              </div>
            </div>

            <div class="field-panel__section" id="measuresSection">
              <div class="field-panel__title"> Measures</div>
              <!-- Enrollment measures (default) -->
              <div class="field field--measure measure-enrollment" draggable="true" data-field="total" data-type="measure">
                <span class="field__icon"></span>
                <span>Total Enrollment</span>
              </div>
              <!-- Admissions measures (hidden by default) -->
              <div class="field field--measure measure-admissions" draggable="true" data-field="totalApplied" data-type="measure" style="display: none;">
                <span class="field__icon"></span>
                <span>Applications</span>
              </div>
              <div class="field field--measure measure-admissions" draggable="true" data-field="totalAdmitted" data-type="measure" style="display: none;">
                <span class="field__icon"></span>
                <span>Admitted</span>
              </div>
              <div class="field field--measure measure-admissions" draggable="true" data-field="totalEnrolled" data-type="measure" style="display: none;">
                <span class="field__icon"></span>
                <span>Enrolled Freshmen</span>
              </div>
              <div class="field field--measure measure-admissions" draggable="true" data-field="acceptanceRate" data-type="measure" style="display: none;">
                <span class="field__icon">%</span>
                <span>Acceptance Rate</span>
              </div>
              <div class="field field--measure measure-admissions" draggable="true" data-field="yieldRate" data-type="measure" style="display: none;">
                <span class="field__icon"></span>
                <span>Yield Rate</span>
              </div>
              <!-- Expenses measures (hidden by default) -->
              <div class="field field--measure measure-expenses" draggable="true" data-field="inStateTuition" data-type="measure" style="display: none;">
                <span class="field__icon"></span>
                <span>In-State Tuition</span>
              </div>
              <div class="field field--measure measure-expenses" draggable="true" data-field="outOfStateTuition" data-type="measure" style="display: none;">
                <span class="field__icon"></span>
                <span>Out-of-State Tuition</span>
              </div>
              <div class="field field--measure measure-expenses" draggable="true" data-field="roomBoard" data-type="measure" style="display: none;">
                <span class="field__icon"></span>
                <span>Room & Board</span>
              </div>
            </div>
          </div>

          <!-- RIGHT: Workspace (Drop Zones + Chart) -->
          <div class="explorer__workspace">
            <!-- Preset Quick Views -->
            <div class="preset-views">
              <button class="preset-btn" data-preset="enrollment"> Enrollment Trends</button>
              <button class="preset-btn" data-preset="diversity"> Diversity</button>
              <button class="preset-btn" data-preset="costs"> Costs</button>
              <button class="preset-btn" data-preset="admissions"> Admissions</button>
            </div>
            <!-- Drop Zones Row at TOP -->
            <div class="drop-zones">
              <div class="drop-zone" id="dropRows" data-zone="rows">
                <div class="drop-zone__label"> Rows</div>
                <div class="drop-zone__content" id="dropRowsContent">
                  <span class="drop-zone__placeholder">Dimension</span>
                </div>
              </div>
              <div class="drop-zone drop-zone--group" id="dropCols" data-zone="columns">
                <div class="drop-zone__label"> Group By</div>
                <div class="drop-zone__content" id="dropColsContent">
                  <span class="drop-zone__placeholder">Optional</span>
                </div>
              </div>
              <div class="drop-zone drop-zone--measures" id="dropValues" data-zone="values">
                <div class="drop-zone__label"> Values</div>
                <div class="drop-zone__content" id="dropValuesContent">
                  <span class="drop-zone__placeholder">Measure</span>
                </div>
              </div>
              <div class="drop-zone drop-zone--filter" id="dropFilter" data-zone="filter">
                <div class="drop-zone__label"> Filter</div>
                <div class="drop-zone__content" id="dropFilterContent">
                  <span class="drop-zone__placeholder">Optional</span>
                </div>
                <!-- Filter Popup -->
                <div class="filter-popup" id="filterPopup">
                  <div class="filter-popup__header">
                    <span class="filter-popup__title" id="filterPopupTitle">Filter by Year</span>
                    <button class="filter-popup__close" id="filterPopupClose">&times;</button>
                  </div>
                  <div class="filter-popup__body" id="filterPopupBody"></div>
                  <div class="filter-popup__actions">
                    <button class="filter-popup__btn filter-popup__btn--clear" id="filterClear">Clear</button>
                    <button class="filter-popup__btn filter-popup__btn--apply" id="filterApply">Apply</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Chart Type + Large Chart -->
            <div class="explorer-chart-area">
              <div class="explorer-chart-area__toolbar">
                <div class="chart-type-selector">
                  <button class="chart-type-btn active" data-chart-type="line" title="Line Chart"></button>
                  <button class="chart-type-btn" data-chart-type="bar" title="Bar Chart"></button>
                  <button class="chart-type-btn" data-chart-type="area" title="Area Chart"></button>
                  <button class="chart-type-btn" data-chart-type="donut" title="Donut Chart"></button>
                </div>
                <h3 class="chart-preview__title" id="explorerChartTitle">Chart Preview</h3>
              </div>
              <div class="chart-preview">
                <div class="chart-preview__content" id="explorerChartContent">
                  <div class="chart-preview__empty">
                    <div class="chart-preview__empty-icon"></div>
                    <div class="chart-preview__empty-text">Build your visualization</div>
                    <div class="chart-preview__empty-hint">
                      Drag dimensions & measures to the zones above
                    </div>
                  </div>
                </div>
                <!-- Executive Insights Panel -->
                <div class="executive-insights" id="executiveInsights" style="display: none;">
                  <div class="executive-insights__title">
                    <span></span> Key Insights
                  </div>
                  <ul class="executive-insights__list" id="insightsList">
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- End TAB 3: Data Explorer -->

    </div>
  </section>

  </main><!-- End ir-content-section -->

  <!-- Footer -->
  <footer class="page-footer">
    <div class="container">
      <div class="page-footer__logo">HORIZON</div>
      <p class="page-footer__text">Institutional Research & Data Dashboard</p>
      <div class="page-footer__disclaimer">
        <span></span>
        <span>Prototype  Real data, concept visualization</span>
      </div>
    </div>
  </footer>

  <script>
    // Real FLC Data
    const enrollmentData = {
      years: ['2015-16', '2016-17', '2017-18', '2018-19', '2019-20', '2020-21', '2021-22', '2022-23', '2023-24'],
      total: [3707, 3601, 3332, 3319, 3300, 3469, 3567, 3400, 3413],
      male: [1806, 1796, 1610, 1596, 1514, 1556, 1601, 1517, 1585],
      female: [1901, 1805, 1722, 1723, 1786, 1913, 1966, 1883, 1828],
      fullTime: [3393, 3179, 2921, 2883, 2862, 2904, 2914, 2877, 2826],
      partTime: [301, 412, 379, 389, 358, 455, 535, 431, 487]
    };

    // ALL ethnicities - no lumping (2023-24 data from CDS B2)
    const ethnicityData = [
      { label: 'White', value: 1467, percent: 44.2, color: '#3B82F6' },
      { label: 'Native American', value: 887, percent: 26.7, color: '#FFB81C' },
      { label: 'Hispanic/Latino', value: 484, percent: 14.6, color: '#10B981' },
      { label: 'Two or More', value: 376, percent: 11.3, color: '#8B5CF6' },
      { label: 'Black/African American', value: 39, percent: 1.2, color: '#EF4444' },
      { label: 'Asian', value: 16, percent: 0.5, color: '#06B6D4' },
      { label: 'Pacific Islander', value: 5, percent: 0.2, color: '#F59E0B' },
      { label: 'Unknown/Other', value: 46, percent: 1.4, color: '#6B7280' }
    ];

    // Historical ethnicity data from CDS B2 (Total Undergraduates)
    const ethnicityByYear = {
      years: ['2014-15', '2015-16', '2016-17', '2017-18', '2018-19', '2019-20', '2020-21', '2021-22', '2022-23', '2023-24'],
      white: [2040, 1902, 1779, 1603, 1508, 1430, 1353, 1344, 1330, 1467],
      nativeAmerican: [883, 897, 906, 828, 868, 931, 1103, 1162, 1012, 887],
      hispanic: [385, 395, 391, 367, 363, 383, 433, 448, 450, 484],
      twoOrMore: [228, 243, 268, 283, 345, 337, 339, 376, 365, 376],
      black: [31, 45, 36, 37, 33, 31, 24, 31, 34, 39],
      asian: [24, 24, 21, 21, 20, 19, 11, 13, 22, 16],
      other: [107, 173, 155, 160, 133, 98, 86, 65, 55, 51]  // pacificIslander + unknown + nonresident combined
    };

    // Ethnicity colors for charts (matches ethnicityData order)
    const ethnicityColors = {
      white: '#3B82F6',
      nativeAmerican: '#FFB81C',
      hispanic: '#10B981',
      twoOrMore: '#8B5CF6',
      black: '#EF4444',
      asian: '#06B6D4',
      other: '#6B7280'
    };

    const genderData = [
      { label: 'Female', value: 1828, percent: 53.6, color: '#FFB81C' },
      { label: 'Male', value: 1585, percent: 46.4, color: '#003366' }
    ];

    // Pell Eligible data (42% from CDS)
    const pellData = [
      { label: 'Pell Eligible', value: 42, percent: 42, color: '#FFB81C' },
      { label: 'Not Pell Eligible', value: 58, percent: 58, color: '#003366' }
    ];

    // First-Generation data (43% from institutional data)
    const firstGenData = [
      { label: 'First-Generation', value: 43, percent: 43, color: '#10B981' },
      { label: 'Continuing Gen', value: 57, percent: 57, color: '#003366' }
    ];

    // Extended data from IPEDS, DataUSA, CollegeTuitionCompare
    const extendedData = {
      // Admissions data
      admissions: {
        years: ['2019-20', '2020-21', '2021-22', '2022-23', '2023-24'],
        applicants: [3892, 4102, 4356, 4253, 4986],
        admitted: [3425, 3689, 3876, 3955, 3854],
        enrolled: [812, 798, 845, 795, 751],
        acceptanceRate: [88.0, 89.9, 89.0, 93.0, 77.3],
        yieldRate: [23.7, 21.6, 21.8, 20.1, 19.5]
      },
      // Retention rates (first-year to second-year)
      retention: {
        years: ['2018-19', '2019-20', '2020-21', '2021-22', '2022-23', '2023-24'],
        rates: [65, 62, 67, 64, 63, 63]
      },
      // Graduation rates (6-year)
      graduation: {
        years: ['2017', '2018', '2019', '2020', '2021', '2022'],
        cohortYears: ['2011', '2012', '2013', '2014', '2015', '2016'],
        sixYear: [40, 38, 41, 42, 43, 43],
        fourYear: [24, 22, 26, 28, 29, 30]
      },
      // Financial metrics
      financial: {
        avgNetPrice: 16074,
        inStateTuition: 9958,
        outStateTuition: 21526,
        roomBoard: 12482,
        financialAidPct: 89,
        pellGrantPct: 42,
        loanDefaultRate: 0
      },
      // Academic metrics
      academic: {
        studentFacultyRatio: 15,
        avgClassSize: 22,
        programs: 60,
        campusAcres: 362
      }
    };

    // Chart configuration
    const chartConfig = {
      width: 800,
      height: 300,
      padding: { top: 40, right: 20, bottom: 40, left: 60 }
    };

    // Dynamic Y-axis scales based on view (using round numbers for clean tick marks)
    function getYScaleForView(view) {
      if (view === 'total') return { minY: 2800, maxY: 4000 };  // Range 1200, step 400: 4000, 3600, 3200, 2800
      if (view === 'gender') return { minY: 1400, maxY: 2000 }; // Range 600, step 200: 2000, 1800, 1600, 1400
      if (view === 'status') return { minY: 0, maxY: 3600 };    // Range 3600, step 1200: 3600, 2400, 1200, 0
      return { minY: 0, maxY: 4000 };
    }

    let currentView = 'total';

    // Initialize charts
    function init() {
      renderEnrollmentChart();
      renderDonutChart('ethnicityChart', 'ethnicityLegend', ethnicityData);
      renderDonutChart('genderChart', 'genderLegend', genderData);
      renderDonutChart('pellChart', 'pellLegend', pellData);
      renderDonutChart('firstGenChart', 'firstGenLegend', firstGenData);
      renderDataTable();
      renderDemographicsTable();
      setupEventListeners();
      setupTabs();
      setupTableSourceSelector();
      setupDataExplorer();
      initTheme();
      initSeasonToggle();
      initMobileNav();
    }

    // Render enrollment line chart
    function renderEnrollmentChart() {
      const svg = document.getElementById('chartContent');
      const xLabels = document.getElementById('xAxisLabels');
      const yLabels = document.getElementById('yAxisLabels');
      const legend = document.getElementById('chartLegend');

      svg.innerHTML = '';
      xLabels.innerHTML = '';
      yLabels.innerHTML = '';

      const { years, total, male, female, fullTime, partTime } = enrollmentData;
      const { width, height, padding } = chartConfig;
      const { minY, maxY } = getYScaleForView(currentView);

      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      // X positions
      const xStep = chartWidth / (years.length - 1);
      const xPositions = years.map((_, i) => padding.left + i * xStep);

      // Y scale function
      const scaleY = (val) => {
        const ratio = (val - minY) / (maxY - minY);
        return height - padding.bottom - (ratio * chartHeight);
      };

      // Render Y-axis labels (4 labels)
      const ySteps = 4;
      const yRange = maxY - minY;
      for (let i = 0; i < ySteps; i++) {
        const yVal = maxY - (i * yRange / (ySteps - 1));
        const yPos = padding.top + (i * chartHeight / (ySteps - 1));
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'chart-axis-label');
        text.setAttribute('x', 50);
        text.setAttribute('y', yPos + 4);
        text.setAttribute('text-anchor', 'end');
        text.textContent = yVal.toLocaleString();
        yLabels.appendChild(text);
      }

      // Render X-axis labels
      years.forEach((year, i) => {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'chart-axis-label');
        text.setAttribute('x', xPositions[i]);
        text.setAttribute('y', height - 10);
        text.setAttribute('text-anchor', 'middle');
        text.textContent = year.split('-')[0];
        xLabels.appendChild(text);
      });

      // Determine which lines to draw
      let datasets = [];
      if (currentView === 'total') {
        datasets = [{ data: total, class: 'total', color: 'var(--color-primary)' }];
        legend.innerHTML = '<div class="legend-item"><span class="legend-dot" style="background: var(--color-primary);"></span><span>Total Enrollment</span></div>';
      } else if (currentView === 'gender') {
        datasets = [
          { data: male, class: 'male', color: '#3B82F6' },
          { data: female, class: 'female', color: '#FFB81C' }
        ];
        legend.innerHTML = `
          <div class="legend-item"><span class="legend-dot" style="background: #3B82F6;"></span><span>Male</span></div>
          <div class="legend-item"><span class="legend-dot" style="background: #FFB81C;"></span><span>Female</span></div>
        `;
      } else if (currentView === 'status') {
        datasets = [
          { data: fullTime, class: 'fulltime', color: '#2563EB' },
          { data: partTime, class: 'parttime', color: '#10B981' }
        ];
        legend.innerHTML = `
          <div class="legend-item"><span class="legend-dot" style="background: #2563EB;"></span><span>Full-Time</span></div>
          <div class="legend-item"><span class="legend-dot" style="background: #10B981;"></span><span>Part-Time</span></div>
        `;
      }

      // Draw each dataset
      datasets.forEach(({ data, class: cls, color }) => {
        // Create area path
        const areaPoints = data.map((val, i) => `${xPositions[i]},${scaleY(val)}`);
        const areaPath = `M${areaPoints.join(' L')} L${xPositions[xPositions.length - 1]},${height - padding.bottom} L${xPositions[0]},${height - padding.bottom} Z`;

        const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        area.setAttribute('class', `chart-area chart-area--${cls}`);
        area.setAttribute('d', areaPath);
        area.setAttribute('fill', color);
        svg.appendChild(area);

        // Create line path
        const linePoints = data.map((val, i) => `${xPositions[i]},${scaleY(val)}`);
        const linePath = `M${linePoints.join(' L')}`;

        const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        line.setAttribute('class', `chart-line chart-line--${cls}`);
        line.setAttribute('d', linePath);
        line.setAttribute('stroke', color);

        // Animate line
        const length = line.getTotalLength ? line.getTotalLength() : 1000;
        line.style.strokeDasharray = length;
        line.style.strokeDashoffset = length;
        line.style.animation = 'drawLine 1.5s ease forwards';

        svg.appendChild(line);

        // Create points
        data.forEach((val, i) => {
          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('class', `chart-point chart-point--${cls}`);
          circle.setAttribute('cx', xPositions[i]);
          circle.setAttribute('cy', scaleY(val));
          circle.setAttribute('r', 5);
          circle.setAttribute('stroke', color);
          circle.setAttribute('data-year', years[i]);
          circle.setAttribute('data-value', val.toLocaleString());
          svg.appendChild(circle);
        });
      });

      // Tooltip functionality
      const tooltip = document.getElementById('chartTooltip');
      svg.querySelectorAll('.chart-point').forEach(point => {
        point.addEventListener('mouseenter', (e) => {
          const year = e.target.getAttribute('data-year');
          const value = e.target.getAttribute('data-value');
          tooltip.innerHTML = `<strong>${year}</strong><br>${value} students`;
          tooltip.classList.add('visible');
        });

        point.addEventListener('mousemove', (e) => {
          const rect = svg.getBoundingClientRect();
          tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
          tooltip.style.top = (e.clientY - rect.top - 40) + 'px';
        });

        point.addEventListener('mouseleave', () => {
          tooltip.classList.remove('visible');
        });
      });
    }

    // Render donut chart
    function renderDonutChart(chartId, legendId, data) {
      const svg = document.getElementById(chartId);
      const legend = document.getElementById(legendId);

      svg.innerHTML = '';
      legend.innerHTML = '';

      const total = data.reduce((sum, d) => sum + d.value, 0);
      const centerX = 100;
      const centerY = 100;
      const radius = 70;
      const innerRadius = 45;

      let currentAngle = -90;

      data.forEach((item, index) => {
        const angle = (item.value / total) * 360;
        const startAngle = currentAngle;
        const endAngle = currentAngle + angle;

        // Create arc path
        const path = describeArc(centerX, centerY, radius, innerRadius, startAngle, endAngle);

        const segment = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        segment.setAttribute('class', 'donut-segment');
        segment.setAttribute('d', path);
        segment.setAttribute('fill', item.color);
        segment.setAttribute('data-index', index);
        svg.appendChild(segment);

        currentAngle = endAngle;

        // Create legend item
        const legendItem = document.createElement('div');
        legendItem.className = 'demo-legend-item';
        legendItem.innerHTML = `
          <div class="demo-legend-left">
            <div class="demo-legend-color" style="background: ${item.color};"></div>
            <span class="demo-legend-label">${item.label}</span>
          </div>
          <div>
            <span class="demo-legend-value">${item.value.toLocaleString()}</span>
            <span class="demo-legend-percent">(${item.percent}%)</span>
          </div>
        `;
        legend.appendChild(legendItem);
      });

      // Center text
      const centerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      centerText.setAttribute('class', 'donut-center-text');
      centerText.setAttribute('x', centerX);
      centerText.setAttribute('y', centerY);
      centerText.setAttribute('text-anchor', 'middle');
      centerText.setAttribute('dominant-baseline', 'middle');
      centerText.textContent = total.toLocaleString();
      svg.appendChild(centerText);

      const centerLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      centerLabel.setAttribute('class', 'donut-center-label');
      centerLabel.setAttribute('x', centerX);
      centerLabel.setAttribute('y', centerY + 18);
      centerLabel.setAttribute('text-anchor', 'middle');
      centerLabel.textContent = 'Students';
      svg.appendChild(centerLabel);
    }

    // Helper function to create arc path
    function describeArc(x, y, outerRadius, innerRadius, startAngle, endAngle) {
      const start = polarToCartesian(x, y, outerRadius, endAngle);
      const end = polarToCartesian(x, y, outerRadius, startAngle);
      const innerStart = polarToCartesian(x, y, innerRadius, endAngle);
      const innerEnd = polarToCartesian(x, y, innerRadius, startAngle);
      const largeArcFlag = endAngle - startAngle <= 180 ? 0 : 1;

      return [
        'M', start.x, start.y,
        'A', outerRadius, outerRadius, 0, largeArcFlag, 0, end.x, end.y,
        'L', innerEnd.x, innerEnd.y,
        'A', innerRadius, innerRadius, 0, largeArcFlag, 1, innerStart.x, innerStart.y,
        'Z'
      ].join(' ');
    }

    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
      const angleInRadians = (angleInDegrees) * Math.PI / 180.0;
      return {
        x: centerX + (radius * Math.cos(angleInRadians)),
        y: centerY + (radius * Math.sin(angleInRadians))
      };
    }

    // Render data table
    function renderDataTable() {
      const tbody = document.getElementById('dataTableBody');
      tbody.innerHTML = '';

      const { years, total, male, female, fullTime, partTime } = enrollmentData;

      years.forEach((year, i) => {
        const change = i > 0 ? total[i] - total[i - 1] : 0;
        const changeStr = change > 0 ? `+${change}` : change.toString();
        const changeClass = change > 0 ? 'stat-card__trend--up' : change < 0 ? 'stat-card__trend--down' : '';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${year}</strong></td>
          <td>${total[i].toLocaleString()}</td>
          <td>${male[i].toLocaleString()}</td>
          <td>${female[i].toLocaleString()}</td>
          <td>${fullTime[i].toLocaleString()}</td>
          <td>${partTime[i].toLocaleString()}</td>
          <td class="${changeClass}">${i === 0 ? '' : changeStr}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Event listeners
    function setupEventListeners() {
      document.querySelectorAll('.control-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.dataset.view;
          renderEnrollmentChart();
        });
      });
    }

    // Render demographics table
    function renderDemographicsTable() {
      const tbody = document.getElementById('demographicsTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      // Combine ethnicity and gender data
      const allDemographics = [
        ...ethnicityData.map(d => ({ category: `Race/Ethnicity: ${d.label}`, count: d.value, percent: d.percent })),
        ...genderData.map(d => ({ category: `Gender: ${d.label}`, count: d.value, percent: d.percent }))
      ];

      allDemographics.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.category}</td>
          <td>${item.count.toLocaleString()}</td>
          <td>${item.percent}%</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Render ethnicity table (historical data by year)
    function renderEthnicityTable() {
      const tbody = document.getElementById('ethnicityTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      ethnicityByYear.years.forEach((year, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${year}</strong></td>
          <td>${ethnicityByYear.white[i].toLocaleString()}</td>
          <td>${ethnicityByYear.nativeAmerican[i].toLocaleString()}</td>
          <td>${ethnicityByYear.hispanic[i].toLocaleString()}</td>
          <td>${ethnicityByYear.twoOrMore[i].toLocaleString()}</td>
          <td>${ethnicityByYear.black[i].toLocaleString()}</td>
          <td>${ethnicityByYear.asian[i].toLocaleString()}</td>
          <td>${ethnicityByYear.other[i].toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Render admissions table
    function renderAdmissionsTable() {
      const tbody = document.getElementById('admissionsTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      cdsData.years.forEach((year, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${year}</strong></td>
          <td>${cdsData.admissions.totalApplied[i].toLocaleString()}</td>
          <td>${cdsData.admissions.totalAdmitted[i].toLocaleString()}</td>
          <td>${cdsData.admissions.totalEnrolled[i].toLocaleString()}</td>
          <td>${cdsData.admissions.acceptanceRate[i].toFixed(1)}%</td>
          <td>${cdsData.admissions.yieldRate[i].toFixed(1)}%</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Render expenses table
    function renderExpensesTable() {
      const tbody = document.getElementById('expensesTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      cdsData.years.forEach((year, i) => {
        const inState = cdsData.expenses.inStateTuition[i];
        const outOfState = cdsData.expenses.outOfStateTuition[i];
        const roomBoard = cdsData.expenses.roomBoard[i];
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${year}</strong></td>
          <td>$${inState.toLocaleString()}</td>
          <td>$${outOfState.toLocaleString()}</td>
          <td>$${roomBoard.toLocaleString()}</td>
          <td>$${(inState + roomBoard).toLocaleString()}</td>
          <td>$${(outOfState + roomBoard).toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Table source selector
    function setupTableSourceSelector() {
      const buttons = document.querySelectorAll('[data-table-source]');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const source = btn.dataset.tableSource;

          // Update active button
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Show/hide table sections
          document.querySelectorAll('.data-table-section').forEach(section => {
            section.style.display = 'none';
          });
          const targetSection = document.getElementById(`table-${source}`);
          if (targetSection) {
            targetSection.style.display = 'block';
          }

          // Render the appropriate table if not yet rendered
          if (source === 'demographics') {
            renderEthnicityTable();
            renderDemographicsTable();
          } else if (source === 'admissions') {
            renderAdmissionsTable();
          } else if (source === 'expenses') {
            renderExpensesTable();
          }
        });
      });
    }

    // Tab switching functionality
    function setupTabs() {
      const tabs = document.querySelectorAll('.ir-tab');
      const tabContents = document.querySelectorAll('.ir-tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;

          // Update active tab
          tabs.forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
          });
          tab.classList.add('active');
          tab.setAttribute('aria-selected', 'true');

          // Update active content
          tabContents.forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`tab-${targetTab}`).classList.add('active');
        });
      });
    }

    // CDS Data - Comprehensive Common Data Set parsed from Excel files
    const cdsData = {
      years: ['2014-15', '2017-18', '2018-19', '2019-20', '2020-21', '2021-22', '2022-23', '2023-24'],
      admissions: {
        totalApplied: [2439, 4473, 4198, 3757, 3497, 3795, 4926, 4241],
        totalAdmitted: [2215, 3722, 3817, 3433, 3200, 3520, 4481, 3954],
        totalEnrolled: [779, 706, 756, 761, 813, 960, 848, 778],
        acceptanceRate: [90.8, 83.2, 90.9, 91.4, 91.5, 92.8, 91.0, 93.2],
        yieldRate: [35.2, 19.0, 19.8, 22.2, 25.4, 27.3, 18.9, 19.7]
      },
      expenses: {
        inStateTuition: [5856, 6720, 7056, 7056, 7056, 7056, 7200, 7560],
        outOfStateTuition: [16072, 16872, 17712, 17712, 17712, 17712, 17712, 18688],
        roomBoard: [10680, 11268, 11520, 11704, 11858, 12012, 12554, 13390]
      }
    };

    // Data Explorer - Enhanced with multi-dimension support
    function setupDataExplorer() {
      // Explorer state with 4 zones: rows, columns (group by), values, filter
      const explorerState = {
        rows: null,      // Primary dimension
        columns: null,   // Secondary dimension (group by)
        values: null,    // Measure
        filter: null,    // Filter dimension
        filterValues: null, // Selected filter values (array of selected items or {min, max} for year)
        chartType: 'line',
        dataSource: 'enrollment' // NEW: 'enrollment', 'admissions', or 'expenses'
      };

      // Color palettes
      const colors = {
        primary: ['#2563EB', '#3B82F6', '#60A5FA', '#93C5FD', '#BFDBFE'],
        gender: { male: '#3B82F6', female: '#FFB81C' },
        status: { fullTime: '#2563EB', partTime: '#10B981' },
        ethnicity: ['#3B82F6', '#FFB81C', '#10B981', '#8B5CF6', '#6B7280']
      };

      // Data mappings for dimensions
      const dimensionData = {
        year: {
          labels: enrollmentData.years.map(y => y.split('-')[0]),
          fullLabels: enrollmentData.years
        },
        genderBreakdown: {
          labels: ['Male', 'Female'],
          keys: ['male', 'female'],
          colors: [colors.gender.male, colors.gender.female]
        },
        statusBreakdown: {
          labels: ['Full-Time', 'Part-Time'],
          keys: ['fullTime', 'partTime'],
          colors: [colors.status.fullTime, colors.status.partTime]
        },
        ethnicityBreakdown: {
          labels: ['White', 'Native American', 'Hispanic/Latino', 'Two or More', 'Black', 'Asian', 'Other'],
          keys: ['white', 'nativeAmerican', 'hispanic', 'twoOrMore', 'black', 'asian', 'other'],
          colors: [ethnicityColors.white, ethnicityColors.nativeAmerican, ethnicityColors.hispanic, ethnicityColors.twoOrMore, ethnicityColors.black, ethnicityColors.asian, ethnicityColors.other]
        }
      };

      // DOM references
      const fields = document.querySelectorAll('.field[draggable="true"]');
      const dropRows = document.getElementById('dropRows');
      const dropCols = document.getElementById('dropCols');
      const dropValues = document.getElementById('dropValues');
      const dropFilter = document.getElementById('dropFilter');
      const dropRowsContent = document.getElementById('dropRowsContent');
      const dropColsContent = document.getElementById('dropColsContent');
      const dropValuesContent = document.getElementById('dropValuesContent');
      const dropFilterContent = document.getElementById('dropFilterContent');
      const chartTypeButtons = document.querySelectorAll('.chart-type-btn');
      const resetButton = document.getElementById('explorerReset');
      const exportButton = document.getElementById('explorerExport');
      const fullscreenButton = document.getElementById('explorerFullscreen');
      const explorerSection = document.querySelector('.explorer-section');
      const exportModal = document.getElementById('exportModal');
      const exportModalClose = document.getElementById('exportModalClose');
      const chartContent = document.getElementById('explorerChartContent');
      const chartTitle = document.getElementById('explorerChartTitle');

      // Filter popup elements
      const filterPopup = document.getElementById('filterPopup');
      const filterPopupTitle = document.getElementById('filterPopupTitle');
      const filterPopupBody = document.getElementById('filterPopupBody');
      const filterPopupClose = document.getElementById('filterPopupClose');
      const filterClear = document.getElementById('filterClear');
      const filterApply = document.getElementById('filterApply');

      // Mobile detection
      const isMobile = window.matchMedia('(max-width: 768px)').matches || 'ontouchstart' in window;
      let selectedField = null;

      // Initialize drag events (desktop) and tap events (mobile)
      fields.forEach(field => {
        // Desktop: drag and drop
        field.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', JSON.stringify({
            field: field.dataset.field,
            type: field.dataset.type,
            label: field.querySelector('span:last-child').textContent
          }));
          field.classList.add('dragging');
        });
        field.addEventListener('dragend', () => field.classList.remove('dragging'));

        // Mobile: tap to select, then tap zone to place
        field.addEventListener('click', (e) => {
          if (!isMobile) return;
          e.preventDefault();

          // Deselect all fields
          fields.forEach(f => f.classList.remove('selected'));

          // Select this field
          field.classList.add('selected');
          selectedField = {
            field: field.dataset.field,
            type: field.dataset.type,
            label: field.querySelector('span:last-child').textContent
          };
        });
      });

      // Setup drop zones
      const zones = [
        { el: dropRows, content: dropRowsContent, key: 'rows', accepts: 'dimension', placeholder: 'Drop a dimension here' },
        { el: dropCols, content: dropColsContent, key: 'columns', accepts: 'dimension', placeholder: 'Optional: group/color by' },
        { el: dropValues, content: dropValuesContent, key: 'values', accepts: 'measure', placeholder: 'Drop a measure here' },
        { el: dropFilter, content: dropFilterContent, key: 'filter', accepts: 'dimension', placeholder: 'Optional: filter by' }
      ];

      zones.forEach(zone => {
        // Desktop: drag and drop
        zone.el.addEventListener('dragover', (e) => { e.preventDefault(); zone.el.classList.add('drag-over'); });
        zone.el.addEventListener('dragleave', () => zone.el.classList.remove('drag-over'));
        zone.el.addEventListener('drop', (e) => {
          e.preventDefault();
          zone.el.classList.remove('drag-over');
          try {
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            if (data.type === zone.accepts) {
              explorerState[zone.key] = data;
              updateDropZoneDisplay(zone.content, data, zone.key, zone.placeholder);
              updateExplorerChart();
            }
          } catch (err) { console.error('Drop error:', err); }
        });

        // Mobile: tap zone to place selected field
        zone.el.addEventListener('click', (e) => {
          if (!isMobile || !selectedField) return;
          if (e.target.classList.contains('dropped-field__remove')) return; // Don't interfere with remove button

          if (selectedField.type === zone.accepts) {
            explorerState[zone.key] = selectedField;
            updateDropZoneDisplay(zone.content, selectedField, zone.key, zone.placeholder);
            updateExplorerChart();

            // Clear selection
            fields.forEach(f => f.classList.remove('selected'));
            selectedField = null;
          }
        });
      });

      // Update drop zone UI
      function updateDropZoneDisplay(container, item, stateKey, placeholder) {
        if (!item) {
          container.innerHTML = `<span class="drop-zone__placeholder">${placeholder}</span>`;
          // Hide filter popup and clear filter values when filter is removed
          if (stateKey === 'filter') {
            filterPopup.classList.remove('active');
            explorerState.filterValues = null;
          }
        } else {
          const isFilter = stateKey === 'filter';
          const hasActiveFilter = isFilter && explorerState.filterValues;
          const badge = hasActiveFilter ? '<span class="filter-active-badge"> Active</span>' : '';
          const editIcon = isFilter ? '<span class="dropped-field__edit"></span>' : '';
          const filterClass = isFilter ? ' dropped-field--filter' : '';

          container.innerHTML = `
            <div class="dropped-field${filterClass}" data-field="${item.field}">
              <span>${item.label}${badge}</span>
              ${editIcon}
              <button class="dropped-field__remove" data-key="${stateKey}">&times;</button>
            </div>`;

          // Make filter field clickable to edit
          if (isFilter) {
            const fieldEl = container.querySelector('.dropped-field');
            fieldEl.addEventListener('click', (e) => {
              // Don't trigger if clicking remove button
              if (e.target.classList.contains('dropped-field__remove')) return;
              showFilterPopup(item);
            });
          }

          container.querySelector('.dropped-field__remove').addEventListener('click', (e) => {
            e.stopPropagation();
            explorerState[stateKey] = null;
            if (isFilter) {
              explorerState.filterValues = null;
              filterPopup.classList.remove('active');
            }
            updateDropZoneDisplay(container, null, stateKey, placeholder);
            updateExplorerChart();
          });

          // Show filter popup when a filter dimension is first dropped
          if (isFilter && !explorerState.filterValues) {
            showFilterPopup(item);
          }
        }
      }

      // Show filter popup with appropriate controls based on dimension
      function showFilterPopup(filterDimension) {
        filterPopupTitle.textContent = `Filter by ${filterDimension.label}`;
        filterPopupBody.innerHTML = '';

        if (filterDimension.field === 'year') {
          // Year: show range selector
          const years = enrollmentData.years;
          const currentFilter = explorerState.filterValues || { minIdx: 0, maxIdx: years.length - 1 };

          filterPopupBody.innerHTML = `
            <div class="filter-slider">
              <div class="filter-slider__inputs">
                <div class="filter-slider__input-group">
                  <label class="filter-slider__input-label">From Year</label>
                  <select class="filter-slider__select" id="filterYearMin">
                    ${years.map((y, i) => `<option value="${i}" ${i === currentFilter.minIdx ? 'selected' : ''}>${y}</option>`).join('')}
                  </select>
                </div>
                <span class="filter-slider__arrow"></span>
                <div class="filter-slider__input-group">
                  <label class="filter-slider__input-label">To Year</label>
                  <select class="filter-slider__select" id="filterYearMax">
                    ${years.map((y, i) => `<option value="${i}" ${i === currentFilter.maxIdx ? 'selected' : ''}>${y}</option>`).join('')}
                  </select>
                </div>
              </div>
            </div>
          `;
        } else if (filterDimension.field === 'genderBreakdown') {
          // Gender: checkboxes
          const options = [
            { value: 'male', label: 'Male', color: colors.gender.male },
            { value: 'female', label: 'Female', color: colors.gender.female }
          ];
          const currentFilter = explorerState.filterValues || options.map(o => o.value);

          filterPopupBody.innerHTML = `
            <div class="filter-options">
              ${options.map(opt => `
                <label class="filter-option">
                  <input type="checkbox" value="${opt.value}" ${currentFilter.includes(opt.value) ? 'checked' : ''}>
                  <span class="filter-option__color" style="background: ${opt.color}"></span>
                  <span class="filter-option__label">${opt.label}</span>
                </label>
              `).join('')}
            </div>
          `;
        } else if (filterDimension.field === 'statusBreakdown') {
          // Status: checkboxes
          const options = [
            { value: 'fullTime', label: 'Full-Time', color: colors.status.fullTime },
            { value: 'partTime', label: 'Part-Time', color: colors.status.partTime }
          ];
          const currentFilter = explorerState.filterValues || options.map(o => o.value);

          filterPopupBody.innerHTML = `
            <div class="filter-options">
              ${options.map(opt => `
                <label class="filter-option">
                  <input type="checkbox" value="${opt.value}" ${currentFilter.includes(opt.value) ? 'checked' : ''}>
                  <span class="filter-option__color" style="background: ${opt.color}"></span>
                  <span class="filter-option__label">${opt.label}</span>
                </label>
              `).join('')}
            </div>
          `;
        } else if (filterDimension.field === 'ethnicityBreakdown') {
          // Ethnicity: checkboxes (7 groups to match ethnicityByYear)
          const ethFilterGroups = [
            { label: 'White', color: ethnicityColors.white },
            { label: 'Native American', color: ethnicityColors.nativeAmerican },
            { label: 'Hispanic/Latino', color: ethnicityColors.hispanic },
            { label: 'Two or More', color: ethnicityColors.twoOrMore },
            { label: 'Black', color: ethnicityColors.black },
            { label: 'Asian', color: ethnicityColors.asian },
            { label: 'Other', color: ethnicityColors.other }
          ];
          const currentFilter = explorerState.filterValues || ethFilterGroups.map((_, i) => i);

          filterPopupBody.innerHTML = `
            <div class="filter-options">
              ${ethFilterGroups.map((eth, i) => `
                <label class="filter-option">
                  <input type="checkbox" value="${i}" ${currentFilter.includes(i) ? 'checked' : ''}>
                  <span class="filter-option__color" style="background: ${eth.color}"></span>
                  <span class="filter-option__label">${eth.label}</span>
                </label>
              `).join('')}
            </div>
          `;
        }

        filterPopup.classList.add('active');
      }

      // Filter popup event handlers
      filterPopupClose.addEventListener('click', () => {
        filterPopup.classList.remove('active');
      });

      filterClear.addEventListener('click', () => {
        explorerState.filterValues = null;
        updateDropZoneDisplay(dropFilterContent, explorerState.filter, 'filter', 'Optional: filter by');
        filterPopup.classList.remove('active');
        updateExplorerChart();
      });

      filterApply.addEventListener('click', () => {
        if (!explorerState.filter) return;

        if (explorerState.filter.field === 'year') {
          const minSelect = document.getElementById('filterYearMin');
          const maxSelect = document.getElementById('filterYearMax');
          explorerState.filterValues = {
            minIdx: parseInt(minSelect.value),
            maxIdx: parseInt(maxSelect.value)
          };
        } else {
          const checkboxes = filterPopupBody.querySelectorAll('input[type="checkbox"]:checked');
          if (explorerState.filter.field === 'ethnicityBreakdown') {
            explorerState.filterValues = Array.from(checkboxes).map(cb => parseInt(cb.value));
          } else {
            explorerState.filterValues = Array.from(checkboxes).map(cb => cb.value);
          }
        }

        // Update display to show active badge
        updateDropZoneDisplay(dropFilterContent, explorerState.filter, 'filter', 'Optional: filter by');
        filterPopup.classList.remove('active');
        updateExplorerChart();
      });

      // Click outside to close filter popup
      document.addEventListener('click', (e) => {
        if (filterPopup.classList.contains('active') &&
            !filterPopup.contains(e.target) &&
            !dropFilter.contains(e.target)) {
          filterPopup.classList.remove('active');
        }
      });

      // Chart type selection
      chartTypeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          chartTypeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          explorerState.chartType = btn.dataset.chartType;
          updateExplorerChart();
        });
      });

      // Data Source Dropdown
      const dataSourceSelect = document.getElementById('dataSourceSelect');
      dataSourceSelect.addEventListener('change', () => {
        const newSource = dataSourceSelect.value;
        explorerState.dataSource = newSource;

        // Show/hide relevant measures
        document.querySelectorAll('.measure-enrollment').forEach(el => el.style.display = newSource === 'enrollment' ? '' : 'none');
        document.querySelectorAll('.measure-admissions').forEach(el => el.style.display = newSource === 'admissions' ? '' : 'none');
        document.querySelectorAll('.measure-expenses').forEach(el => el.style.display = newSource === 'expenses' ? '' : 'none');

        // Set default configuration for each data source
        explorerState.rows = { field: 'year', type: 'dimension', label: 'Year' };
        explorerState.filter = null;
        explorerState.filterValues = null;

        // Source-specific defaults so there's always something to show
        if (newSource === 'enrollment') {
          explorerState.values = { field: 'total', type: 'measure', label: 'Total Enrollment' };
          explorerState.columns = { field: 'statusBreakdown', type: 'dimension', label: 'Enrollment Status' };
        } else if (newSource === 'admissions') {
          explorerState.values = { field: 'totalApplied', type: 'measure', label: 'Applications' };
          explorerState.columns = null;
        } else if (newSource === 'expenses') {
          explorerState.values = { field: 'inStateTuition', type: 'measure', label: 'In-State Tuition' };
          explorerState.columns = null;
        }

        // Update drop zones
        updateDropZoneDisplay(dropRowsContent, explorerState.rows, 'rows', 'Drop a dimension here');
        updateDropZoneDisplay(dropColsContent, explorerState.columns, 'columns', 'Optional: group/color by');
        updateDropZoneDisplay(dropValuesContent, explorerState.values, 'values', 'Drop a measure here');
        updateDropZoneDisplay(dropFilterContent, explorerState.filter, 'filter', 'Optional: filter by');
        filterPopup.classList.remove('active');
        updateExplorerChart();
      });

      // Reset button
      resetButton.addEventListener('click', () => {
        explorerState.rows = null;
        explorerState.columns = null;
        explorerState.values = null;
        explorerState.filter = null;
        explorerState.filterValues = null;
        explorerState.chartType = 'line';
        filterPopup.classList.remove('active');
        zones.forEach(z => updateDropZoneDisplay(z.content, null, z.key, z.placeholder));
        chartTypeButtons.forEach(b => b.classList.remove('active'));
        document.querySelector('[data-chart-type="line"]').classList.add('active');
        updateExplorerChart();
      });

      // Fullscreen toggle
      let isFullscreen = false;
      function toggleFullscreen() {
        isFullscreen = !isFullscreen;
        if (isFullscreen) {
          explorerSection.classList.add('explorer-section--fullscreen');
          document.body.classList.add('fullscreen-active');
          fullscreenButton.textContent = '';
          fullscreenButton.title = 'Exit Fullscreen';
          // Render comparison panels
          setTimeout(() => renderAllComparisonPanels(), 100);
        } else {
          explorerSection.classList.remove('explorer-section--fullscreen');
          document.body.classList.remove('fullscreen-active');
          fullscreenButton.textContent = '';
          fullscreenButton.title = 'Toggle Fullscreen';
        }
        // Re-render chart with new dimensions
        setTimeout(() => updateExplorerChart(), 100);
      }

      fullscreenButton.addEventListener('click', toggleFullscreen);

      // Exit fullscreen button in comparison toolbar
      const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
      if (exitFullscreenBtn) {
        exitFullscreenBtn.addEventListener('click', () => {
          if (isFullscreen) toggleFullscreen();
        });
      }

      // ESC key to exit fullscreen
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isFullscreen) {
          toggleFullscreen();
        }
      });

      // ===== MOBILE INPUT MODAL =====
      const mobileModal = document.getElementById('mobileInputModal');
      const mobileEditBtn = document.getElementById('mobileEditBtn');
      const closeMobileBtn = document.getElementById('closeMobileModal');
      const applyMobileBtn = document.getElementById('applyMobileInputs');

      if (mobileEditBtn) {
        mobileEditBtn.addEventListener('click', () => {
          mobileModal.classList.add('active');
          document.body.style.overflow = 'hidden';
        });
      }

      function closeMobileModal() {
        mobileModal.classList.remove('active');
        document.body.style.overflow = '';
      }

      if (closeMobileBtn) closeMobileBtn.addEventListener('click', closeMobileModal);
      if (mobileModal) {
        mobileModal.addEventListener('click', (e) => {
          if (e.target === mobileModal) closeMobileModal();
        });
      }

      if (applyMobileBtn) {
        applyMobileBtn.addEventListener('click', () => {
          // Get values from mobile inputs
          const source = document.getElementById('mobileDataSource').value;
          const rows = document.getElementById('mobileRows').value;
          const cols = document.getElementById('mobileCols').value;
          const chartType = document.getElementById('mobileChartType').value;

          // Sync to main explorer state
          document.getElementById('dataSourceSelect').value = source;
          explorerState.dataSource = source;
          explorerState.rows = rows === 'year' ? 'year' : rows;
          explorerState.columns = cols || null;

          // Update chart type
          chartTypeButtons.forEach(b => b.classList.remove('active'));
          const chartBtn = document.querySelector(`[data-chart-type="${chartType}"]`);
          if (chartBtn) chartBtn.classList.add('active');
          explorerState.chartType = chartType;

          // Render chart
          updateExplorerChart();
          closeMobileModal();
        });
      }

      // ===== MULTI-CHART COMPARISON SYSTEM =====

      // Panel count buttons
      const panelCountBtns = document.querySelectorAll('.panel-count-btn');
      panelCountBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const count = btn.dataset.panels;
          panelCountBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          explorerSection.classList.remove('panels-1', 'panels-2', 'panels-4');
          explorerSection.classList.add(`panels-${count}`);
          setTimeout(() => renderAllComparisonPanels(), 50);
        });
      });

      // Panel selector change handlers
      document.querySelectorAll('.panel-source, .panel-rows, .panel-cols, .panel-chart').forEach(select => {
        select.addEventListener('change', () => {
          const panelNum = select.dataset.panel;
          renderComparisonPanel(panelNum);
        });
      });

      // Build chart data for a specific panel configuration
      function buildPanelChartData(source, rows, cols, chartType) {
        const years = enrollmentData.years.map((_, i) => i);
        const labels = enrollmentData.years.map(y => y.split('-')[0]);
        let series = [];

        // Enrollment data
        if (source === 'enrollment') {
          if (rows === 'year') {
            if (!cols || cols === '') {
              series.push({ label: 'Total', data: years.map(i => enrollmentData.total[i]), color: colors.primary[0] });
            } else if (cols === 'genderBreakdown') {
              series.push({ label: 'Male', data: years.map(i => enrollmentData.male[i]), color: colors.gender.male });
              series.push({ label: 'Female', data: years.map(i => enrollmentData.female[i]), color: colors.gender.female });
            } else if (cols === 'statusBreakdown') {
              series.push({ label: 'Full-Time', data: years.map(i => enrollmentData.fullTime[i]), color: colors.status.fullTime });
              series.push({ label: 'Part-Time', data: years.map(i => enrollmentData.partTime[i]), color: colors.status.partTime });
            } else if (cols === 'ethnicityBreakdown') {
              const ethKeys = ['white', 'nativeAmerican', 'hispanic', 'twoOrMore', 'black', 'asian', 'other'];
              const ethLabels = ['White', 'Native American', 'Hispanic', 'Two+', 'Black', 'Asian', 'Other'];
              const ethColors = [ethnicityColors.white, ethnicityColors.nativeAmerican, ethnicityColors.hispanic, ethnicityColors.twoOrMore, ethnicityColors.black, ethnicityColors.asian, ethnicityColors.other];
              ethKeys.forEach((key, idx) => {
                series.push({ label: ethLabels[idx], data: years.map(i => ethnicityByYear[key][i + 1]), color: ethColors[idx] });
              });
            }
          }
        }

        // Admissions data (from CDS) - always show funnel regardless of breakdown selection
        if (source === 'admissions') {
          const cdsYears = cdsData.years.map(y => y.split('-')[0]);
          // CDS admissions data doesn't have gender/status breakdowns, so always show funnel
          series.push({ label: 'Applied', data: cdsData.admissions.totalApplied, color: '#3B82F6' });
          series.push({ label: 'Admitted', data: cdsData.admissions.totalAdmitted, color: '#10B981' });
          series.push({ label: 'Enrolled', data: cdsData.admissions.totalEnrolled, color: '#FFB81C' });
          return { labels: cdsYears, series, type: 'timeseries' };
        }

        // Expenses data (from CDS)
        if (source === 'expenses') {
          const cdsYears = cdsData.years.map(y => y.split('-')[0]);
          series.push({ label: 'In-State Tuition', data: cdsData.expenses.inStateTuition, color: colors.primary[0] });
          series.push({ label: 'Out-of-State', data: cdsData.expenses.outOfStateTuition, color: colors.primary[1] });
          series.push({ label: 'Room & Board', data: cdsData.expenses.roomBoard, color: colors.primary[2] });
          return { labels: cdsYears, series, type: 'timeseries' };
        }

        // Ethnicity data
        if (source === 'ethnicity') {
          const ethYears = ethnicityByYear.years.map(y => y.split('-')[0]);
          const ethKeys = ['white', 'nativeAmerican', 'hispanic', 'twoOrMore', 'black', 'asian', 'other'];
          const ethLabels = ['White', 'Native American', 'Hispanic', 'Two+', 'Black', 'Asian', 'Other'];
          const ethColors = [ethnicityColors.white, ethnicityColors.nativeAmerican, ethnicityColors.hispanic, ethnicityColors.twoOrMore, ethnicityColors.black, ethnicityColors.asian, ethnicityColors.other];
          ethKeys.forEach((key, idx) => {
            series.push({ label: ethLabels[idx], data: ethnicityByYear[key], color: ethColors[idx] });
          });
          return { labels: ethYears, series, type: 'timeseries' };
        }

        return { labels, series, type: 'timeseries' };
      }

      // Render a simplified chart for comparison panels - RESPONSIVE zoom-to-fit
      function renderPanelChart(containerId, chartData, chartType) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const { labels, series } = chartData;
        if (!series.length) {
          container.innerHTML = '<div style="color: #999; font-size: 14px; text-align: center;">Select options above</div>';
          return;
        }

        // Use 16:9 aspect ratio for better screen fit, viewBox coordinates
        const width = 800, height = 450;
        const padding = { top: 30, right: 40, bottom: 60, left: 70 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        const allValues = series.flatMap(s => s.data);
        const maxVal = Math.ceil(Math.max(...allValues) * 1.1);
        const minVal = 0;
        const tickStep = Math.ceil((maxVal - minVal) / 4 / 100) * 100 || 100;
        const niceMax = Math.ceil(maxVal / tickStep) * tickStep;

        const xStep = chartWidth / (labels.length - 1 || 1);
        const scaleY = (val) => padding.top + chartHeight - ((val - minVal) / (niceMax - minVal)) * chartHeight;

        // SVG with viewBox for responsive scaling - fills container while preserving aspect ratio
        let svg = `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="width:100%;height:100%;display:block;">`;

        // Grid
        svg += '<g class="chart-grid">';
        for (let i = 0; i <= 4; i++) {
          const y = padding.top + (chartHeight / 4) * i;
          svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#e5e7eb" stroke-dasharray="3,3"/>`;
        }
        svg += '</g>';

        // Y-axis
        svg += '<g class="chart-y-axis">';
        for (let i = 0; i <= 4; i++) {
          const value = niceMax - ((niceMax - minVal) / 4) * i;
          const y = padding.top + (chartHeight / 4) * i;
          svg += `<text x="${padding.left - 12}" y="${y + 5}" text-anchor="end" font-size="14" fill="#6b7280" font-weight="500">${Math.round(value).toLocaleString()}</text>`;
        }
        svg += '</g>';

        // X-axis
        svg += '<g class="chart-x-axis">';
        labels.forEach((label, i) => {
          const x = padding.left + i * xStep;
          svg += `<text x="${x}" y="${height - 25}" text-anchor="middle" font-size="13" fill="#6b7280" font-weight="500">${label}</text>`;
        });
        svg += '</g>';

        // Draw series
        if (chartType === 'bar') {
          const barWidth = (xStep * 0.7) / series.length;
          series.forEach((s, seriesIdx) => {
            const barOffset = seriesIdx * barWidth - (series.length * barWidth / 2) + barWidth / 2;
            s.data.forEach((val, i) => {
              const x = padding.left + i * xStep + barOffset - barWidth / 2;
              const yTop = scaleY(val);
              const barHeight = padding.top + chartHeight - yTop;
              svg += `<rect x="${x}" y="${yTop}" width="${barWidth}" height="${barHeight}" fill="${s.color}" rx="4"/>`;
            });
          });
        } else {
          // Line/Area chart
          series.forEach(s => {
            const points = s.data.map((val, i) => `${padding.left + i * xStep},${scaleY(val)}`);
            if (chartType === 'area') {
              const areaPath = `M${points.join(' L')} L${padding.left + (labels.length - 1) * xStep},${padding.top + chartHeight} L${padding.left},${padding.top + chartHeight} Z`;
              svg += `<path d="${areaPath}" fill="${s.color}" opacity="0.15"/>`;
            }
            svg += `<path d="M${points.join(' L')}" fill="none" stroke="${s.color}" stroke-width="3"/>`;
            s.data.forEach((val, i) => {
              svg += `<circle cx="${padding.left + i * xStep}" cy="${scaleY(val)}" r="5" fill="${s.color}"/>`;
            });
          });
        }

        // Legend - centered at bottom
        const legendY = height - 10;
        const legendItems = series.slice(0, 7);
        const legendWidth = legendItems.reduce((acc, s) => acc + s.label.length * 9 + 35, 0);
        let legendX = (width - legendWidth) / 2;
        svg += `<g>`;
        legendItems.forEach(s => {
          svg += `<circle cx="${legendX}" cy="${legendY}" r="6" fill="${s.color}"/>`;
          svg += `<text x="${legendX + 12}" y="${legendY + 4}" font-size="13" fill="#374151" font-weight="500">${s.label}</text>`;
          legendX += s.label.length * 9 + 35;
        });
        svg += '</g>';

        svg += '</svg>';
        container.innerHTML = svg;
      }

      // Render single comparison panel
      function renderComparisonPanel(panelNum) {
        try {
          const sourceSelect = document.querySelector(`.panel-source[data-panel="${panelNum}"]`);
          const rowsSelect = document.querySelector(`.panel-rows[data-panel="${panelNum}"]`);
          const colsSelect = document.querySelector(`.panel-cols[data-panel="${panelNum}"]`);
          const chartSelect = document.querySelector(`.panel-chart[data-panel="${panelNum}"]`);
          const chartContainer = document.getElementById(`panelChart${panelNum}`);

          if (!sourceSelect) {
            if (chartContainer) chartContainer.innerHTML = '<div style="color:red;padding:20px;">Panel select not found</div>';
            return;
          }

          const source = sourceSelect.value;
          const rows = rowsSelect.value;
          const cols = colsSelect.value;
          const chartType = chartSelect.value;

          const chartData = buildPanelChartData(source, rows, cols, chartType);
          renderPanelChart(`panelChart${panelNum}`, chartData, chartType);
        } catch (err) {
          const chartContainer = document.getElementById(`panelChart${panelNum}`);
          if (chartContainer) chartContainer.innerHTML = '<div style="color:red;padding:20px;">Error: ' + err.message + '</div>';
        }
      }

      // Render all visible comparison panels
      function renderAllComparisonPanels() {
        try {
          const panelClass = Array.from(explorerSection.classList).find(c => c.startsWith('panels-'));
          const count = panelClass ? parseInt(panelClass.split('-')[1]) : 1;
          console.log('Rendering', count, 'comparison panels');

          for (let i = 1; i <= count; i++) {
            renderComparisonPanel(i);
          }
        } catch (err) {
          console.error('Error rendering comparison panels:', err);
        }
      }

      // ===== PRESET QUICK VIEWS =====
      const presetBtns = document.querySelectorAll('.preset-btn');
      const presets = {
        enrollment: {
          dataSource: 'enrollment',
          rows: { field: 'year', type: 'dimension', label: 'Year' },
          columns: { field: 'statusBreakdown', type: 'dimension', label: 'Enrollment Status' },
          values: { field: 'total', type: 'measure', label: 'Total Enrollment' },
          chartType: 'line'
        },
        diversity: {
          dataSource: 'enrollment',
          rows: { field: 'year', type: 'dimension', label: 'Year' },
          columns: { field: 'ethnicityBreakdown', type: 'dimension', label: 'Race/Ethnicity' },
          values: { field: 'total', type: 'measure', label: 'Total Enrollment' },
          chartType: 'line'
        },
        costs: {
          dataSource: 'expenses',
          rows: { field: 'year', type: 'dimension', label: 'Year' },
          columns: null,
          values: { field: 'inStateTuition', type: 'measure', label: 'In-State Tuition' },
          chartType: 'line'
        },
        admissions: {
          dataSource: 'admissions',
          rows: { field: 'year', type: 'dimension', label: 'Year' },
          columns: null,
          values: { field: 'totalApplied', type: 'measure', label: 'Applications' },
          chartType: 'line'
        }
      };

      presetBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const preset = presets[btn.dataset.preset];
          if (!preset) return;

          // Update state
          explorerState.dataSource = preset.dataSource;
          explorerState.rows = preset.rows;
          explorerState.columns = preset.columns;
          explorerState.values = preset.values;
          explorerState.chartType = preset.chartType;
          explorerState.filter = null;
          explorerState.filterValues = null;

          // Update UI
          document.getElementById('dataSourceSelect').value = preset.dataSource;
          zones.forEach(z => {
            const data = explorerState[z.key];
            updateDropZoneDisplay(z.content, data, z.key, z.placeholder);
          });
          chartTypeButtons.forEach(b => b.classList.remove('active'));
          document.querySelector(`[data-chart-type="${preset.chartType}"]`).classList.add('active');

          // Highlight active preset
          presetBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Update chart
          updateExplorerChart();
        });
      });

      // ===== EXECUTIVE INSIGHTS GENERATION =====
      const insightsPanel = document.getElementById('executiveInsights');
      const insightsList = document.getElementById('insightsList');

      function generateInsights(chartData) {
        if (!chartData || !chartData.series || chartData.series.length === 0) {
          insightsPanel.style.display = 'none';
          return;
        }

        const insights = [];
        const { labels, series, type } = chartData;

        series.forEach(s => {
          if (!s.data || s.data.length < 2) return;

          const data = s.data;
          const firstVal = data[0];
          const lastVal = data[data.length - 1];
          const maxVal = Math.max(...data);
          const minVal = Math.min(...data);
          const maxIdx = data.indexOf(maxVal);
          const minIdx = data.indexOf(minVal);

          // Calculate total change
          const totalChange = ((lastVal - firstVal) / firstVal * 100).toFixed(1);
          const changeClass = totalChange > 0 ? 'insight-positive' : totalChange < 0 ? 'insight-negative' : 'insight-neutral';
          const changeIcon = totalChange > 0 ? '' : totalChange < 0 ? '' : '';

          // Only generate insights for significant changes (>3%)
          if (Math.abs(totalChange) > 3) {
            insights.push({
              icon: changeIcon,
              text: `<span class="insight-highlight">${s.label}</span>: <span class="${changeClass}">${totalChange > 0 ? '+' : ''}${totalChange}%</span> change from ${labels[0]} to ${labels[labels.length - 1]}`
            });
          }

          // Peak detection
          if (maxIdx > 0 && maxIdx < data.length - 1) {
            insights.push({
              icon: '',
              text: `<span class="insight-highlight">${s.label}</span> peaked at <span class="insight-neutral">${maxVal.toLocaleString()}</span> in ${labels[maxIdx]}`
            });
          }

          // Significant YoY change (>10%)
          for (let i = 1; i < data.length; i++) {
            const yoyChange = ((data[i] - data[i-1]) / data[i-1] * 100);
            if (Math.abs(yoyChange) > 10) {
              const yoyClass = yoyChange > 0 ? 'insight-positive' : 'insight-negative';
              insights.push({
                icon: yoyChange > 0 ? '' : '',
                text: `<span class="insight-highlight">${s.label}</span>: <span class="${yoyClass}">${yoyChange > 0 ? '+' : ''}${yoyChange.toFixed(1)}%</span> YoY change in ${labels[i]}`
              });
              break; // Only show first significant YoY change
            }
          }
        });

        // Limit to top 4 insights
        const topInsights = insights.slice(0, 4);

        if (topInsights.length > 0) {
          insightsPanel.style.display = 'block';
          insightsList.innerHTML = topInsights.map(i => `
            <li class="executive-insights__item">
              <span class="insight-icon">${i.icon}</span>
              <span>${i.text}</span>
            </li>
          `).join('');
        } else {
          insightsPanel.style.display = 'none';
        }
      }

      // Export button - show professional report preview
      exportButton.addEventListener('click', () => {
        populateExportReport();
        exportModal.classList.add('active');
      });

      exportModalClose.addEventListener('click', () => {
        exportModal.classList.remove('active');
      });

      exportModal.addEventListener('click', (e) => {
        if (e.target === exportModal) {
          exportModal.classList.remove('active');
        }
      });

      // Populate export report with current state
      function populateExportReport() {
        const { rows, columns, values, filter, chartType } = explorerState;

        // Set date
        const now = new Date();
        document.getElementById('reportDate').textContent = `Generated: ${now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })} at ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;

        // Set title based on current selections
        const measureLabel = values ? values.label : 'Data';
        const dimensionLabel = rows ? rows.label : '';
        document.getElementById('reportTitle').textContent = `${measureLabel}${dimensionLabel ? ' by ' + dimensionLabel : ''} Report`;

        // Set chart type
        const chartTypeNames = { line: ' Line Chart', bar: ' Bar Chart', pie: ' Pie Chart' };
        document.getElementById('reportChartType').textContent = chartTypeNames[chartType] || 'Line Chart';

        // Set dimension
        const dimensionEl = document.getElementById('reportDimension');
        if (rows) {
          dimensionEl.innerHTML = `<span class="report-meta__badge report-meta__badge--dimension">${rows.label}</span>`;
          if (columns) {
            dimensionEl.innerHTML += ` <span class="report-meta__badge report-meta__badge--dimension">${columns.label}</span>`;
          }
        } else {
          dimensionEl.innerHTML = '<span class="report-meta__badge report-meta__badge--dimension">None selected</span>';
        }

        // Set measure
        const measureEl = document.getElementById('reportMeasure');
        if (values) {
          measureEl.innerHTML = `<span class="report-meta__badge report-meta__badge--measure">${values.label}</span>`;
        } else {
          measureEl.innerHTML = '<span class="report-meta__badge report-meta__badge--measure">None selected</span>';
        }

        // Set filters
        const filtersEl = document.getElementById('reportFilters');
        if (filter) {
          let filterDesc = filter.label + ': ';
          if (filter.yearRange) {
            filterDesc += `${filter.yearRange.from} - ${filter.yearRange.to}`;
          } else if (filter.selectedValues && filter.selectedValues.length > 0) {
            filterDesc += filter.selectedValues.join(', ');
          }
          filtersEl.innerHTML = `<span class="report-meta__badge report-meta__badge--filter">${filterDesc}</span>`;
        } else {
          filtersEl.innerHTML = '<span class="report-meta__badge report-meta__badge--filter">None applied</span>';
        }

        // Clone current chart into report
        const chartContainer = document.getElementById('reportChartContainer');
        const currentChart = document.getElementById('explorerChartContent');
        if (currentChart) {
          chartContainer.innerHTML = currentChart.innerHTML;
        } else {
          chartContainer.innerHTML = '<p style="color: var(--color-text-secondary);">No chart generated yet</p>';
        }

        // Generate granular data table
        generateReportDataTable();
      }

      // Generate the granular data table for the report
      function generateReportDataTable() {
        const { rows, columns, values, filter, chartType, filterValues } = explorerState;
        const tableHead = document.getElementById('reportTableHead');
        const tableBody = document.getElementById('reportTableBody');

        if (!rows || !values) {
          tableHead.innerHTML = '<th>No Data</th>';
          tableBody.innerHTML = '<tr><td>Select dimensions and measures to view data</td></tr>';
          return;
        }

        // Build headers - we'll update these after getting chart data
        let headers = [rows.label];

        // Get chart data first to determine proper headers
        const chartData = buildChartData(rows, columns, values, chartType, filter, filterValues);

        if (chartData && chartData.series && chartData.series.length > 1) {
          // Multiple series - use series labels as headers
          chartData.series.forEach(s => headers.push(s.label));
        } else if (chartData && chartData.series && chartData.series.length === 1) {
          headers.push(chartData.series[0].label || values.label);
        } else {
          headers.push(values.label);
        }
        tableHead.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

        // Build data rows from chartData object (reusing chartData from above)
        let dataRows = '';

        if (chartData && chartData.labels && chartData.labels.length > 0) {
          const { labels, series } = chartData;

          // Generate rows based on chart data structure
          labels.forEach((label, i) => {
            dataRows += `<tr><td>${label}</td>`;
            if (series.length > 1) {
              // Multiple series (e.g., Male/Female or Full-Time/Part-Time)
              series.forEach(s => {
                dataRows += `<td>${s.data[i]?.toLocaleString() || ''}</td>`;
              });
            } else if (series.length === 1) {
              // Single series
              dataRows += `<td>${series[0].data[i]?.toLocaleString() || ''}</td>`;
            }
            dataRows += '</tr>';
          });
        } else {
          dataRows = '<tr><td colspan="' + headers.length + '">No data available</td></tr>';
        }

        tableBody.innerHTML = dataRows;
      }

      // Set default state: Year + Enrollment Status breakdown on line chart
      function setDefaultState() {
        explorerState.rows = { field: 'year', type: 'dimension', label: 'Year' };
        explorerState.columns = { field: 'statusBreakdown', type: 'dimension', label: 'Enrollment Status' };
        explorerState.values = { field: 'total', type: 'measure', label: 'Total Enrollment' };
        explorerState.chartType = 'line';

        // Update drop zone displays
        updateDropZoneDisplay(dropRowsContent, explorerState.rows, 'rows', 'Drop a dimension here');
        updateDropZoneDisplay(dropColsContent, explorerState.columns, 'columns', 'Optional: group/color by');
        updateDropZoneDisplay(dropValuesContent, explorerState.values, 'values', 'Drop a measure here');

        // Set line chart as active
        chartTypeButtons.forEach(b => b.classList.remove('active'));
        document.querySelector('[data-chart-type="line"]').classList.add('active');

        updateExplorerChart();
      }

      // Initialize with default state
      setDefaultState();

      // Main chart update function
      function updateExplorerChart() {
        const { rows, columns, values } = explorerState;

        // Need at least rows and values
        if (!rows || !values) {
          let hints = [];
          if (!rows) hints.push('Drop a dimension on <strong>Rows</strong>');
          if (!values) hints.push('Drop a measure on <strong>Values</strong>');
          chartContent.innerHTML = `
            <div class="chart-preview__empty">
              <div class="chart-preview__empty-icon"></div>
              <div class="chart-preview__empty-text">Build your visualization</div>
              <div class="chart-preview__empty-hint">${hints.join('<br>')}</div>
            </div>`;
          chartTitle.textContent = 'Chart Preview';
          return;
        }

        // Get chart data based on dimension combinations (with filter applied)
        const chartData = buildChartData(rows, columns, values, explorerState.chartType, explorerState.filter, explorerState.filterValues);

        // Build title based on what we're actually showing
        let title = '';
        if (chartData.type === 'categorical') {
          title = chartData.series[0]?.label || 'Distribution';
          if (rows.field !== 'year') title = `${rows.label} Distribution`;
        } else {
          title = values.label;
          if (columns) title += ` by ${columns.label}`;
          title += ` over ${rows.label}`;
        }
        chartTitle.textContent = title;

        // Render based on chart type
        if (explorerState.chartType === 'donut') {
          renderDonut(chartData);
        } else {
          renderChart(chartData);
        }

        // Generate executive insights
        generateInsights(chartData);
      }

      // Build data structure for charts
      function buildChartData(rows, columns, values, chartType, filter, filterValues) {
        // Handle CDS Admissions data
        if (explorerState.dataSource === 'admissions' && rows.field === 'year') {
          const cdsYears = cdsData.years.map(y => y.split('-')[0]);
          const metric = values.field;
          const data = cdsData.admissions[metric];

          if (data) {
            // Format values (percentages stay as-is, counts get formatted)
            const isPercentage = metric.includes('Rate');
            return {
              labels: cdsYears,
              series: [{
                label: values.label,
                data: data,
                color: isPercentage ? '#10B981' : '#2563EB'
              }],
              type: 'timeseries',
              isPercentage: isPercentage
            };
          }
        }

        // Handle CDS Expenses data
        if (explorerState.dataSource === 'expenses' && rows.field === 'year') {
          const cdsYears = cdsData.years.map(y => y.split('-')[0]);
          const metric = values.field;
          const data = cdsData.expenses[metric];

          if (data) {
            return {
              labels: cdsYears,
              series: [{
                label: values.label,
                data: data,
                color: metric === 'inStateTuition' ? '#2563EB' : metric === 'outOfStateTuition' ? '#DC2626' : '#FFB81C'
              }],
              type: 'timeseries',
              isCurrency: true
            };
          }
        }

        // Original enrollment data handling
        const rowDim = dimensionData[rows.field];
        const colDim = columns ? dimensionData[columns.field] : null;

        // Apply year filter helper
        function getYearIndices() {
          if (filter && filter.field === 'year' && filterValues) {
            const indices = [];
            for (let i = filterValues.minIdx; i <= filterValues.maxIdx; i++) {
              indices.push(i);
            }
            return indices;
          }
          return enrollmentData.years.map((_, i) => i); // All years
        }

        // Apply gender filter helper
        function filterGender(genderKey) {
          if (filter && filter.field === 'genderBreakdown' && filterValues) {
            return filterValues.includes(genderKey);
          }
          return true;
        }

        // Apply status filter helper
        function filterStatus(statusKey) {
          if (filter && filter.field === 'statusBreakdown' && filterValues) {
            return filterValues.includes(statusKey);
          }
          return true;
        }

        // Apply ethnicity filter helper
        function filterEthnicity(index) {
          if (filter && filter.field === 'ethnicityBreakdown' && filterValues) {
            return filterValues.includes(index);
          }
          return true;
        }

        const yearIndices = getYearIndices();

        // Case 1: Year on rows (time series)
        if (rows.field === 'year') {
          const labels = yearIndices.map(i => rowDim.labels[i]);
          let series = [];

          // For donut chart with year, use the Group By dimension or show gender breakdown
          if (chartType === 'donut') {
            const latestIdx = yearIndices[yearIndices.length - 1]; // Use filtered latest year
            if (columns && columns.field === 'genderBreakdown') {
              const genders = [
                { key: 'male', label: 'Male', data: enrollmentData.male[latestIdx], color: colors.gender.male },
                { key: 'female', label: 'Female', data: enrollmentData.female[latestIdx], color: colors.gender.female }
              ].filter(g => filterGender(g.key));
              return {
                labels: genders.map(g => g.label),
                series: [{
                  label: 'Gender (Latest Year)',
                  data: genders.map(g => g.data),
                  color: genders.map(g => g.color)
                }],
                type: 'categorical'
              };
            } else if (columns && columns.field === 'statusBreakdown') {
              const statuses = [
                { key: 'fullTime', label: 'Full-Time', data: enrollmentData.fullTime[latestIdx], color: colors.status.fullTime },
                { key: 'partTime', label: 'Part-Time', data: enrollmentData.partTime[latestIdx], color: colors.status.partTime }
              ].filter(s => filterStatus(s.key));
              return {
                labels: statuses.map(s => s.label),
                series: [{
                  label: 'Status (Latest Year)',
                  data: statuses.map(s => s.data),
                  color: statuses.map(s => s.color)
                }],
                type: 'categorical'
              };
            } else if (columns && columns.field === 'ethnicityBreakdown') {
              // Ethnicity for donut (7 groups, latest year from ethnicityByYear)
              const ethGroups = [
                { key: 'white', label: 'White', color: ethnicityColors.white },
                { key: 'nativeAmerican', label: 'Native American', color: ethnicityColors.nativeAmerican },
                { key: 'hispanic', label: 'Hispanic/Latino', color: ethnicityColors.hispanic },
                { key: 'twoOrMore', label: 'Two or More', color: ethnicityColors.twoOrMore },
                { key: 'black', label: 'Black', color: ethnicityColors.black },
                { key: 'asian', label: 'Asian', color: ethnicityColors.asian },
                { key: 'other', label: 'Other', color: ethnicityColors.other }
              ];
              const latestEthIdx = ethnicityByYear.years.length - 1; // Latest year in ethnicityByYear
              const filteredEth = ethGroups.filter((_, i) => filterEthnicity(i));
              return {
                labels: filteredEth.map(e => e.label),
                series: [{
                  label: 'Ethnicity (Latest Year)',
                  data: filteredEth.map(e => ethnicityByYear[e.key][latestEthIdx]),
                  color: filteredEth.map(e => e.color)
                }],
                type: 'categorical'
              };
            } else {
              // No group by - show gender breakdown by default for donut (filtered)
              const genders = [
                { key: 'male', label: 'Male', data: enrollmentData.male[latestIdx], color: colors.gender.male },
                { key: 'female', label: 'Female', data: enrollmentData.female[latestIdx], color: colors.gender.female }
              ].filter(g => filterGender(g.key));
              return {
                labels: genders.map(g => g.label),
                series: [{
                  label: 'Gender (Latest Year)',
                  data: genders.map(g => g.data),
                  color: genders.map(g => g.color)
                }],
                type: 'categorical'
              };
            }
          }

          if (!columns) {
            // Single series - total enrollment (filtered by year)
            series.push({
              label: 'Total',
              data: yearIndices.map(i => enrollmentData.total[i]),
              color: colors.primary[0]
            });
          } else if (columns.field === 'genderBreakdown') {
            // Gender breakdown over time (filtered by year and optionally gender)
            if (filterGender('male')) {
              series.push({ label: 'Male', data: yearIndices.map(i => enrollmentData.male[i]), color: colors.gender.male });
            }
            if (filterGender('female')) {
              series.push({ label: 'Female', data: yearIndices.map(i => enrollmentData.female[i]), color: colors.gender.female });
            }
          } else if (columns.field === 'statusBreakdown') {
            // Status breakdown over time (filtered by year and optionally status)
            if (filterStatus('fullTime')) {
              series.push({ label: 'Full-Time', data: yearIndices.map(i => enrollmentData.fullTime[i]), color: colors.status.fullTime });
            }
            if (filterStatus('partTime')) {
              series.push({ label: 'Part-Time', data: yearIndices.map(i => enrollmentData.partTime[i]), color: colors.status.partTime });
            }
          } else if (columns.field === 'ethnicityBreakdown') {
            // Ethnicity breakdown over time using ethnicityByYear data
            // Map enrollmentData year indices to ethnicityByYear indices (+1 offset since ethnicityByYear starts at 2014-15)
            const ethGroups = [
              { key: 'white', label: 'White', color: ethnicityColors.white },
              { key: 'nativeAmerican', label: 'Native American', color: ethnicityColors.nativeAmerican },
              { key: 'hispanic', label: 'Hispanic/Latino', color: ethnicityColors.hispanic },
              { key: 'twoOrMore', label: 'Two or More', color: ethnicityColors.twoOrMore },
              { key: 'black', label: 'Black', color: ethnicityColors.black },
              { key: 'asian', label: 'Asian', color: ethnicityColors.asian },
              { key: 'other', label: 'Other', color: ethnicityColors.other }
            ];
            ethGroups.forEach((eth, idx) => {
              if (filterEthnicity(idx)) {
                series.push({
                  label: eth.label,
                  data: yearIndices.map(i => ethnicityByYear[eth.key][i + 1]), // +1 offset for ethnicityByYear
                  color: eth.color
                });
              }
            });
          }
          return { labels, series, type: 'timeseries' };
        }

        // Case 2: Gender on rows (filtered)
        if (rows.field === 'genderBreakdown') {
          const latestIdx = yearIndices[yearIndices.length - 1]; // Use filtered latest year
          const genders = [
            { key: 'male', label: 'Male', data: enrollmentData.male[latestIdx], color: colors.gender.male },
            { key: 'female', label: 'Female', data: enrollmentData.female[latestIdx], color: colors.gender.female }
          ].filter(g => filterGender(g.key));

          return {
            labels: genders.map(g => g.label),
            series: [{
              label: 'Count',
              data: genders.map(g => g.data),
              color: genders.map(g => g.color)
            }],
            type: 'categorical'
          };
        }

        // Case 3: Status on rows (filtered)
        if (rows.field === 'statusBreakdown') {
          const latestIdx = yearIndices[yearIndices.length - 1]; // Use filtered latest year
          const statuses = [
            { key: 'fullTime', label: 'Full-Time', data: enrollmentData.fullTime[latestIdx], color: colors.status.fullTime },
            { key: 'partTime', label: 'Part-Time', data: enrollmentData.partTime[latestIdx], color: colors.status.partTime }
          ].filter(s => filterStatus(s.key));

          return {
            labels: statuses.map(s => s.label),
            series: [{
              label: 'Count',
              data: statuses.map(s => s.data),
              color: statuses.map(s => s.color)
            }],
            type: 'categorical'
          };
        }

        // Case 4: Ethnicity on rows (filtered) - show latest year
        if (rows.field === 'ethnicityBreakdown') {
          const ethGroups = [
            { key: 'white', label: 'White', color: ethnicityColors.white },
            { key: 'nativeAmerican', label: 'Native American', color: ethnicityColors.nativeAmerican },
            { key: 'hispanic', label: 'Hispanic/Latino', color: ethnicityColors.hispanic },
            { key: 'twoOrMore', label: 'Two or More', color: ethnicityColors.twoOrMore },
            { key: 'black', label: 'Black', color: ethnicityColors.black },
            { key: 'asian', label: 'Asian', color: ethnicityColors.asian },
            { key: 'other', label: 'Other', color: ethnicityColors.other }
          ];
          const latestEthIdx = ethnicityByYear.years.length - 1;
          const filteredEth = ethGroups.filter((_, i) => filterEthnicity(i));
          return {
            labels: filteredEth.map(e => e.label),
            series: [{
              label: 'Count',
              data: filteredEth.map(e => ethnicityByYear[e.key][latestEthIdx]),
              color: filteredEth.map(e => e.color)
            }],
            type: 'categorical'
          };
        }

        return { labels: [], series: [], type: 'unknown' };
      }

      // Render line/bar/area charts
      function renderChart(chartData) {
        const { labels, series, type } = chartData;
        const width = 700, height = 320;
        const padding = { top: 30, right: 40, bottom: 60, left: 70 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Calculate scales
        const allValues = series.flatMap(s => s.data);
        const maxVal = Math.ceil(Math.max(...allValues) * 1.1);
        const minVal = type === 'categorical' ? 0 : Math.floor(Math.min(...allValues) * 0.9);

        // Calculate nice tick values FIRST
        const tickCount = 5;
        const range = maxVal - minVal;
        const tickStep = Math.ceil(range / tickCount / 100) * 100 || 100;
        const niceMax = Math.ceil(maxVal / tickStep) * tickStep;
        const niceMin = type === 'categorical' ? 0 : Math.floor(minVal / tickStep) * tickStep;

        // Use nice values for scaling to prevent axis overlap
        const xStep = type === 'categorical'
          ? chartWidth / labels.length
          : chartWidth / (labels.length - 1);

        const scaleY = (val) => {
          const ratio = (val - niceMin) / (niceMax - niceMin);
          return padding.top + chartHeight - (ratio * chartHeight);
        };

        let svg = `<svg class="explorer-chart-svg" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">`;

        // Grid lines
        svg += '<g class="chart-grid">';
        for (let i = 0; i <= tickCount; i++) {
          const y = padding.top + (chartHeight / tickCount) * i;
          svg += `<line class="chart-grid-line" x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}"/>`;
        }
        svg += '</g>';

        // Y-axis labels
        svg += '<g class="chart-y-axis">';
        for (let i = 0; i <= tickCount; i++) {
          const value = niceMax - ((niceMax - niceMin) / tickCount) * i;
          const y = padding.top + (chartHeight / tickCount) * i;
          svg += `<text class="chart-axis-label" x="${padding.left - 10}" y="${y + 4}" text-anchor="end">${Math.round(value).toLocaleString()}</text>`;
        }
        svg += '</g>';

        // X-axis labels
        svg += '<g class="chart-x-axis">';
        labels.forEach((label, i) => {
          const x = type === 'categorical'
            ? padding.left + i * xStep + xStep / 2
            : padding.left + i * xStep;
          svg += `<text class="chart-axis-label" x="${x}" y="${height - 25}" text-anchor="middle" style="font-size: 10px;">${label}</text>`;
        });
        svg += '</g>';

        // Draw series
        series.forEach((s, seriesIdx) => {
          const seriesColors = Array.isArray(s.color) ? s.color : [s.color];

          const baseline = padding.top + chartHeight; // Y position for value 0

          if (explorerState.chartType === 'bar' || type === 'categorical') {
            // Bar chart
            const barWidth = (xStep * 0.7) / series.length;
            const barOffset = seriesIdx * barWidth - (series.length * barWidth / 2) + barWidth / 2;

            s.data.forEach((val, i) => {
              const x = type === 'categorical'
                ? padding.left + i * xStep + xStep / 2 + barOffset - barWidth / 2
                : padding.left + i * xStep + barOffset - barWidth / 2;
              const yTop = scaleY(val);
              const barHeight = baseline - yTop;
              const color = seriesColors[i % seriesColors.length] || seriesColors[0];
              svg += `<rect x="${x}" y="${yTop}" width="${barWidth}" height="${barHeight}" fill="${color}" rx="3"/>`;
            });
          } else if (explorerState.chartType === 'area') {
            // Area chart
            const points = s.data.map((val, i) => `${padding.left + i * xStep},${scaleY(val)}`);
            const areaPath = `M${points.join(' L')} L${padding.left + (labels.length - 1) * xStep},${baseline} L${padding.left},${baseline} Z`;
            svg += `<path d="${areaPath}" fill="${seriesColors[0]}" opacity="0.2"/>`;
            svg += `<path d="M${points.join(' L')}" fill="none" stroke="${seriesColors[0]}" stroke-width="3"/>`;
            s.data.forEach((val, i) => {
              svg += `<circle cx="${padding.left + i * xStep}" cy="${scaleY(val)}" r="5" fill="white" stroke="${seriesColors[0]}" stroke-width="3"/>`;
            });
          } else {
            // Line chart
            const points = s.data.map((val, i) => `${padding.left + i * xStep},${scaleY(val)}`);
            svg += `<path d="M${points.join(' L')}" fill="none" stroke="${seriesColors[0]}" stroke-width="3" stroke-linecap="round"/>`;
            s.data.forEach((val, i) => {
              svg += `<circle cx="${padding.left + i * xStep}" cy="${scaleY(val)}" r="5" fill="white" stroke="${seriesColors[0]}" stroke-width="3"/>`;
            });
          }
        });

        svg += '</svg>';

        // Legend (only for multi-series)
        let legend = '';
        if (series.length > 1 || (series[0] && Array.isArray(series[0].color))) {
          legend = '<div class="chart-legend" style="margin-top: var(--space-3); justify-content: center; flex-wrap: wrap;">';
          if (series.length > 1) {
            series.forEach(s => {
              const color = Array.isArray(s.color) ? s.color[0] : s.color;
              legend += `<div class="legend-item"><span class="legend-dot" style="background: ${color};"></span><span>${s.label}</span></div>`;
            });
          } else if (type === 'categorical') {
            labels.forEach((label, i) => {
              const color = series[0].color[i];
              legend += `<div class="legend-item"><span class="legend-dot" style="background: ${color};"></span><span>${label}</span></div>`;
            });
          }
          legend += '</div>';
        }

        chartContent.innerHTML = svg + legend;
      }

      // Render donut chart
      function renderDonut(chartData) {
        const { labels, series } = chartData;
        const data = labels.map((label, i) => ({
          label,
          value: series[0].data[i],
          color: Array.isArray(series[0].color) ? series[0].color[i] : colors.primary[i]
        }));

        const total = data.reduce((sum, d) => sum + d.value, 0);
        const centerX = 120, centerY = 120, radius = 90, innerRadius = 55;

        let svg = `<svg viewBox="0 0 240 240" style="width: 240px; height: 240px;">`;
        let currentAngle = -90;

        data.forEach(item => {
          const angle = (item.value / total) * 360;
          const path = describeArc(centerX, centerY, radius, innerRadius, currentAngle, currentAngle + angle);
          svg += `<path d="${path}" fill="${item.color}" class="donut-segment"/>`;
          currentAngle += angle;
        });

        svg += `<text x="${centerX}" y="${centerY}" text-anchor="middle" dominant-baseline="middle" class="donut-center-text">${total.toLocaleString()}</text>`;
        svg += `<text x="${centerX}" y="${centerY + 18}" text-anchor="middle" class="donut-center-label">Total</text>`;
        svg += '</svg>';

        let legend = '<div class="demographics-legend" style="display: flex; gap: var(--space-2); flex-wrap: wrap; justify-content: center; margin-top: var(--space-3);">';
        data.forEach(item => {
          const percent = ((item.value / total) * 100).toFixed(1);
          legend += `
            <div class="demo-legend-item" style="background: var(--color-bg-light); padding: 0.5rem 0.75rem; border-radius: var(--radius-sm);">
              <div class="demo-legend-left">
                <div class="demo-legend-color" style="background: ${item.color}; width: 12px; height: 12px;"></div>
                <span class="demo-legend-label" style="font-size: 12px;">${item.label}</span>
              </div>
              <span class="demo-legend-value" style="margin-left: var(--space-1); font-size: 12px;">${item.value.toLocaleString()} (${percent}%)</span>
            </div>`;
        });
        legend += '</div>';

        chartContent.innerHTML = `<div style="display: flex; flex-direction: column; align-items: center;">${svg}${legend}</div>`;
      }
    }

    // Theme toggle
    function initTheme() {
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = themeToggle.querySelector('.theme-toggle__icon');
      const root = document.documentElement;

      function getPreferredTheme() {
        const savedTheme = localStorage.getItem('horizon-theme');
        if (savedTheme) return savedTheme;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function setTheme(theme) {
        root.setAttribute('data-theme', theme);
        localStorage.setItem('horizon-theme', theme);
        themeIcon.textContent = theme === 'dark' ? '' : '';
      }

      setTheme(getPreferredTheme());

      themeToggle.addEventListener('click', () => {
        const currentTheme = root.getAttribute('data-theme');
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
      });
    }

    // Season toggle
    function initSeasonToggle() {
      const seasonToggle = document.getElementById('seasonToggle');
      if (!seasonToggle) return;

      const seasonIcon = seasonToggle.querySelector('.season-toggle__icon');
      const root = document.documentElement;

      function getPreferredSeason() {
        const savedSeason = localStorage.getItem('horizon-season');
        return savedSeason || 'winter';
      }

      function setSeason(season) {
        root.setAttribute('data-season', season);
        localStorage.setItem('horizon-season', season);
        if (seasonIcon) {
          seasonIcon.textContent = season === 'fall' ? '' : '';
        }
      }

      setSeason(getPreferredSeason());

      seasonToggle.addEventListener('click', () => {
        const currentSeason = root.getAttribute('data-season');
        setSeason(currentSeason === 'fall' ? 'winter' : 'fall');
      });
    }

    // Mobile hamburger menu
    function initMobileNav() {
      const hamburger = document.querySelector('.nav__hamburger');
      const mobileNav = document.querySelector('.mobile-nav');
      const backdrop = document.querySelector('.mobile-nav__backdrop');
      const closeBtn = document.querySelector('.mobile-nav__close-btn');

      if (!hamburger || !mobileNav) return;

      function toggleMobileNav() {
        const isActive = mobileNav.classList.contains('active');
        hamburger.classList.toggle('active', !isActive);
        mobileNav.classList.toggle('active', !isActive);
        if (backdrop) backdrop.classList.toggle('active', !isActive);
        document.body.style.overflow = isActive ? '' : 'hidden';
      }

      function closeMobileNav() {
        hamburger.classList.remove('active');
        mobileNav.classList.remove('active');
        if (backdrop) backdrop.classList.remove('active');
        document.body.style.overflow = '';
      }

      hamburger.addEventListener('click', toggleMobileNav);
      if (closeBtn) closeBtn.addEventListener('click', closeMobileNav);
      if (backdrop) backdrop.addEventListener('click', closeMobileNav);
      mobileNav.querySelectorAll('.mobile-nav__link, .mobile-nav__cta').forEach(link => {
        link.addEventListener('click', closeMobileNav);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileNav.classList.contains('active')) closeMobileNav();
      });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);

    // ===== VISUAL EFFECTS INITIALIZATION =====

    // Generate Starfield
    function initStars() {
      const container = document.querySelector('.data-stars');
      if (!container) return;

      // Regular stars
      for (let i = 0; i < 60; i++) {
        const star = document.createElement('div');
        star.className = i % 8 === 0 ? 'star star--large' : 'star';
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.setProperty('--duration', `${2 + Math.random() * 3}s`);
        star.style.setProperty('--delay', `${Math.random() * 3}s`);
        container.appendChild(star);
      }

      // Shooting stars
      for (let i = 0; i < 3; i++) {
        const shootingStar = document.createElement('div');
        shootingStar.className = 'shooting-star';
        shootingStar.style.left = `${10 + Math.random() * 60}%`;
        shootingStar.style.top = `${5 + Math.random() * 30}%`;
        shootingStar.style.setProperty('--delay', `${2 + i * 8}s`);
        container.appendChild(shootingStar);
      }
    }

    // Generate Snow
    function initSnow() {
      const container = document.querySelector('.data-snow');
      if (!container) return;

      for (let i = 0; i < 30; i++) {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.style.left = `${Math.random() * 100}%`;
        snowflake.style.animationDuration = `${15 + Math.random() * 10}s`;
        snowflake.style.animationDelay = `${Math.random() * 15}s`;
        snowflake.style.opacity = 0.3 + Math.random() * 0.4;
        container.appendChild(snowflake);
      }
    }

    // Initialize visual effects
    initStars();
    initSnow();

  </script>

  <!-- Export Report Preview Modal -->
  <div class="export-modal" id="exportModal">
    <div class="export-modal__content">
      <!-- Report Header -->
      <div class="report-header">
        <div class="report-header__left">
          <div class="report-header__logo">HORIZON ANALYTICS</div>
          <h2 class="report-header__title" id="reportTitle">Enrollment Trends Report</h2>
          <p class="report-header__subtitle">Fort Lewis College  Institutional Research</p>
        </div>
        <div class="report-header__right">
          <p class="report-header__date" id="reportDate"></p>
        </div>
        <button class="report-header__close" id="exportModalClose" aria-label="Close"></button>
      </div>

      <!-- Report Body -->
      <div class="report-body">
        <!-- Demo Banner -->
        <div class="report-demo-banner">
          <span class="report-demo-banner__icon"></span>
          <div class="report-demo-banner__text">
            <div class="report-demo-banner__title">Demonstration Preview Only</div>
            <div class="report-demo-banner__desc">This is a conceptual demonstration utilizing unvalidated data from public sources. Content serves only to populate the prototype and may be legacy or non-current. Export functionality is disabled.</div>
          </div>
        </div>

        <!-- Report Metadata -->
        <div class="report-meta">
          <div class="report-meta__item">
            <span class="report-meta__label">Chart Type</span>
            <span class="report-meta__value" id="reportChartType">Line Chart</span>
          </div>
          <div class="report-meta__item">
            <span class="report-meta__label">Dimension</span>
            <span class="report-meta__value" id="reportDimension">
              <span class="report-meta__badge report-meta__badge--dimension">None selected</span>
            </span>
          </div>
          <div class="report-meta__item">
            <span class="report-meta__label">Measure</span>
            <span class="report-meta__value" id="reportMeasure">
              <span class="report-meta__badge report-meta__badge--measure">None selected</span>
            </span>
          </div>
          <div class="report-meta__item">
            <span class="report-meta__label">Active Filters</span>
            <span class="report-meta__value" id="reportFilters">
              <span class="report-meta__badge report-meta__badge--filter">None</span>
            </span>
          </div>
        </div>

        <!-- Chart Preview -->
        <div class="report-chart">
          <div class="report-chart__title"> Visualization Preview</div>
          <div class="report-chart__container" id="reportChartContainer">
            <!-- Chart will be cloned here -->
          </div>
        </div>

        <!-- Data Table -->
        <div class="report-table">
          <div class="report-table__title"> Granular Data</div>
          <div class="report-table__container">
            <table id="reportDataTable">
              <thead>
                <tr id="reportTableHead"></tr>
              </thead>
              <tbody id="reportTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Report Footer -->
      <div class="report-footer">
        <div class="report-footer__info">
          Generated by HORIZON Analytics  Powered by Claude AI
        </div>
        <div class="report-footer__actions">
          <button class="report-footer__btn report-footer__btn--secondary" onclick="document.getElementById('exportModal').classList.remove('active')">Close Preview</button>
          <button class="report-footer__btn report-footer__btn--primary" title="Export disabled in demo">
             Export PDF (Demo)
          </button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
